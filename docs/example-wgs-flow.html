<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 27 An example full workflow from sequences to variants | Practical Computing and Bioinformatics for Conservation and Evolutionary Genomics</title>
  <meta name="description" content="A book example for a Chapman &amp; Hall book." />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 27 An example full workflow from sequences to variants | Practical Computing and Bioinformatics for Conservation and Evolutionary Genomics" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="A book example for a Chapman &amp; Hall book." />
  <meta name="github-repo" content="yihui/bookdown-crc" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 27 An example full workflow from sequences to variants | Practical Computing and Bioinformatics for Conservation and Evolutionary Genomics" />
  
  <meta name="twitter:description" content="A book example for a Chapman &amp; Hall book." />
  

<meta name="author" content="Eric C. Anderson" />


<meta name="date" content="2022-04-14" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="whole-genome-alignment-strategies.html"/>
<link rel="next" href="bioinformatic-analysis-on-variant-data.html"/>
<script src="libs/header-attrs/header-attrs.js"></script>
<script src="libs/jquery/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook/css/style.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">ECA's Bioinformatics Handbook</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="erics-notes-of-what-he-might-do.html"><a href="erics-notes-of-what-he-might-do.html"><i class="fa fa-check"></i><b>2</b> Eric’s Notes of what he might do</a>
<ul>
<li class="chapter" data-level="2.1" data-path="erics-notes-of-what-he-might-do.html"><a href="erics-notes-of-what-he-might-do.html#table-of-topics"><i class="fa fa-check"></i><b>2.1</b> Table of topics</a></li>
</ul></li>
<li class="part"><span><b>I Part I: Essential Computing Skills</b></span></li>
<li class="chapter" data-level="3" data-path="overview-of-essential-computing-skills.html"><a href="overview-of-essential-computing-skills.html"><i class="fa fa-check"></i><b>3</b> Overview of Essential Computing Skills</a></li>
<li class="chapter" data-level="4" data-path="essential-unixlinux-terminal-knowledge.html"><a href="essential-unixlinux-terminal-knowledge.html"><i class="fa fa-check"></i><b>4</b> Essential Unix/Linux Terminal Knowledge</a>
<ul>
<li class="chapter" data-level="4.1" data-path="essential-unixlinux-terminal-knowledge.html"><a href="essential-unixlinux-terminal-knowledge.html#getting-a-bash-shell-on-your-system"><i class="fa fa-check"></i><b>4.1</b> Getting a bash shell on your system</a></li>
<li class="chapter" data-level="4.2" data-path="essential-unixlinux-terminal-knowledge.html"><a href="essential-unixlinux-terminal-knowledge.html#navigating-the-unix-filesystem"><i class="fa fa-check"></i><b>4.2</b> Navigating the Unix filesystem</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="essential-unixlinux-terminal-knowledge.html"><a href="essential-unixlinux-terminal-knowledge.html#changing-the-working-directory-with-cd"><i class="fa fa-check"></i><b>4.2.1</b> Changing the working directory with <code>cd</code></a></li>
<li class="chapter" data-level="4.2.2" data-path="essential-unixlinux-terminal-knowledge.html"><a href="essential-unixlinux-terminal-knowledge.html#comm-prompt"><i class="fa fa-check"></i><b>4.2.2</b> Updating your command prompt</a></li>
<li class="chapter" data-level="4.2.3" data-path="essential-unixlinux-terminal-knowledge.html"><a href="essential-unixlinux-terminal-knowledge.html#tab-completion-for-paths"><i class="fa fa-check"></i><b>4.2.3</b> TAB-completion for paths</a></li>
<li class="chapter" data-level="4.2.4" data-path="essential-unixlinux-terminal-knowledge.html"><a href="essential-unixlinux-terminal-knowledge.html#listing-the-contents-of-a-directory-with-ls"><i class="fa fa-check"></i><b>4.2.4</b> Listing the contents of a directory with <code>ls</code></a></li>
<li class="chapter" data-level="4.2.5" data-path="essential-unixlinux-terminal-knowledge.html"><a href="essential-unixlinux-terminal-knowledge.html#globbing"><i class="fa fa-check"></i><b>4.2.5</b> Globbing</a></li>
<li class="chapter" data-level="4.2.6" data-path="essential-unixlinux-terminal-knowledge.html"><a href="essential-unixlinux-terminal-knowledge.html#what-makes-a-good-file-name"><i class="fa fa-check"></i><b>4.2.6</b> What makes a good file-name?</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="essential-unixlinux-terminal-knowledge.html"><a href="essential-unixlinux-terminal-knowledge.html#the-anatomy-of-a-unix-command"><i class="fa fa-check"></i><b>4.3</b> The anatomy of a Unix command</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="essential-unixlinux-terminal-knowledge.html"><a href="essential-unixlinux-terminal-knowledge.html#anatomy-command"><i class="fa fa-check"></i><b>4.3.1</b> The <code>command</code></a></li>
<li class="chapter" data-level="4.3.2" data-path="essential-unixlinux-terminal-knowledge.html"><a href="essential-unixlinux-terminal-knowledge.html#the-options"><i class="fa fa-check"></i><b>4.3.2</b> The <em>options</em></a></li>
<li class="chapter" data-level="4.3.3" data-path="essential-unixlinux-terminal-knowledge.html"><a href="essential-unixlinux-terminal-knowledge.html#arguments"><i class="fa fa-check"></i><b>4.3.3</b> Arguments</a></li>
<li class="chapter" data-level="4.3.4" data-path="essential-unixlinux-terminal-knowledge.html"><a href="essential-unixlinux-terminal-knowledge.html#getting-information-about-unix-commands"><i class="fa fa-check"></i><b>4.3.4</b> Getting information about Unix commands</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="essential-unixlinux-terminal-knowledge.html"><a href="essential-unixlinux-terminal-knowledge.html#handling-manipulating-and-viewing-files-and-streams"><i class="fa fa-check"></i><b>4.4</b> Handling, Manipulating, and Viewing files and streams</a>
<ul>
<li class="chapter" data-level="4.4.1" data-path="essential-unixlinux-terminal-knowledge.html"><a href="essential-unixlinux-terminal-knowledge.html#creating-new-directories"><i class="fa fa-check"></i><b>4.4.1</b> Creating new directories</a></li>
<li class="chapter" data-level="4.4.2" data-path="essential-unixlinux-terminal-knowledge.html"><a href="essential-unixlinux-terminal-knowledge.html#fundamental-file-handling-commands"><i class="fa fa-check"></i><b>4.4.2</b> Fundamental file-handling commands</a></li>
<li class="chapter" data-level="4.4.3" data-path="essential-unixlinux-terminal-knowledge.html"><a href="essential-unixlinux-terminal-knowledge.html#viewing-files"><i class="fa fa-check"></i><b>4.4.3</b> “Viewing” Files</a></li>
<li class="chapter" data-level="4.4.4" data-path="essential-unixlinux-terminal-knowledge.html"><a href="essential-unixlinux-terminal-knowledge.html#redirecting-standard-output-and"><i class="fa fa-check"></i><b>4.4.4</b> Redirecting standard output: <code>&gt;</code> and <code>&gt;&gt;</code></a></li>
<li class="chapter" data-level="4.4.5" data-path="essential-unixlinux-terminal-knowledge.html"><a href="essential-unixlinux-terminal-knowledge.html#stdin-and"><i class="fa fa-check"></i><b>4.4.5</b> stdin, <code>&lt;</code> and <code>|</code></a></li>
<li class="chapter" data-level="4.4.6" data-path="essential-unixlinux-terminal-knowledge.html"><a href="essential-unixlinux-terminal-knowledge.html#stderr"><i class="fa fa-check"></i><b>4.4.6</b> stderr</a></li>
<li class="chapter" data-level="4.4.7" data-path="essential-unixlinux-terminal-knowledge.html"><a href="essential-unixlinux-terminal-knowledge.html#symbolic-links"><i class="fa fa-check"></i><b>4.4.7</b> Symbolic links</a></li>
<li class="chapter" data-level="4.4.8" data-path="essential-unixlinux-terminal-knowledge.html"><a href="essential-unixlinux-terminal-knowledge.html#file-perm"><i class="fa fa-check"></i><b>4.4.8</b> File Permissions</a></li>
<li class="chapter" data-level="4.4.9" data-path="essential-unixlinux-terminal-knowledge.html"><a href="essential-unixlinux-terminal-knowledge.html#editing-text-files-at-the-terminal"><i class="fa fa-check"></i><b>4.4.9</b> Editing text files at the terminal</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="essential-unixlinux-terminal-knowledge.html"><a href="essential-unixlinux-terminal-knowledge.html#unix-env"><i class="fa fa-check"></i><b>4.5</b> Customizing your Environment</a>
<ul>
<li class="chapter" data-level="4.5.1" data-path="essential-unixlinux-terminal-knowledge.html"><a href="essential-unixlinux-terminal-knowledge.html#appearances-matter"><i class="fa fa-check"></i><b>4.5.1</b> Appearances matter</a></li>
<li class="chapter" data-level="4.5.2" data-path="essential-unixlinux-terminal-knowledge.html"><a href="essential-unixlinux-terminal-knowledge.html#where-are-my-programscommands-at"><i class="fa fa-check"></i><b>4.5.2</b> Where are my programs/commands at?!</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="essential-unixlinux-terminal-knowledge.html"><a href="essential-unixlinux-terminal-knowledge.html#a-few-more-important-keystrokes"><i class="fa fa-check"></i><b>4.6</b> A Few More Important Keystrokes</a></li>
<li class="chapter" data-level="4.7" data-path="essential-unixlinux-terminal-knowledge.html"><a href="essential-unixlinux-terminal-knowledge.html#a-short-list-of-additional-useful-commands."><i class="fa fa-check"></i><b>4.7</b> A short list of additional useful commands.</a></li>
<li class="chapter" data-level="4.8" data-path="essential-unixlinux-terminal-knowledge.html"><a href="essential-unixlinux-terminal-knowledge.html#two-important-computing-concepts"><i class="fa fa-check"></i><b>4.8</b> Two important computing concepts</a>
<ul>
<li class="chapter" data-level="4.8.1" data-path="essential-unixlinux-terminal-knowledge.html"><a href="essential-unixlinux-terminal-knowledge.html#compression"><i class="fa fa-check"></i><b>4.8.1</b> Compression</a></li>
<li class="chapter" data-level="4.8.2" data-path="essential-unixlinux-terminal-knowledge.html"><a href="essential-unixlinux-terminal-knowledge.html#hashing"><i class="fa fa-check"></i><b>4.8.2</b> Hashing</a></li>
</ul></li>
<li class="chapter" data-level="4.9" data-path="essential-unixlinux-terminal-knowledge.html"><a href="essential-unixlinux-terminal-knowledge.html#unix-quick-study-guide"><i class="fa fa-check"></i><b>4.9</b> Unix: Quick Study Guide</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="shell-programming.html"><a href="shell-programming.html"><i class="fa fa-check"></i><b>5</b> Shell programming</a>
<ul>
<li class="chapter" data-level="5.1" data-path="shell-programming.html"><a href="shell-programming.html#an-example-script"><i class="fa fa-check"></i><b>5.1</b> An example script</a></li>
<li class="chapter" data-level="5.2" data-path="shell-programming.html"><a href="shell-programming.html#the-structure-of-a-bash-script"><i class="fa fa-check"></i><b>5.2</b> The Structure of a Bash Script</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="shell-programming.html"><a href="shell-programming.html#paragraph-before-shebang"><i class="fa fa-check"></i><b>5.2.1</b> A bit more on <code>;</code> and <code>&amp;</code></a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="shell-programming.html"><a href="shell-programming.html#variables"><i class="fa fa-check"></i><b>5.3</b> Variables</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="shell-programming.html"><a href="shell-programming.html#assigning-values-to-variables"><i class="fa fa-check"></i><b>5.3.1</b> Assigning values to variables</a></li>
<li class="chapter" data-level="5.3.2" data-path="shell-programming.html"><a href="shell-programming.html#accessing-values-from-variables"><i class="fa fa-check"></i><b>5.3.2</b> Accessing values from variables</a></li>
<li class="chapter" data-level="5.3.3" data-path="shell-programming.html"><a href="shell-programming.html#shell-sub-vars"><i class="fa fa-check"></i><b>5.3.3</b> What does the shell do with the value substituted for a variable?</a></li>
<li class="chapter" data-level="5.3.4" data-path="shell-programming.html"><a href="shell-programming.html#quotes-and-var-subs"><i class="fa fa-check"></i><b>5.3.4</b> Double and Single Quotation Marks and Variable Substitution</a></li>
<li class="chapter" data-level="5.3.5" data-path="shell-programming.html"><a href="shell-programming.html#one-useful-fancy-variable-substitution-method"><i class="fa fa-check"></i><b>5.3.5</b> One useful, fancy, variable-substitution method</a></li>
<li class="chapter" data-level="5.3.6" data-path="shell-programming.html"><a href="shell-programming.html#bash-arithmetic"><i class="fa fa-check"></i><b>5.3.6</b> Integer Arithmetic with Shell Variables</a></li>
<li class="chapter" data-level="5.3.7" data-path="shell-programming.html"><a href="shell-programming.html#variable-arrays"><i class="fa fa-check"></i><b>5.3.7</b> Variable arrays</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="shell-programming.html"><a href="shell-programming.html#bash-sub-result-on-comm-line"><i class="fa fa-check"></i><b>5.4</b> Evaluate a command and substitute the result on the command line</a></li>
<li class="chapter" data-level="5.5" data-path="shell-programming.html"><a href="shell-programming.html#groupingcollecting-output-from-multiple-commands-commands-and-commands"><i class="fa fa-check"></i><b>5.5</b> Grouping/Collecting output from multiple commands: <code>(commands)</code> and <code>{ commands; }</code></a></li>
<li class="chapter" data-level="5.6" data-path="shell-programming.html"><a href="shell-programming.html#exit-status"><i class="fa fa-check"></i><b>5.6</b> Exit Status</a>
<ul>
<li class="chapter" data-level="5.6.1" data-path="shell-programming.html"><a href="shell-programming.html#combinations-of-exit-statuses"><i class="fa fa-check"></i><b>5.6.1</b> Combinations of exit statuses</a></li>
</ul></li>
<li class="chapter" data-level="5.7" data-path="shell-programming.html"><a href="shell-programming.html#unix-for-loops"><i class="fa fa-check"></i><b>5.7</b> Loops and repetition</a></li>
<li class="chapter" data-level="5.8" data-path="shell-programming.html"><a href="shell-programming.html#more-conditional-evaluation-if-then-else-and-friends"><i class="fa fa-check"></i><b>5.8</b> More Conditional Evaluation: <code>if</code>, <code>then</code>, <code>else</code>, and friends</a></li>
<li class="chapter" data-level="5.9" data-path="shell-programming.html"><a href="shell-programming.html#finallypositional-parameters"><i class="fa fa-check"></i><b>5.9</b> Finally…positional parameters</a></li>
<li class="chapter" data-level="5.10" data-path="shell-programming.html"><a href="shell-programming.html#basename-and-dirname-two-useful-little-utilities"><i class="fa fa-check"></i><b>5.10</b> <code>basename</code> and <code>dirname</code> two useful little utilities</a></li>
<li class="chapter" data-level="5.11" data-path="shell-programming.html"><a href="shell-programming.html#bash-functions"><i class="fa fa-check"></i><b>5.11</b> <code>bash</code> functions</a></li>
<li class="chapter" data-level="5.12" data-path="shell-programming.html"><a href="shell-programming.html#reading-files-line-by-line"><i class="fa fa-check"></i><b>5.12</b> reading files line by line</a></li>
<li class="chapter" data-level="5.13" data-path="shell-programming.html"><a href="shell-programming.html#further-reading"><i class="fa fa-check"></i><b>5.13</b> Further reading</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="sed-awk-and-regular-expressions.html"><a href="sed-awk-and-regular-expressions.html"><i class="fa fa-check"></i><b>6</b> Sed, awk, and regular expressions</a>
<ul>
<li class="chapter" data-level="6.1" data-path="sed-awk-and-regular-expressions.html"><a href="sed-awk-and-regular-expressions.html#awk"><i class="fa fa-check"></i><b>6.1</b> awk</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="sed-awk-and-regular-expressions.html"><a href="sed-awk-and-regular-expressions.html#line-cycling-tests-and-actions"><i class="fa fa-check"></i><b>6.1.1</b> Line-cycling, tests and actions</a></li>
<li class="chapter" data-level="6.1.2" data-path="sed-awk-and-regular-expressions.html"><a href="sed-awk-and-regular-expressions.html#column-splitting-fields--f-nf-print-ofs-and-begin"><i class="fa fa-check"></i><b>6.1.2</b> Column splitting, fields, <code>-F</code>, <code>$</code>, <code>NF</code>, <code>print</code>, <code>OFS</code> and <code>BEGIN</code></a></li>
<li class="chapter" data-level="6.1.3" data-path="sed-awk-and-regular-expressions.html"><a href="sed-awk-and-regular-expressions.html#a-brief-introduction-to-regular-expressions"><i class="fa fa-check"></i><b>6.1.3</b> A brief introduction to regular expressions</a></li>
<li class="chapter" data-level="6.1.4" data-path="sed-awk-and-regular-expressions.html"><a href="sed-awk-and-regular-expressions.html#a-variety-of-tests"><i class="fa fa-check"></i><b>6.1.4</b> A variety of tests</a></li>
<li class="chapter" data-level="6.1.5" data-path="sed-awk-and-regular-expressions.html"><a href="sed-awk-and-regular-expressions.html#code-in-the-action-blocks"><i class="fa fa-check"></i><b>6.1.5</b> Code in the action blocks</a></li>
<li class="chapter" data-level="6.1.6" data-path="sed-awk-and-regular-expressions.html"><a href="sed-awk-and-regular-expressions.html#using-awk-to-assign-to-shell-variables"><i class="fa fa-check"></i><b>6.1.6</b> Using <code>awk</code> to assign to shell variables</a></li>
<li class="chapter" data-level="6.1.7" data-path="sed-awk-and-regular-expressions.html"><a href="sed-awk-and-regular-expressions.html#passing-variables-into-awk-with--v"><i class="fa fa-check"></i><b>6.1.7</b> Passing Variables into <code>awk</code> with <code>-v</code></a></li>
<li class="chapter" data-level="6.1.8" data-path="sed-awk-and-regular-expressions.html"><a href="sed-awk-and-regular-expressions.html#writing-awk-scripts-in-files"><i class="fa fa-check"></i><b>6.1.8</b> Writing awk scripts in files</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="sed-awk-and-regular-expressions.html"><a href="sed-awk-and-regular-expressions.html#sed"><i class="fa fa-check"></i><b>6.2</b> sed</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="working-on-remote-servers.html"><a href="working-on-remote-servers.html"><i class="fa fa-check"></i><b>7</b> Working on remote servers</a>
<ul>
<li class="chapter" data-level="7.1" data-path="working-on-remote-servers.html"><a href="working-on-remote-servers.html#accessing-remote-computers"><i class="fa fa-check"></i><b>7.1</b> Accessing remote computers</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="working-on-remote-servers.html"><a href="working-on-remote-servers.html#windows"><i class="fa fa-check"></i><b>7.1.1</b> Windows</a></li>
<li class="chapter" data-level="7.1.2" data-path="working-on-remote-servers.html"><a href="working-on-remote-servers.html#hummingbird"><i class="fa fa-check"></i><b>7.1.2</b> Hummingbird</a></li>
<li class="chapter" data-level="7.1.3" data-path="working-on-remote-servers.html"><a href="working-on-remote-servers.html#summit"><i class="fa fa-check"></i><b>7.1.3</b> Summit</a></li>
<li class="chapter" data-level="7.1.4" data-path="working-on-remote-servers.html"><a href="working-on-remote-servers.html#sedna"><i class="fa fa-check"></i><b>7.1.4</b> Sedna</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="working-on-remote-servers.html"><a href="working-on-remote-servers.html#transferring-files-to-remote-computers"><i class="fa fa-check"></i><b>7.2</b> Transferring files to remote computers</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="working-on-remote-servers.html"><a href="working-on-remote-servers.html#sftp-and-several-systems-that-use-it"><i class="fa fa-check"></i><b>7.2.1</b> <code>sftp</code> and several systems that use it</a></li>
<li class="chapter" data-level="7.2.2" data-path="working-on-remote-servers.html"><a href="working-on-remote-servers.html#git"><i class="fa fa-check"></i><b>7.2.2</b> git</a></li>
<li class="chapter" data-level="7.2.3" data-path="working-on-remote-servers.html"><a href="working-on-remote-servers.html#globus"><i class="fa fa-check"></i><b>7.2.3</b> Globus</a></li>
<li class="chapter" data-level="7.2.4" data-path="working-on-remote-servers.html"><a href="working-on-remote-servers.html#interfacing-with-the-cloud"><i class="fa fa-check"></i><b>7.2.4</b> Interfacing with “The Cloud”</a></li>
<li class="chapter" data-level="7.2.5" data-path="working-on-remote-servers.html"><a href="working-on-remote-servers.html#get-seqs"><i class="fa fa-check"></i><b>7.2.5</b> Getting files from a sequencing center</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="working-on-remote-servers.html"><a href="working-on-remote-servers.html#tmux"><i class="fa fa-check"></i><b>7.3</b> <code>tmux</code>: the terminal multiplexer</a>
<ul>
<li class="chapter" data-level="7.3.1" data-path="working-on-remote-servers.html"><a href="working-on-remote-servers.html#an-analogy-for-how-tmux-works"><i class="fa fa-check"></i><b>7.3.1</b> An analogy for how <code>tmux</code> works</a></li>
<li class="chapter" data-level="7.3.2" data-path="working-on-remote-servers.html"><a href="working-on-remote-servers.html#first-steps-with-tmux"><i class="fa fa-check"></i><b>7.3.2</b> First steps with <code>tmux</code></a></li>
<li class="chapter" data-level="7.3.3" data-path="working-on-remote-servers.html"><a href="working-on-remote-servers.html#further-steps-with-tmux"><i class="fa fa-check"></i><b>7.3.3</b> Further steps with <code>tmux</code></a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="working-on-remote-servers.html"><a href="working-on-remote-servers.html#tmux-for-mac-users"><i class="fa fa-check"></i><b>7.4</b> <code>tmux</code> for Mac users</a></li>
<li class="chapter" data-level="7.5" data-path="working-on-remote-servers.html"><a href="working-on-remote-servers.html#installing-software-on-an-hpcc"><i class="fa fa-check"></i><b>7.5</b> Installing Software on an HPCC</a>
<ul>
<li class="chapter" data-level="7.5.1" data-path="working-on-remote-servers.html"><a href="working-on-remote-servers.html#modules"><i class="fa fa-check"></i><b>7.5.1</b> Modules</a></li>
<li class="chapter" data-level="7.5.2" data-path="working-on-remote-servers.html"><a href="working-on-remote-servers.html#miniconda"><i class="fa fa-check"></i><b>7.5.2</b> Miniconda</a></li>
<li class="chapter" data-level="7.5.3" data-path="working-on-remote-servers.html"><a href="working-on-remote-servers.html#installing-java-programs"><i class="fa fa-check"></i><b>7.5.3</b> Installing Java Programs</a></li>
</ul></li>
<li class="chapter" data-level="7.6" data-path="working-on-remote-servers.html"><a href="working-on-remote-servers.html#vim-its-time-to-get-serious-with-text-editing"><i class="fa fa-check"></i><b>7.6</b> <code>vim</code>: it’s time to get serious with text editing</a>
<ul>
<li class="chapter" data-level="7.6.1" data-path="working-on-remote-servers.html"><a href="working-on-remote-servers.html#using-neovim-and-nvim-r-and-tmux-to-use-r-well-on-the-cluster"><i class="fa fa-check"></i><b>7.6.1</b> Using neovim and Nvim-R and tmux to use R well on the cluster</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="chap-HPCC.html"><a href="chap-HPCC.html"><i class="fa fa-check"></i><b>8</b> High Performance Computing Clusters (HPCC’s)</a>
<ul>
<li class="chapter" data-level="8.1" data-path="chap-HPCC.html"><a href="chap-HPCC.html#an-oversimplified-but-useful-view-of-a-computing-cluster"><i class="fa fa-check"></i><b>8.1</b> An oversimplified, but useful, view of a computing cluster</a></li>
<li class="chapter" data-level="8.2" data-path="chap-HPCC.html"><a href="chap-HPCC.html#cluster-computing-and-the-job-scheduler"><i class="fa fa-check"></i><b>8.2</b> Cluster computing and the job scheduler</a></li>
<li class="chapter" data-level="8.3" data-path="chap-HPCC.html"><a href="chap-HPCC.html#slurm-info"><i class="fa fa-check"></i><b>8.3</b> Learning about the resources on your HPCC</a></li>
<li class="chapter" data-level="8.4" data-path="chap-HPCC.html"><a href="chap-HPCC.html#getting-compute-resources-allocated-to-your-jobs-on-an-hpcc"><i class="fa fa-check"></i><b>8.4</b> Getting compute resources allocated to your jobs on an HPCC</a>
<ul>
<li class="chapter" data-level="8.4.1" data-path="chap-HPCC.html"><a href="chap-HPCC.html#interactive-sessions"><i class="fa fa-check"></i><b>8.4.1</b> Interactive sessions</a></li>
<li class="chapter" data-level="8.4.2" data-path="chap-HPCC.html"><a href="chap-HPCC.html#slurm-batch"><i class="fa fa-check"></i><b>8.4.2</b> Batch jobs</a></li>
<li class="chapter" data-level="8.4.3" data-path="chap-HPCC.html"><a href="chap-HPCC.html#slurm-job-arrays"><i class="fa fa-check"></i><b>8.4.3</b> SLURM Job Arrays</a></li>
</ul></li>
<li class="chapter" data-level="8.5" data-path="chap-HPCC.html"><a href="chap-HPCC.html#last-years-stuff.-now-somewhat-defunct"><i class="fa fa-check"></i><b>8.5</b> Last year’s stuff. Now somewhat defunct</a></li>
<li class="chapter" data-level="8.6" data-path="chap-HPCC.html"><a href="chap-HPCC.html#prepation-interlude-an-in-class-exercise-to-make-sure-everything-is-configured-correctly"><i class="fa fa-check"></i><b>8.6</b> PREPATION INTERLUDE: An in-class exercise to make sure everything is configured correctly</a></li>
<li class="chapter" data-level="8.7" data-path="chap-HPCC.html"><a href="chap-HPCC.html#more-boneyard"><i class="fa fa-check"></i><b>8.7</b> More Boneyard…</a></li>
<li class="chapter" data-level="8.8" data-path="chap-HPCC.html"><a href="chap-HPCC.html#the-queue-slurmsgeuge"><i class="fa fa-check"></i><b>8.8</b> The Queue (SLURM/SGE/UGE)</a></li>
<li class="chapter" data-level="8.9" data-path="chap-HPCC.html"><a href="chap-HPCC.html#modules-package"><i class="fa fa-check"></i><b>8.9</b> Modules package</a></li>
<li class="chapter" data-level="8.10" data-path="chap-HPCC.html"><a href="chap-HPCC.html#compiling-programs-without-admin-privileges"><i class="fa fa-check"></i><b>8.10</b> Compiling programs without admin privileges</a></li>
<li class="chapter" data-level="8.11" data-path="chap-HPCC.html"><a href="chap-HPCC.html#job-arrays"><i class="fa fa-check"></i><b>8.11</b> Job arrays</a></li>
<li class="chapter" data-level="8.12" data-path="chap-HPCC.html"><a href="chap-HPCC.html#writing-stdout-and-stderr-to-files"><i class="fa fa-check"></i><b>8.12</b> Writing stdout and stderr to files</a></li>
<li class="chapter" data-level="8.13" data-path="chap-HPCC.html"><a href="chap-HPCC.html#breaking-stuff-down"><i class="fa fa-check"></i><b>8.13</b> Breaking stuff down</a></li>
</ul></li>
<li class="part"><span><b>II Part II: Reproducible Research Strategies</b></span></li>
<li class="chapter" data-level="9" data-path="introduction-to-reproducible-research.html"><a href="introduction-to-reproducible-research.html"><i class="fa fa-check"></i><b>9</b> Introduction to Reproducible Research</a></li>
<li class="chapter" data-level="10" data-path="rstudio-and-project-centered-organization.html"><a href="rstudio-and-project-centered-organization.html"><i class="fa fa-check"></i><b>10</b> Rstudio and Project-centered Organization</a>
<ul>
<li class="chapter" data-level="10.1" data-path="rstudio-and-project-centered-organization.html"><a href="rstudio-and-project-centered-organization.html#organizing-big-projects"><i class="fa fa-check"></i><b>10.1</b> Organizing big projects</a></li>
<li class="chapter" data-level="10.2" data-path="rstudio-and-project-centered-organization.html"><a href="rstudio-and-project-centered-organization.html#using-rstudio-in-workflows-with-remote-computers-and-hpccs"><i class="fa fa-check"></i><b>10.2</b> Using RStudio in workflows with remote computers and HPCCs</a>
<ul>
<li class="chapter" data-level="10.2.1" data-path="rstudio-and-project-centered-organization.html"><a href="rstudio-and-project-centered-organization.html#keeping-an-rstudio-project-in-sync-with-github"><i class="fa fa-check"></i><b>10.2.1</b> Keeping an RStudio project “in sync” with GitHub</a></li>
<li class="chapter" data-level="10.2.2" data-path="rstudio-and-project-centered-organization.html"><a href="rstudio-and-project-centered-organization.html#evaluating-scripts-line-by-line-on-a-remote-machine-from-within-rstudio"><i class="fa fa-check"></i><b>10.2.2</b> Evaluating scripts line by line on a remote machine from within RStudio</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="version-control.html"><a href="version-control.html"><i class="fa fa-check"></i><b>11</b> Version control</a>
<ul>
<li class="chapter" data-level="11.1" data-path="version-control.html"><a href="version-control.html#why-use-version-control"><i class="fa fa-check"></i><b>11.1</b> Why use version control?</a></li>
<li class="chapter" data-level="11.2" data-path="version-control.html"><a href="version-control.html#git-workings"><i class="fa fa-check"></i><b>11.2</b> How git works</a></li>
<li class="chapter" data-level="11.3" data-path="version-control.html"><a href="version-control.html#git-workflow-patterns"><i class="fa fa-check"></i><b>11.3</b> git workflow patterns</a></li>
<li class="chapter" data-level="11.4" data-path="version-control.html"><a href="version-control.html#using-git-with-rstudio"><i class="fa fa-check"></i><b>11.4</b> using git with Rstudio</a></li>
<li class="chapter" data-level="11.5" data-path="version-control.html"><a href="version-control.html#git-on-the-command-line"><i class="fa fa-check"></i><b>11.5</b> git on the command line</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="a-fast-furious-overview-of-the-tidyverse.html"><a href="a-fast-furious-overview-of-the-tidyverse.html"><i class="fa fa-check"></i><b>12</b> A fast, furious overview of the tidyverse</a></li>
<li class="chapter" data-level="13" data-path="authoring-reproducibly-with-rmarkdown.html"><a href="authoring-reproducibly-with-rmarkdown.html"><i class="fa fa-check"></i><b>13</b> Authoring reproducibly with Rmarkdown</a>
<ul>
<li class="chapter" data-level="13.1" data-path="authoring-reproducibly-with-rmarkdown.html"><a href="authoring-reproducibly-with-rmarkdown.html#notebooks"><i class="fa fa-check"></i><b>13.1</b> Notebooks</a></li>
<li class="chapter" data-level="13.2" data-path="authoring-reproducibly-with-rmarkdown.html"><a href="authoring-reproducibly-with-rmarkdown.html#references"><i class="fa fa-check"></i><b>13.2</b> References</a>
<ul>
<li class="chapter" data-level="13.2.1" data-path="authoring-reproducibly-with-rmarkdown.html"><a href="authoring-reproducibly-with-rmarkdown.html#zotero-and-rmarkdown"><i class="fa fa-check"></i><b>13.2.1</b> Zotero and Rmarkdown</a></li>
</ul></li>
<li class="chapter" data-level="13.3" data-path="authoring-reproducibly-with-rmarkdown.html"><a href="authoring-reproducibly-with-rmarkdown.html#bookdown"><i class="fa fa-check"></i><b>13.3</b> Bookdown</a></li>
<li class="chapter" data-level="13.4" data-path="authoring-reproducibly-with-rmarkdown.html"><a href="authoring-reproducibly-with-rmarkdown.html#google-docs"><i class="fa fa-check"></i><b>13.4</b> Google Docs</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="snakemake-chap.html"><a href="snakemake-chap.html"><i class="fa fa-check"></i><b>14</b> Managing Workflows with Snakemake</a>
<ul>
<li class="chapter" data-level="14.1" data-path="snakemake-chap.html"><a href="snakemake-chap.html#a-simple-snakemake-example"><i class="fa fa-check"></i><b>14.1</b> A Simple Snakemake Example</a>
<ul>
<li class="chapter" data-level="14.1.1" data-path="snakemake-chap.html"><a href="snakemake-chap.html#snakefile-1-a-simple-rule-to-trimmomcawesome-the-files-from-001"><i class="fa fa-check"></i><b>14.1.1</b> Snakefile #1: A simple rule to TrimmoMcAwesome the files from 001</a></li>
<li class="chapter" data-level="14.1.2" data-path="snakemake-chap.html"><a href="snakemake-chap.html#snakefile-2-a-single-trimmomcawesome-rule-using-wildcards"><i class="fa fa-check"></i><b>14.1.2</b> Snakefile #2: A single TrimmoMcAwesome rule using wildcards</a></li>
<li class="chapter" data-level="14.1.3" data-path="snakemake-chap.html"><a href="snakemake-chap.html#snakefile-3-add-trim_stupendous-in-there"><i class="fa fa-check"></i><b>14.1.3</b> Snakefile #3: Add <code>trim_stupendous</code> in there</a></li>
</ul></li>
<li class="chapter" data-level="14.2" data-path="snakemake-chap.html"><a href="snakemake-chap.html#ugly-complex-file-namesa-job-for-snakemake-input-functions"><i class="fa fa-check"></i><b>14.2</b> Ugly, complex file names…a job for Snakemake input functions!</a>
<ul>
<li class="chapter" data-level="14.2.1" data-path="snakemake-chap.html"><a href="snakemake-chap.html#playing-with-pandas"><i class="fa fa-check"></i><b>14.2.1</b> Playing with Pandas</a></li>
<li class="chapter" data-level="14.2.2" data-path="snakemake-chap.html"><a href="snakemake-chap.html#a-quick-sidebar-spoofing-a-snakemake-input-function"><i class="fa fa-check"></i><b>14.2.2</b> A Quick Sidebar: Spoofing a Snakemake input function</a></li>
<li class="chapter" data-level="14.2.3" data-path="snakemake-chap.html"><a href="snakemake-chap.html#snakefile-4-an-input-function-for-trim_awesome"><i class="fa fa-check"></i><b>14.2.3</b> Snakefile #4: an input function for trim_awesome</a></li>
</ul></li>
<li class="chapter" data-level="14.3" data-path="snakemake-chap.html"><a href="snakemake-chap.html#input-functions-from-python-dictionaries"><i class="fa fa-check"></i><b>14.3</b> Input functions from Python Dictionaries</a></li>
<li class="chapter" data-level="14.4" data-path="snakemake-chap.html"><a href="snakemake-chap.html#generating-lists-of-files-with-expand"><i class="fa fa-check"></i><b>14.4</b> Generating lists of files with expand()</a></li>
<li class="chapter" data-level="14.5" data-path="snakemake-chap.html"><a href="snakemake-chap.html#a-python-primer-for-using-snakemake"><i class="fa fa-check"></i><b>14.5</b> A Python Primer for Using Snakemake</a></li>
<li class="chapter" data-level="14.6" data-path="snakemake-chap.html"><a href="snakemake-chap.html#using-snakemake-on-a-computing-cluster"><i class="fa fa-check"></i><b>14.6</b> Using Snakemake on a Computing Cluster</a>
<ul>
<li class="chapter" data-level="14.6.1" data-path="snakemake-chap.html"><a href="snakemake-chap.html#installing-and-configuring-the-snakemake-slurm-profile"><i class="fa fa-check"></i><b>14.6.1</b> Installing and Configuring the Snakemake SLURM profile</a></li>
<li class="chapter" data-level="14.6.2" data-path="snakemake-chap.html"><a href="snakemake-chap.html#playing-with-our-new-slurm-profile"><i class="fa fa-check"></i><b>14.6.2</b> Playing with our new SLURM profile</a></li>
<li class="chapter" data-level="14.6.3" data-path="snakemake-chap.html"><a href="snakemake-chap.html#managing-cluster-resources-with-snakemake"><i class="fa fa-check"></i><b>14.6.3</b> Managing cluster resources with Snakemake</a></li>
<li class="chapter" data-level="14.6.4" data-path="snakemake-chap.html"><a href="snakemake-chap.html#grouping-short-jobs-to-run-on-a-single-node"><i class="fa fa-check"></i><b>14.6.4</b> Grouping short jobs to run on a single node</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>III Part III: Bioinformatic Analyses</b></span></li>
<li class="chapter" data-level="15" data-path="overview-of-bioinformatic-analyses.html"><a href="overview-of-bioinformatic-analyses.html"><i class="fa fa-check"></i><b>15</b> Overview of Bioinformatic Analyses</a></li>
<li class="chapter" data-level="16" data-path="dna-sequences-and-sequencing.html"><a href="dna-sequences-and-sequencing.html"><i class="fa fa-check"></i><b>16</b> DNA Sequences and Sequencing</a>
<ul>
<li class="chapter" data-level="16.1" data-path="dna-sequences-and-sequencing.html"><a href="dna-sequences-and-sequencing.html#dna-stuff"><i class="fa fa-check"></i><b>16.1</b> DNA Stuff</a>
<ul>
<li class="chapter" data-level="16.1.1" data-path="dna-sequences-and-sequencing.html"><a href="dna-sequences-and-sequencing.html#dna-replication-with-dna-polymerase"><i class="fa fa-check"></i><b>16.1.1</b> DNA Replication with DNA Polymerase</a></li>
<li class="chapter" data-level="16.1.2" data-path="dna-sequences-and-sequencing.html"><a href="dna-sequences-and-sequencing.html#the-importance-of-the-3-hydroxyl"><i class="fa fa-check"></i><b>16.1.2</b> The importance of the 3’ hydroxyl…</a></li>
</ul></li>
<li class="chapter" data-level="16.2" data-path="dna-sequences-and-sequencing.html"><a href="dna-sequences-and-sequencing.html#sanger-sequencing"><i class="fa fa-check"></i><b>16.2</b> Sanger sequencing</a></li>
<li class="chapter" data-level="16.3" data-path="dna-sequences-and-sequencing.html"><a href="dna-sequences-and-sequencing.html#illumina-sequencing-by-synthesis"><i class="fa fa-check"></i><b>16.3</b> Illumina Sequencing by Synthesis</a></li>
<li class="chapter" data-level="16.4" data-path="dna-sequences-and-sequencing.html"><a href="dna-sequences-and-sequencing.html#library-prep-protocols"><i class="fa fa-check"></i><b>16.4</b> Library Prep Protocols</a>
<ul>
<li class="chapter" data-level="16.4.1" data-path="dna-sequences-and-sequencing.html"><a href="dna-sequences-and-sequencing.html#wgs"><i class="fa fa-check"></i><b>16.4.1</b> WGS</a></li>
<li class="chapter" data-level="16.4.2" data-path="dna-sequences-and-sequencing.html"><a href="dna-sequences-and-sequencing.html#rad-seq-methods"><i class="fa fa-check"></i><b>16.4.2</b> RAD-Seq methods</a></li>
<li class="chapter" data-level="16.4.3" data-path="dna-sequences-and-sequencing.html"><a href="dna-sequences-and-sequencing.html#amplicon-sequencing"><i class="fa fa-check"></i><b>16.4.3</b> Amplicon Sequencing</a></li>
<li class="chapter" data-level="16.4.4" data-path="dna-sequences-and-sequencing.html"><a href="dna-sequences-and-sequencing.html#capture-arrays-rapture-etc."><i class="fa fa-check"></i><b>16.4.4</b> Capture arrays, RAPTURE, etc.</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="17" data-path="bioinformatic-file-formats.html"><a href="bioinformatic-file-formats.html"><i class="fa fa-check"></i><b>17</b> Bioinformatic file formats</a>
<ul>
<li class="chapter" data-level="17.1" data-path="bioinformatic-file-formats.html"><a href="bioinformatic-file-formats.html#sequences"><i class="fa fa-check"></i><b>17.1</b> Sequences</a></li>
<li class="chapter" data-level="17.2" data-path="bioinformatic-file-formats.html"><a href="bioinformatic-file-formats.html#fastq"><i class="fa fa-check"></i><b>17.2</b> FASTQ</a>
<ul>
<li class="chapter" data-level="17.2.1" data-path="bioinformatic-file-formats.html"><a href="bioinformatic-file-formats.html#illumina-ids"><i class="fa fa-check"></i><b>17.2.1</b> Line 1: Illumina identifier lines</a></li>
<li class="chapter" data-level="17.2.2" data-path="bioinformatic-file-formats.html"><a href="bioinformatic-file-formats.html#bqscores"><i class="fa fa-check"></i><b>17.2.2</b> Line 4: Base quality scores</a></li>
<li class="chapter" data-level="17.2.3" data-path="bioinformatic-file-formats.html"><a href="bioinformatic-file-formats.html#a-fastq-tidyverse-interlude"><i class="fa fa-check"></i><b>17.2.3</b> A FASTQ ‘tidyverse’ Interlude</a></li>
<li class="chapter" data-level="17.2.4" data-path="bioinformatic-file-formats.html"><a href="bioinformatic-file-formats.html#comparing-read-1-to-read-2"><i class="fa fa-check"></i><b>17.2.4</b> Comparing read 1 to read 2</a></li>
</ul></li>
<li class="chapter" data-level="17.3" data-path="bioinformatic-file-formats.html"><a href="bioinformatic-file-formats.html#fasta"><i class="fa fa-check"></i><b>17.3</b> FASTA</a>
<ul>
<li class="chapter" data-level="17.3.1" data-path="bioinformatic-file-formats.html"><a href="bioinformatic-file-formats.html#genomic-ranges"><i class="fa fa-check"></i><b>17.3.1</b> Genomic ranges</a></li>
<li class="chapter" data-level="17.3.2" data-path="bioinformatic-file-formats.html"><a href="bioinformatic-file-formats.html#extracting-genomic-ranges-from-a-fasta-file"><i class="fa fa-check"></i><b>17.3.2</b> Extracting genomic ranges from a FASTA file</a></li>
<li class="chapter" data-level="17.3.3" data-path="bioinformatic-file-formats.html"><a href="bioinformatic-file-formats.html#downloading-reference-genomes-from-ncbi"><i class="fa fa-check"></i><b>17.3.3</b> Downloading reference genomes from NCBI</a></li>
</ul></li>
<li class="chapter" data-level="17.4" data-path="bioinformatic-file-formats.html"><a href="bioinformatic-file-formats.html#sambamfiles"><i class="fa fa-check"></i><b>17.4</b> Alignments</a>
<ul>
<li class="chapter" data-level="17.4.1" data-path="bioinformatic-file-formats.html"><a href="bioinformatic-file-formats.html#how-might-i-align-to-thee-let-me-count-the-ways"><i class="fa fa-check"></i><b>17.4.1</b> How might I align to thee? Let me count the ways…</a></li>
<li class="chapter" data-level="17.4.2" data-path="bioinformatic-file-formats.html"><a href="bioinformatic-file-formats.html#play-with-simple-alignments"><i class="fa fa-check"></i><b>17.4.2</b> Play with simple alignments</a></li>
<li class="chapter" data-level="17.4.3" data-path="bioinformatic-file-formats.html"><a href="bioinformatic-file-formats.html#sam-flags"><i class="fa fa-check"></i><b>17.4.3</b> SAM Flags</a></li>
<li class="chapter" data-level="17.4.4" data-path="bioinformatic-file-formats.html"><a href="bioinformatic-file-formats.html#cigar"><i class="fa fa-check"></i><b>17.4.4</b> The CIGAR string</a></li>
<li class="chapter" data-level="17.4.5" data-path="bioinformatic-file-formats.html"><a href="bioinformatic-file-formats.html#the-seq-and-qual-columns"><i class="fa fa-check"></i><b>17.4.5</b> The SEQ and QUAL columns</a></li>
<li class="chapter" data-level="17.4.6" data-path="bioinformatic-file-formats.html"><a href="bioinformatic-file-formats.html#sam-headers"><i class="fa fa-check"></i><b>17.4.6</b> SAM File Headers</a></li>
<li class="chapter" data-level="17.4.7" data-path="bioinformatic-file-formats.html"><a href="bioinformatic-file-formats.html#the-bam-format"><i class="fa fa-check"></i><b>17.4.7</b> The BAM format</a></li>
<li class="chapter" data-level="17.4.8" data-path="bioinformatic-file-formats.html"><a href="bioinformatic-file-formats.html#quick-self-study"><i class="fa fa-check"></i><b>17.4.8</b> Quick self study</a></li>
</ul></li>
<li class="chapter" data-level="17.5" data-path="bioinformatic-file-formats.html"><a href="bioinformatic-file-formats.html#variants"><i class="fa fa-check"></i><b>17.5</b> Variants</a>
<ul>
<li class="chapter" data-level="17.5.1" data-path="bioinformatic-file-formats.html"><a href="bioinformatic-file-formats.html#vcf-format-the-body"><i class="fa fa-check"></i><b>17.5.1</b> VCF Format – The Body</a></li>
<li class="chapter" data-level="17.5.2" data-path="bioinformatic-file-formats.html"><a href="bioinformatic-file-formats.html#vcf-format-the-header"><i class="fa fa-check"></i><b>17.5.2</b> VCF Format – The Header</a></li>
<li class="chapter" data-level="17.5.3" data-path="bioinformatic-file-formats.html"><a href="bioinformatic-file-formats.html#boneyard"><i class="fa fa-check"></i><b>17.5.3</b> Boneyard</a></li>
</ul></li>
<li class="chapter" data-level="17.6" data-path="bioinformatic-file-formats.html"><a href="bioinformatic-file-formats.html#segments"><i class="fa fa-check"></i><b>17.6</b> Segments</a></li>
<li class="chapter" data-level="17.7" data-path="bioinformatic-file-formats.html"><a href="bioinformatic-file-formats.html#conversionextractions-between-different-formats"><i class="fa fa-check"></i><b>17.7</b> Conversion/Extractions between different formats</a></li>
<li class="chapter" data-level="17.8" data-path="bioinformatic-file-formats.html"><a href="bioinformatic-file-formats.html#visualization-of-genomic-data"><i class="fa fa-check"></i><b>17.8</b> Visualization of Genomic Data</a>
<ul>
<li class="chapter" data-level="17.8.1" data-path="bioinformatic-file-formats.html"><a href="bioinformatic-file-formats.html#sample-data"><i class="fa fa-check"></i><b>17.8.1</b> Sample Data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="18" data-path="genome-assembly.html"><a href="genome-assembly.html"><i class="fa fa-check"></i><b>18</b> Genome Assembly</a></li>
<li class="chapter" data-level="19" data-path="alignment-of-sequence-data-to-a-reference-genome-and-associated-steps.html"><a href="alignment-of-sequence-data-to-a-reference-genome-and-associated-steps.html"><i class="fa fa-check"></i><b>19</b> Alignment of sequence data to a reference genome (and associated steps)</a>
<ul>
<li class="chapter" data-level="19.1" data-path="alignment-of-sequence-data-to-a-reference-genome-and-associated-steps.html"><a href="alignment-of-sequence-data-to-a-reference-genome-and-associated-steps.html#read-journey"><i class="fa fa-check"></i><b>19.1</b> The Journey of each DNA Fragment from Organism to Sequencing Read</a></li>
<li class="chapter" data-level="19.2" data-path="alignment-of-sequence-data-to-a-reference-genome-and-associated-steps.html"><a href="alignment-of-sequence-data-to-a-reference-genome-and-associated-steps.html#read-groups"><i class="fa fa-check"></i><b>19.2</b> Read Groups</a></li>
<li class="chapter" data-level="19.3" data-path="alignment-of-sequence-data-to-a-reference-genome-and-associated-steps.html"><a href="alignment-of-sequence-data-to-a-reference-genome-and-associated-steps.html#aligning-reads-with-bwa"><i class="fa fa-check"></i><b>19.3</b> Aligning reads with <code>bwa</code></a>
<ul>
<li class="chapter" data-level="19.3.1" data-path="alignment-of-sequence-data-to-a-reference-genome-and-associated-steps.html"><a href="alignment-of-sequence-data-to-a-reference-genome-and-associated-steps.html#indexing-the-genome-for-alignment"><i class="fa fa-check"></i><b>19.3.1</b> Indexing the genome for alignment</a></li>
<li class="chapter" data-level="19.3.2" data-path="alignment-of-sequence-data-to-a-reference-genome-and-associated-steps.html"><a href="alignment-of-sequence-data-to-a-reference-genome-and-associated-steps.html#mapping-reads-with-bwa-mem"><i class="fa fa-check"></i><b>19.3.2</b> Mapping reads with <code>bwa mem</code></a></li>
<li class="chapter" data-level="19.3.3" data-path="alignment-of-sequence-data-to-a-reference-genome-and-associated-steps.html"><a href="alignment-of-sequence-data-to-a-reference-genome-and-associated-steps.html#hold-it-right-there-buddy-what-about-the-read-groups"><i class="fa fa-check"></i><b>19.3.3</b> Hold it Right There, Buddy! What about the Read Groups?</a></li>
</ul></li>
<li class="chapter" data-level="19.4" data-path="alignment-of-sequence-data-to-a-reference-genome-and-associated-steps.html"><a href="alignment-of-sequence-data-to-a-reference-genome-and-associated-steps.html#samtools"><i class="fa fa-check"></i><b>19.4</b> Processing alignment output with <code>samtools</code></a>
<ul>
<li class="chapter" data-level="19.4.1" data-path="alignment-of-sequence-data-to-a-reference-genome-and-associated-steps.html"><a href="alignment-of-sequence-data-to-a-reference-genome-and-associated-steps.html#samtools-subcommands"><i class="fa fa-check"></i><b>19.4.1</b> <code>samtools</code> subcommands</a></li>
</ul></li>
<li class="chapter" data-level="19.5" data-path="alignment-of-sequence-data-to-a-reference-genome-and-associated-steps.html"><a href="alignment-of-sequence-data-to-a-reference-genome-and-associated-steps.html#boneyard-below-here"><i class="fa fa-check"></i><b>19.5</b> BONEYARD BELOW HERE</a></li>
<li class="chapter" data-level="19.6" data-path="alignment-of-sequence-data-to-a-reference-genome-and-associated-steps.html"><a href="alignment-of-sequence-data-to-a-reference-genome-and-associated-steps.html#preprocess"><i class="fa fa-check"></i><b>19.6</b> Preprocess ?</a></li>
<li class="chapter" data-level="19.7" data-path="alignment-of-sequence-data-to-a-reference-genome-and-associated-steps.html"><a href="alignment-of-sequence-data-to-a-reference-genome-and-associated-steps.html#quick-notes-to-self-on-chaining-things"><i class="fa fa-check"></i><b>19.7</b> Quick notes to self on chaining things:</a></li>
<li class="chapter" data-level="19.8" data-path="alignment-of-sequence-data-to-a-reference-genome-and-associated-steps.html"><a href="alignment-of-sequence-data-to-a-reference-genome-and-associated-steps.html#merging-bam-files"><i class="fa fa-check"></i><b>19.8</b> Merging BAM files</a></li>
<li class="chapter" data-level="19.9" data-path="alignment-of-sequence-data-to-a-reference-genome-and-associated-steps.html"><a href="alignment-of-sequence-data-to-a-reference-genome-and-associated-steps.html#divide-and-conquer-strategies"><i class="fa fa-check"></i><b>19.9</b> Divide and Conquer Strategies</a></li>
</ul></li>
<li class="chapter" data-level="20" data-path="variant-calling.html"><a href="variant-calling.html"><i class="fa fa-check"></i><b>20</b> Variant calling</a>
<ul>
<li class="chapter" data-level="20.1" data-path="variant-calling.html"><a href="variant-calling.html#genotype-likelihoods"><i class="fa fa-check"></i><b>20.1</b> Genotype Likelihoods</a>
<ul>
<li class="chapter" data-level="20.1.1" data-path="variant-calling.html"><a href="variant-calling.html#basic-sketch-of-genotype-likelihood-calculations"><i class="fa fa-check"></i><b>20.1.1</b> Basic Sketch of Genotype Likelihood Calculations</a></li>
<li class="chapter" data-level="20.1.2" data-path="variant-calling.html"><a href="variant-calling.html#specifics-of-different-genotype-likelihoods"><i class="fa fa-check"></i><b>20.1.2</b> Specifics of different genotype likelihoods</a></li>
<li class="chapter" data-level="20.1.3" data-path="variant-calling.html"><a href="variant-calling.html#computing-genotype-likelihoods-with-three-different-softwares"><i class="fa fa-check"></i><b>20.1.3</b> Computing genotype likelihoods with three different softwares</a></li>
<li class="chapter" data-level="20.1.4" data-path="variant-calling.html"><a href="variant-calling.html#a-directed-acyclic-graph-for-genotype-likelihoods"><i class="fa fa-check"></i><b>20.1.4</b> A Directed Acyclic Graph For Genotype Likelihoods</a></li>
</ul></li>
<li class="chapter" data-level="20.2" data-path="variant-calling.html"><a href="variant-calling.html#gatks-gvcf-workflow"><i class="fa fa-check"></i><b>20.2</b> GATK’s gVCF Workflow</a>
<ul>
<li class="chapter" data-level="20.2.1" data-path="variant-calling.html"><a href="variant-calling.html#step-1.-running-haplotypecaller-and-getting-one-gvcf-for-each-sample"><i class="fa fa-check"></i><b>20.2.1</b> Step 1. Running HaplotypeCaller and getting one gVCF for each sample</a></li>
<li class="chapter" data-level="20.2.2" data-path="variant-calling.html"><a href="variant-calling.html#gvcf-format"><i class="fa fa-check"></i><b>20.2.2</b> gVCF files</a></li>
<li class="chapter" data-level="20.2.3" data-path="variant-calling.html"><a href="variant-calling.html#genomics-db"><i class="fa fa-check"></i><b>20.2.3</b> The Genomics Data Base</a></li>
<li class="chapter" data-level="20.2.4" data-path="variant-calling.html"><a href="variant-calling.html#gdb-update"><i class="fa fa-check"></i><b>20.2.4</b> Updating the GenomicsDatabase</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="21" data-path="boneyard-1.html"><a href="boneyard-1.html"><i class="fa fa-check"></i><b>21</b> Boneyard</a></li>
<li class="chapter" data-level="22" data-path="handle-vcf.html"><a href="handle-vcf.html"><i class="fa fa-check"></i><b>22</b> Basic Handling of VCF files</a>
<ul>
<li class="chapter" data-level="22.1" data-path="handle-vcf.html"><a href="handle-vcf.html#bcftools"><i class="fa fa-check"></i><b>22.1</b> bcftools</a>
<ul>
<li class="chapter" data-level="22.1.1" data-path="handle-vcf.html"><a href="handle-vcf.html#index-my-vcf-file"><i class="fa fa-check"></i><b>22.1.1</b> Index my VCF file!</a></li>
<li class="chapter" data-level="22.1.2" data-path="handle-vcf.html"><a href="handle-vcf.html#tell-me-about-my-vcf-file"><i class="fa fa-check"></i><b>22.1.2</b> Tell me about my VCF file!</a></li>
<li class="chapter" data-level="22.1.3" data-path="handle-vcf.html"><a href="handle-vcf.html#rename-the-samplesindividuals-in-the-file"><i class="fa fa-check"></i><b>22.1.3</b> Rename the samples/individuals in the file</a></li>
<li class="chapter" data-level="22.1.4" data-path="handle-vcf.html"><a href="handle-vcf.html#get-fragmentsparts-of-my-vcf-file"><i class="fa fa-check"></i><b>22.1.4</b> Get fragments/parts of my VCF file</a></li>
<li class="chapter" data-level="22.1.5" data-path="handle-vcf.html"><a href="handle-vcf.html#combine-vcf-files-in-various-ways"><i class="fa fa-check"></i><b>22.1.5</b> Combine VCF files in various ways</a></li>
<li class="chapter" data-level="22.1.6" data-path="handle-vcf.html"><a href="handle-vcf.html#filter-out-variants-for-a-variety-of-reasons"><i class="fa fa-check"></i><b>22.1.6</b> Filter out variants for a variety of reasons</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="23" data-path="bioinformatics-for-rad-seq-data-with-and-without-a-reference-genome.html"><a href="bioinformatics-for-rad-seq-data-with-and-without-a-reference-genome.html"><i class="fa fa-check"></i><b>23</b> Bioinformatics for RAD seq data with and without a reference genome</a></li>
<li class="chapter" data-level="24" data-path="processing-amplicon-sequencing-data.html"><a href="processing-amplicon-sequencing-data.html"><i class="fa fa-check"></i><b>24</b> Processing amplicon sequencing data</a></li>
<li class="chapter" data-level="25" data-path="genome-annotation.html"><a href="genome-annotation.html"><i class="fa fa-check"></i><b>25</b> Genome Annotation</a></li>
<li class="chapter" data-level="26" data-path="whole-genome-alignment-strategies.html"><a href="whole-genome-alignment-strategies.html"><i class="fa fa-check"></i><b>26</b> Whole genome alignment strategies</a>
<ul>
<li class="chapter" data-level="26.1" data-path="whole-genome-alignment-strategies.html"><a href="whole-genome-alignment-strategies.html#mapping-of-scaffolds-to-a-closely-related-genome"><i class="fa fa-check"></i><b>26.1</b> Mapping of scaffolds to a closely related genome</a></li>
<li class="chapter" data-level="26.2" data-path="whole-genome-alignment-strategies.html"><a href="whole-genome-alignment-strategies.html#obtaining-ancestral-states-from-an-outgroup-genome"><i class="fa fa-check"></i><b>26.2</b> Obtaining Ancestral States from an Outgroup Genome</a>
<ul>
<li class="chapter" data-level="26.2.1" data-path="whole-genome-alignment-strategies.html"><a href="whole-genome-alignment-strategies.html#using-lastz-to-align-coho-to-the-chinook-genome"><i class="fa fa-check"></i><b>26.2.1</b> Using LASTZ to align coho to the chinook genome</a></li>
<li class="chapter" data-level="26.2.2" data-path="whole-genome-alignment-strategies.html"><a href="whole-genome-alignment-strategies.html#try-on-the-chinook-chromosomes"><i class="fa fa-check"></i><b>26.2.2</b> Try on the chinook chromosomes</a></li>
<li class="chapter" data-level="26.2.3" data-path="whole-genome-alignment-strategies.html"><a href="whole-genome-alignment-strategies.html#explore-the-other-parameters-more"><i class="fa fa-check"></i><b>26.2.3</b> Explore the other parameters more</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="27" data-path="example-wgs-flow.html"><a href="example-wgs-flow.html"><i class="fa fa-check"></i><b>27</b> An example full workflow from sequences to variants</a>
<ul>
<li class="chapter" data-level="27.1" data-path="example-wgs-flow.html"><a href="example-wgs-flow.html#an-overview-of-the-whole-workflow"><i class="fa fa-check"></i><b>27.1</b> An overview of the whole workflow</a></li>
<li class="chapter" data-level="27.2" data-path="example-wgs-flow.html"><a href="example-wgs-flow.html#lets-have-a-look-at-the-reference-genome"><i class="fa fa-check"></i><b>27.2</b> Let’s have a look at the reference genome</a>
<ul>
<li class="chapter" data-level="27.2.1" data-path="example-wgs-flow.html"><a href="example-wgs-flow.html#first-off-make-sure-that-you-have-added-mamba-to-your-base-environment"><i class="fa fa-check"></i><b>27.2.1</b> First off, make sure that you have added mamba to your base environment</a></li>
<li class="chapter" data-level="27.2.2" data-path="example-wgs-flow.html"><a href="example-wgs-flow.html#indexing-the-reference-genome"><i class="fa fa-check"></i><b>27.2.2</b> Indexing the reference genome</a></li>
</ul></li>
<li class="chapter" data-level="27.3" data-path="example-wgs-flow.html"><a href="example-wgs-flow.html#a-word-on-organizing-workflows"><i class="fa fa-check"></i><b>27.3</b> A word on organizing workflows</a></li>
<li class="chapter" data-level="27.4" data-path="example-wgs-flow.html"><a href="example-wgs-flow.html#step-1a.-quality-checking-the-reads"><i class="fa fa-check"></i><b>27.4</b> Step 1a. Quality Checking the Reads</a>
<ul>
<li class="chapter" data-level="27.4.1" data-path="example-wgs-flow.html"><a href="example-wgs-flow.html#a-little-looking-at-the-htmls"><i class="fa fa-check"></i><b>27.4.1</b> A Little Looking at the HTMLs</a></li>
<li class="chapter" data-level="27.4.2" data-path="example-wgs-flow.html"><a href="example-wgs-flow.html#summarizing-output-from-a-lot-of-different-files-with-multiqc"><i class="fa fa-check"></i><b>27.4.2</b> Summarizing output from a lot of different files with MultiQC</a></li>
</ul></li>
<li class="chapter" data-level="27.5" data-path="example-wgs-flow.html"><a href="example-wgs-flow.html#step-1b.-trimming-the-reads"><i class="fa fa-check"></i><b>27.5</b> Step 1b. Trimming the Reads</a>
<ul>
<li class="chapter" data-level="27.5.1" data-path="example-wgs-flow.html"><a href="example-wgs-flow.html#cycling-over-all-the-files-and-trimming-them"><i class="fa fa-check"></i><b>27.5.1</b> Cycling over all the files and trimming them</a></li>
<li class="chapter" data-level="27.5.2" data-path="example-wgs-flow.html"><a href="example-wgs-flow.html#multiqc-your-trimmomatics-results"><i class="fa fa-check"></i><b>27.5.2</b> Multiqc your trimmomatics results</a></li>
</ul></li>
<li class="chapter" data-level="27.6" data-path="example-wgs-flow.html"><a href="example-wgs-flow.html#step-2.-mapping-each-unit-to-the-genome"><i class="fa fa-check"></i><b>27.6</b> Step 2. Mapping each unit to the genome</a>
<ul>
<li class="chapter" data-level="27.6.1" data-path="example-wgs-flow.html"><a href="example-wgs-flow.html#indexing-the-reference-genome-1"><i class="fa fa-check"></i><b>27.6.1</b> Indexing the reference genome</a></li>
<li class="chapter" data-level="27.6.2" data-path="example-wgs-flow.html"><a href="example-wgs-flow.html#a-quick-mapping-run-to-stdout"><i class="fa fa-check"></i><b>27.6.2</b> A quick mapping run to stdout</a></li>
<li class="chapter" data-level="27.6.3" data-path="example-wgs-flow.html"><a href="example-wgs-flow.html#map-with-array"><i class="fa fa-check"></i><b>27.6.3</b> Mapping all 22 pairs of trimmed FASTQ files using a SLURM job array</a></li>
</ul></li>
<li class="chapter" data-level="27.7" data-path="example-wgs-flow.html"><a href="example-wgs-flow.html#step-3.-mark-duplicates-in-bam-files-from-each-individual-and-run-samtools-stats-on-the-results"><i class="fa fa-check"></i><b>27.7</b> Step 3. Mark duplicates in BAM files from each individual, and run <code>samtools stats</code> on the results</a>
<ul>
<li class="chapter" data-level="27.7.1" data-path="example-wgs-flow.html"><a href="example-wgs-flow.html#run-samtools-stats-on-the-results"><i class="fa fa-check"></i><b>27.7.1</b> Run samtools stats on the results</a></li>
</ul></li>
<li class="chapter" data-level="27.8" data-path="example-wgs-flow.html"><a href="example-wgs-flow.html#make-gvcfs"><i class="fa fa-check"></i><b>27.8</b> Step 4. Creating a gVCF file for each sample</a>
<ul>
<li class="chapter" data-level="27.8.1" data-path="example-wgs-flow.html"><a href="example-wgs-flow.html#thats-a-dict-thing-to-do"><i class="fa fa-check"></i><b>27.8.1</b> That’s a dict thing to do!</a></li>
<li class="chapter" data-level="27.8.2" data-path="example-wgs-flow.html"><a href="example-wgs-flow.html#setting-up-a-slurm-job-array-for-this"><i class="fa fa-check"></i><b>27.8.2</b> Setting up a SLURM job array for this</a></li>
<li class="chapter" data-level="27.8.3" data-path="example-wgs-flow.html"><a href="example-wgs-flow.html#running-interactively-to-watch-the-output"><i class="fa fa-check"></i><b>27.8.3</b> Running interactively to watch the output</a></li>
<li class="chapter" data-level="27.8.4" data-path="example-wgs-flow.html"><a href="example-wgs-flow.html#launch-the-first-3-jobs-of-our-array"><i class="fa fa-check"></i><b>27.8.4</b> Launch the first 3 jobs of our array</a></li>
</ul></li>
<li class="chapter" data-level="27.9" data-path="example-wgs-flow.html"><a href="example-wgs-flow.html#use-genomicsdbimport"><i class="fa fa-check"></i><b>27.9</b> Step 5. Importing the gVCF files into a GenomicsDatabase</a>
<ul>
<li class="chapter" data-level="27.9.1" data-path="example-wgs-flow.html"><a href="example-wgs-flow.html#job-array-script-for-the-chromosomes"><i class="fa fa-check"></i><b>27.9.1</b> Job array script for the chromosomes</a></li>
<li class="chapter" data-level="27.9.2" data-path="example-wgs-flow.html"><a href="example-wgs-flow.html#job-array-script-for-the-scaffold-groups"><i class="fa fa-check"></i><b>27.9.2</b> Job array script for the scaffold groups</a></li>
<li class="chapter" data-level="27.9.3" data-path="example-wgs-flow.html"><a href="example-wgs-flow.html#hey-lets-try-updating-the-genomic-data-base"><i class="fa fa-check"></i><b>27.9.3</b> Hey! Let’s try updating the genomic data base</a></li>
</ul></li>
<li class="chapter" data-level="27.10" data-path="example-wgs-flow.html"><a href="example-wgs-flow.html#step-6.-calling-variants-and-creating-vcf-files-from-the-genomicsdatabase"><i class="fa fa-check"></i><b>27.10</b> Step 6. Calling variants and creating VCF files from the GenomicsDatabase</a>
<ul>
<li class="chapter" data-level="27.10.1" data-path="example-wgs-flow.html"><a href="example-wgs-flow.html#array-script-for-the-four-chromosomes"><i class="fa fa-check"></i><b>27.10.1</b> Array script for the four chromosomes</a></li>
<li class="chapter" data-level="27.10.2" data-path="example-wgs-flow.html"><a href="example-wgs-flow.html#array-script-for-the-two-scaffold-groups"><i class="fa fa-check"></i><b>27.10.2</b> Array script for the two scaffold groups</a></li>
<li class="chapter" data-level="27.10.3" data-path="example-wgs-flow.html"><a href="example-wgs-flow.html#have-a-look-at-the-products"><i class="fa fa-check"></i><b>27.10.3</b> Have a look at the products</a></li>
<li class="chapter" data-level="27.10.4" data-path="example-wgs-flow.html"><a href="example-wgs-flow.html#homework"><i class="fa fa-check"></i><b>27.10.4</b> Homework</a></li>
<li class="chapter" data-level="27.10.5" data-path="example-wgs-flow.html"><a href="example-wgs-flow.html#catenate-all-the-vcf.gz-files-into-a-single-vcf-file-and-index-it"><i class="fa fa-check"></i><b>27.10.5</b> Catenate all the vcf.gz files into a single VCF file and index it</a></li>
</ul></li>
<li class="chapter" data-level="27.11" data-path="example-wgs-flow.html"><a href="example-wgs-flow.html#step-7.-filtering-variants"><i class="fa fa-check"></i><b>27.11</b> Step 7. Filtering variants</a></li>
<li class="chapter" data-level="27.12" data-path="example-wgs-flow.html"><a href="example-wgs-flow.html#step-8.-base-quality-score-recalibration"><i class="fa fa-check"></i><b>27.12</b> Step 8. Base Quality Score Recalibration</a></li>
</ul></li>
<li class="part"><span><b>IV Part IV: Analysis of Big Variant Data</b></span></li>
<li class="chapter" data-level="28" data-path="bioinformatic-analysis-on-variant-data.html"><a href="bioinformatic-analysis-on-variant-data.html"><i class="fa fa-check"></i><b>28</b> Bioinformatic analysis on variant data</a></li>
<li class="part"><span><b>V Part V: Population Genomics</b></span></li>
<li class="chapter" data-level="29" data-path="topics-in-pop-gen.html"><a href="topics-in-pop-gen.html"><i class="fa fa-check"></i><b>29</b> Topics in pop gen</a>
<ul>
<li class="chapter" data-level="29.1" data-path="topics-in-pop-gen.html"><a href="topics-in-pop-gen.html#coalescent"><i class="fa fa-check"></i><b>29.1</b> Coalescent</a></li>
<li class="chapter" data-level="29.2" data-path="topics-in-pop-gen.html"><a href="topics-in-pop-gen.html#measures-of-genetic-diversity-and-such"><i class="fa fa-check"></i><b>29.2</b> Measures of genetic diversity and such</a></li>
<li class="chapter" data-level="29.3" data-path="topics-in-pop-gen.html"><a href="topics-in-pop-gen.html#demographic-inference-with-partial-a-partial-i-and-moments"><i class="fa fa-check"></i><b>29.3</b> Demographic inference with <span class="math inline">\(\partial a \partial i\)</span> and <em>moments</em></a></li>
<li class="chapter" data-level="29.4" data-path="topics-in-pop-gen.html"><a href="topics-in-pop-gen.html#balls-in-boxes"><i class="fa fa-check"></i><b>29.4</b> Balls in Boxes</a></li>
<li class="chapter" data-level="29.5" data-path="topics-in-pop-gen.html"><a href="topics-in-pop-gen.html#some-landscape-genetics"><i class="fa fa-check"></i><b>29.5</b> Some landscape genetics</a></li>
<li class="chapter" data-level="29.6" data-path="topics-in-pop-gen.html"><a href="topics-in-pop-gen.html#relationship-inference"><i class="fa fa-check"></i><b>29.6</b> Relationship Inference</a></li>
<li class="chapter" data-level="29.7" data-path="topics-in-pop-gen.html"><a href="topics-in-pop-gen.html#tests-for-selection"><i class="fa fa-check"></i><b>29.7</b> Tests for Selection</a></li>
<li class="chapter" data-level="29.8" data-path="topics-in-pop-gen.html"><a href="topics-in-pop-gen.html#multivariate-associations-gea-etc."><i class="fa fa-check"></i><b>29.8</b> Multivariate Associations, GEA, etc.</a></li>
<li class="chapter" data-level="29.9" data-path="topics-in-pop-gen.html"><a href="topics-in-pop-gen.html#estimating-heritability-in-the-wild"><i class="fa fa-check"></i><b>29.9</b> Estimating heritability in the wild</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references-1.html"><a href="references-1.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://bookdown.org" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Practical Computing and Bioinformatics for Conservation and Evolutionary Genomics</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="example-wgs-flow" class="section level1" number="27">
<h1><span class="header-section-number">Chapter 27</span> An example full workflow from sequences to variants</h1>
<p>The purpose of this chapter is to present an accessible example workflow
showing all the steps of taking raw sequences in FASTQ files through to
variants in VCF files. It assumes that some sort of reference genome is
available already (be it a chromosome-level assembly or just a scaffold-level
assembly). The workflow shown here is based on the
GATK “Best Practices,” with some modifications to make the workflow
reasonable for non-model organisms that lack many of the genomic resources
expected by the authors of the GATK “Best Practices” (like files of
known variation in the species, etc.)</p>
<p>As an example data set we have created a
small version of a typical NGS data set.
The original data set included 384 Chinook salmon from the Yukon River
basin, sequenced across 4 lanes of an Illumina NovaSeq machine. To create
the subsetted data set, we extracted just the reads that map to a small part
(about 10 megabases from each of four chromosomes, and then a variety of
shorter scaffolds)
of the latest (as of 2022) reference genome (<a href="https://www.ncbi.nlm.nih.gov/assembly/GCF_018296145.1">Otsh_v2.0</a>).
for Chinook salmon. And we included data from only 8 of the 384
individual fish.</p>
<p>Included in the data set is a reference genome that has been downsized similarly,
to include only those portions of the genome from which we extracted the
read from those 8 fish.</p>
<p>Finally, the reads from different individuals were massaged to make it appear that some
individuals were sequenced on multiple lanes or flow cells and so that some individuals
underwent several different library preps. This is an important feature to ensure that
we learn how to properly deal with sequencing of individual libraries across multiple
lanes when marking PCR duplicates.</p>
<p>The data set is available publicly as a .tar file at this link:
<a href="https://drive.google.com/file/d/1LMK-DCkH1RKFAWTR2OKEJ_K9VOjJIZ1b/view?usp=sharing">https://drive.google.com/file/d/1LMK-DCkH1RKFAWTR2OKEJ_K9VOjJIZ1b/view?usp=sharing</a>. If you view that site on a browser you can choose to download the file.</p>
<p>Downloading the file to a Linux server can be done using <code>wget</code> on the command line. Because the file
is large, a little bit of extra trickery is required to download it. This (rather complex) command line
should work:</p>
<div class="sourceCode" id="cb689"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb689-1"><a href="example-wgs-flow.html#cb689-1" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> <span class="at">--load-cookies</span> /tmp/cookies.txt <span class="st">&quot;https://docs.google.com/uc?export=download&amp;confirm=</span><span class="va">$(</span><span class="fu">wget</span> <span class="at">--quiet</span> <span class="at">--save-cookies</span> /tmp/cookies.txt <span class="at">--keep-session-cookies</span> <span class="at">--no-check-certificate</span> <span class="st">&#39;https://docs.google.com/uc?export=download&amp;id=1LMK-DCkH1RKFAWTR2OKEJ_K9VOjJIZ1b&#39;</span> <span class="at">-O-</span> <span class="kw">|</span> <span class="fu">sed</span> <span class="at">-rn</span> <span class="st">&#39;s/.*confirm=([0-9A-Za-z_]+).*/\1\n/p&#39;</span><span class="va">)</span><span class="st">&amp;id=1LMK-DCkH1RKFAWTR2OKEJ_K9VOjJIZ1b&quot;</span> <span class="at">-O</span> non-model-wgs-example-data.tar <span class="kw">&amp;&amp;</span> <span class="fu">rm</span> <span class="at">-rf</span> /tmp/cookies.txt</span></code></pre></div>
<p>Once the file <code>non-model-wgs-example-data.tar</code> is downloaded, that .tar archive can be untarred with</p>
<div class="sourceCode" id="cb690"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb690-1"><a href="example-wgs-flow.html#cb690-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar</span> <span class="at">-xvf</span> non-model-wgs-example-data.tar</span></code></pre></div>
<p>That will create the directory <code>non-model-wgs-example-data</code>, which contains all the files.</p>
<p>The contents of that directory look like this (in a <code>tree</code> view):</p>
<pre><code>non-model-wgs-example-data
├── README.Rmd
├── README.nb.html
├── data
│   └── messy_names
│       └── fastqs
│           ├── T199967_T2087_HY75HDSX2_L001_R1_001.fastq.gz
│           ├── T199967_T2087_HY75HDSX2_L001_R2_001.fastq.gz
│           ├── T199968_T2087_HY75HDSX2_L001_R1_001.fastq.gz
│           ├── T199968_T2087_HY75HDSX2_L001_R2_001.fastq.gz
│           ├── T199968_T2087_HY75HDSX2_L002_R1_001.fastq.gz
│           ├── T199968_T2087_HY75HDSX2_L002_R2_001.fastq.gz
│           ├── T199969_T2087_HTYYCBBXX_L002_R1_001.fastq.gz
│           ├── T199969_T2087_HTYYCBBXX_L002_R2_001.fastq.gz
│           ├── T199969_T2087_HY75HDSX2_L002_R1_001.fastq.gz
│           ├── T199969_T2087_HY75HDSX2_L002_R2_001.fastq.gz
│           ├── T199969_T2087_HY75HDSX2_L003_R1_001.fastq.gz
│           ├── T199969_T2087_HY75HDSX2_L003_R2_001.fastq.gz
│           ├── T199970_T2087_HY75HDSX2_L003_R1_001.fastq.gz
│           ├── T199970_T2087_HY75HDSX2_L003_R2_001.fastq.gz
│           ├── T199970_T2094_HY75HDSX2_L004_R1_001.fastq.gz
│           ├── T199970_T2094_HY75HDSX2_L004_R2_001.fastq.gz
│           ├── T199971_T2087_HY75HDSX2_L002_R1_001.fastq.gz
│           ├── T199971_T2087_HY75HDSX2_L002_R2_001.fastq.gz
│           ├── T199971_T2087_HY75HDSX2_L004_R1_001.fastq.gz
│           ├── T199971_T2087_HY75HDSX2_L004_R2_001.fastq.gz
│           ├── T199971_T2099_HTYYCBBXX_L002_R1_001.fastq.gz
│           ├── T199971_T2099_HTYYCBBXX_L002_R2_001.fastq.gz
│           ├── T199972_T2087_HTYYCBBXX_L003_R1_001.fastq.gz
│           ├── T199972_T2087_HTYYCBBXX_L003_R2_001.fastq.gz
│           ├── T199972_T2087_HY75HDSX2_L001_R1_001.fastq.gz
│           ├── T199972_T2087_HY75HDSX2_L001_R2_001.fastq.gz
│           ├── T199972_T2094_HTYYCBBXX_L004_R1_001.fastq.gz
│           ├── T199972_T2094_HTYYCBBXX_L004_R2_001.fastq.gz
│           ├── T199972_T2094_HY75HDSX2_L002_R1_001.fastq.gz
│           ├── T199972_T2094_HY75HDSX2_L002_R2_001.fastq.gz
│           ├── T199973_T2087_HY75HDSX2_L002_R1_001.fastq.gz
│           ├── T199973_T2087_HY75HDSX2_L002_R2_001.fastq.gz
│           ├── T199973_T2087_HY75HDSX2_L003_R1_001.fastq.gz
│           ├── T199973_T2087_HY75HDSX2_L003_R2_001.fastq.gz
│           ├── T199973_T2094_HY75HDSX2_L002_R1_001.fastq.gz
│           ├── T199973_T2094_HY75HDSX2_L002_R2_001.fastq.gz
│           ├── T199973_T2094_HY75HDSX2_L003_R1_001.fastq.gz
│           ├── T199973_T2094_HY75HDSX2_L003_R2_001.fastq.gz
│           ├── T199974_T2087_HY75HDSX2_L001_R1_001.fastq.gz
│           ├── T199974_T2087_HY75HDSX2_L001_R2_001.fastq.gz
│           ├── T199974_T2094_HY75HDSX2_L001_R1_001.fastq.gz
│           ├── T199974_T2094_HY75HDSX2_L001_R2_001.fastq.gz
│           ├── T199974_T2099_HY75HDSX2_L001_R1_001.fastq.gz
│           └── T199974_T2099_HY75HDSX2_L001_R2_001.fastq.gz
├── fastq
│   ├── s001---1_R1.fq.gz -&gt; ../data/messy_names/fastqs/T199967_T2087_HY75HDSX2_L001_R1_001.fastq.gz
│   ├── s001---1_R2.fq.gz -&gt; ../data/messy_names/fastqs/T199967_T2087_HY75HDSX2_L001_R2_001.fastq.gz
│   ├── s002---1_R1.fq.gz -&gt; ../data/messy_names/fastqs/T199968_T2087_HY75HDSX2_L001_R1_001.fastq.gz
│   ├── s002---1_R2.fq.gz -&gt; ../data/messy_names/fastqs/T199968_T2087_HY75HDSX2_L001_R2_001.fastq.gz
│   ├── s002---2_R1.fq.gz -&gt; ../data/messy_names/fastqs/T199968_T2087_HY75HDSX2_L002_R1_001.fastq.gz
│   ├── s002---2_R2.fq.gz -&gt; ../data/messy_names/fastqs/T199968_T2087_HY75HDSX2_L002_R2_001.fastq.gz
│   ├── s003---1_R1.fq.gz -&gt; ../data/messy_names/fastqs/T199969_T2087_HY75HDSX2_L002_R1_001.fastq.gz
│   ├── s003---1_R2.fq.gz -&gt; ../data/messy_names/fastqs/T199969_T2087_HY75HDSX2_L002_R2_001.fastq.gz
│   ├── s003---2_R1.fq.gz -&gt; ../data/messy_names/fastqs/T199969_T2087_HY75HDSX2_L003_R1_001.fastq.gz
│   ├── s003---2_R2.fq.gz -&gt; ../data/messy_names/fastqs/T199969_T2087_HY75HDSX2_L003_R2_001.fastq.gz
│   ├── s003---3_R1.fq.gz -&gt; ../data/messy_names/fastqs/T199969_T2087_HTYYCBBXX_L002_R1_001.fastq.gz
│   ├── s003---3_R2.fq.gz -&gt; ../data/messy_names/fastqs/T199969_T2087_HTYYCBBXX_L002_R2_001.fastq.gz
│   ├── s004---1_R1.fq.gz -&gt; ../data/messy_names/fastqs/T199970_T2087_HY75HDSX2_L003_R1_001.fastq.gz
│   ├── s004---1_R2.fq.gz -&gt; ../data/messy_names/fastqs/T199970_T2087_HY75HDSX2_L003_R2_001.fastq.gz
│   ├── s004---2_R1.fq.gz -&gt; ../data/messy_names/fastqs/T199970_T2094_HY75HDSX2_L004_R1_001.fastq.gz
│   ├── s004---2_R2.fq.gz -&gt; ../data/messy_names/fastqs/T199970_T2094_HY75HDSX2_L004_R2_001.fastq.gz
│   ├── s005---1_R1.fq.gz -&gt; ../data/messy_names/fastqs/T199971_T2087_HY75HDSX2_L002_R1_001.fastq.gz
│   ├── s005---1_R2.fq.gz -&gt; ../data/messy_names/fastqs/T199971_T2087_HY75HDSX2_L002_R2_001.fastq.gz
│   ├── s005---2_R1.fq.gz -&gt; ../data/messy_names/fastqs/T199971_T2087_HY75HDSX2_L004_R1_001.fastq.gz
│   ├── s005---2_R2.fq.gz -&gt; ../data/messy_names/fastqs/T199971_T2087_HY75HDSX2_L004_R2_001.fastq.gz
│   ├── s005---3_R1.fq.gz -&gt; ../data/messy_names/fastqs/T199971_T2099_HTYYCBBXX_L002_R1_001.fastq.gz
│   ├── s005---3_R2.fq.gz -&gt; ../data/messy_names/fastqs/T199971_T2099_HTYYCBBXX_L002_R2_001.fastq.gz
│   ├── s006---1_R1.fq.gz -&gt; ../data/messy_names/fastqs/T199972_T2087_HY75HDSX2_L001_R1_001.fastq.gz
│   ├── s006---1_R2.fq.gz -&gt; ../data/messy_names/fastqs/T199972_T2087_HY75HDSX2_L001_R2_001.fastq.gz
│   ├── s006---2_R1.fq.gz -&gt; ../data/messy_names/fastqs/T199972_T2087_HTYYCBBXX_L003_R1_001.fastq.gz
│   ├── s006---2_R2.fq.gz -&gt; ../data/messy_names/fastqs/T199972_T2087_HTYYCBBXX_L003_R2_001.fastq.gz
│   ├── s006---3_R1.fq.gz -&gt; ../data/messy_names/fastqs/T199972_T2094_HY75HDSX2_L002_R1_001.fastq.gz
│   ├── s006---3_R2.fq.gz -&gt; ../data/messy_names/fastqs/T199972_T2094_HY75HDSX2_L002_R2_001.fastq.gz
│   ├── s006---4_R1.fq.gz -&gt; ../data/messy_names/fastqs/T199972_T2094_HTYYCBBXX_L004_R1_001.fastq.gz
│   ├── s006---4_R2.fq.gz -&gt; ../data/messy_names/fastqs/T199972_T2094_HTYYCBBXX_L004_R2_001.fastq.gz
│   ├── s007---1_R1.fq.gz -&gt; ../data/messy_names/fastqs/T199973_T2087_HY75HDSX2_L002_R1_001.fastq.gz
│   ├── s007---1_R2.fq.gz -&gt; ../data/messy_names/fastqs/T199973_T2087_HY75HDSX2_L002_R2_001.fastq.gz
│   ├── s007---2_R1.fq.gz -&gt; ../data/messy_names/fastqs/T199973_T2087_HY75HDSX2_L003_R1_001.fastq.gz
│   ├── s007---2_R2.fq.gz -&gt; ../data/messy_names/fastqs/T199973_T2087_HY75HDSX2_L003_R2_001.fastq.gz
│   ├── s007---3_R1.fq.gz -&gt; ../data/messy_names/fastqs/T199973_T2094_HY75HDSX2_L002_R1_001.fastq.gz
│   ├── s007---3_R2.fq.gz -&gt; ../data/messy_names/fastqs/T199973_T2094_HY75HDSX2_L002_R2_001.fastq.gz
│   ├── s007---4_R1.fq.gz -&gt; ../data/messy_names/fastqs/T199973_T2094_HY75HDSX2_L003_R1_001.fastq.gz
│   ├── s007---4_R2.fq.gz -&gt; ../data/messy_names/fastqs/T199973_T2094_HY75HDSX2_L003_R2_001.fastq.gz
│   ├── s008---1_R1.fq.gz -&gt; ../data/messy_names/fastqs/T199974_T2087_HY75HDSX2_L001_R1_001.fastq.gz
│   ├── s008---1_R2.fq.gz -&gt; ../data/messy_names/fastqs/T199974_T2087_HY75HDSX2_L001_R2_001.fastq.gz
│   ├── s008---2_R1.fq.gz -&gt; ../data/messy_names/fastqs/T199974_T2094_HY75HDSX2_L001_R1_001.fastq.gz
│   ├── s008---2_R2.fq.gz -&gt; ../data/messy_names/fastqs/T199974_T2094_HY75HDSX2_L001_R2_001.fastq.gz
│   ├── s008---3_R1.fq.gz -&gt; ../data/messy_names/fastqs/T199974_T2099_HY75HDSX2_L001_R1_001.fastq.gz
│   └── s008---3_R2.fq.gz -&gt; ../data/messy_names/fastqs/T199974_T2099_HY75HDSX2_L001_R2_001.fastq.gz
├── resources
│   └── genome.fasta
├── samples.tsv
└── units.tsv</code></pre>
<ul>
<li>The README.* files give some background on how this data set was whittled out of the
larger, complete data set.</li>
<li>The directory <code>data/messy_names/fastqs</code>, contains all the FASTQ files as they might appear
after downloading from the sequencing center. Characteristic of such files, they all
have rather daunting names.</li>
<li>The directory <code>fastq</code> at the top level of the directory contains symbolic
links to the big files with messy names. These are there simply to provide
students a simpler variety of names of files to deal with when doing the initial
steps of a sequencing exercise. But, ultimately, we will explore ways of directly
addressing the files with more complex names.</li>
<li>The file <code>samples.tsv</code> just contains all the unique “tidy” sample names
(like <code>s001</code>, <code>s002</code>, etc.) in a single column named <code>sample</code>.</li>
<li>The file <code>units.tsv</code> contains crucial information about all the different pairs
of FASTQ files. Each pair is considered a separate “unit” of one of the samples.<br />
Some of the information in the file pertains to which flowcell and lane the sample-unit was
sequenced on, as well as which library the sample-unit was prepared in.
All of this relates to the “journey” that was taken by each little piece of DNA
that was sequenced (Section <a href="alignment-of-sequence-data-to-a-reference-genome-and-associated-steps.html#read-journey">19.1</a>). It is worth having a look at the file.</li>
<li>The file <code>resources/genome.fasta</code> contains the “genome” for this exercise.</li>
</ul>
<p>For information about FASTQ and FASTA files see Sections <a href="bioinformatic-file-formats.html#fastq">17.2</a> and <a href="bioinformatic-file-formats.html#fasta">17.3</a>.</p>
<div id="an-overview-of-the-whole-workflow" class="section level2" number="27.1">
<h2><span class="header-section-number">27.1</span> An overview of the whole workflow</h2>
We provide here a simple(ish) flow diagram that shows the different steps/jobs in this
workflow that have to be done. The diagram is made from a Snakemake workflow (see Chapter
<a href="snakemake-chap.html#snakemake-chap">14</a>) that Eric has implemented for whole genome sequencing in
non-model organisms. The acyclic directed graph (DAG) output from Snakemake has been
condensed with the function,<code>condense_dag()</code>, from one of Eric’s R packages
(<a href="https://github.com/eriqande/SnakemakeDagR">SnakemakeDagR</a>). Each step/job is a separate
box, and the arrows between the boxes show the dependence of output from the parent box
(at the tail end of the arrow) as input for the child box (at the head end of the arrow).
The numbers in the boxes and along the arrows show how many independent instances of each job
must be run (for different samples, units, chromosomes, etc.)
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:full-dag"></span>
<img src="figs/snakemake-dags/full-dag.svg" alt="A DAG showing all the separate steps or jobs (called &quot;rules&quot; in Snakemake terminology) that we will be exploring while working through the example WGS workflow in this chapter." width="100%" />
<p class="caption">
FIGURE 27.1: A DAG showing all the separate steps or jobs (called “rules” in Snakemake terminology) that we will be exploring while working through the example WGS workflow in this chapter.
</p>
</div>
<p>Burn this DAG into your memory. We will return to versions of it in each section below
to give an indication of which part of the workflow we are tackling.</p>
</div>
<div id="lets-have-a-look-at-the-reference-genome" class="section level2" number="27.2">
<h2><span class="header-section-number">27.2</span> Let’s have a look at the reference genome</h2>
<p>A number of people in the class had problems installing samtools on SUMMIT last
week. The reason for this appears to be that the conda package management system
migrated to a new version of the SSH library, but samtools looks for an older version
of the libcrypto library (perhaps because it uses some of the hashing functions
from that library). This was a known problem when conda upgraded its SSH dependencies,
but seems to have resurfaced with later versions of samtools. However, it can be fixed by
installing version 1.11 of samtools.</p>
<div id="first-off-make-sure-that-you-have-added-mamba-to-your-base-environment" class="section level3" number="27.2.1">
<h3><span class="header-section-number">27.2.1</span> First off, make sure that you have added mamba to your base environment</h3>
<p>I was playing with a lot of things over the weekend, and it was clear that mamba was
orders of magnitude faster than conda for installing environments. (It almost felt
like conda merely stalled on some environments—that wouldn’t make for fun classtime…just
waiting for software to be installed).</p>
<p>So, I am going to require that people use <code>mamba</code> from here on out. First, test to see
if you have mamba in your base conda environment: activate your base conda environment
and see if you have mamba:</p>
<div class="sourceCode" id="cb692"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb692-1"><a href="example-wgs-flow.html#cb692-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate base</span>
<span id="cb692-2"><a href="example-wgs-flow.html#cb692-2" aria-hidden="true" tabindex="-1"></a><span class="ex">mamba</span></span></code></pre></div>
<p>If this gives you a screen full of syntax about how to use mamba, like:</p>
<div class="sourceCode" id="cb693"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb693-1"><a href="example-wgs-flow.html#cb693-1" aria-hidden="true" tabindex="-1"></a><span class="ex">usage:</span> mamba [-h] [-V] command ...</span>
<span id="cb693-2"><a href="example-wgs-flow.html#cb693-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb693-3"><a href="example-wgs-flow.html#cb693-3" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> is a tool for managing and deploying applications, environments and packages.</span>
<span id="cb693-4"><a href="example-wgs-flow.html#cb693-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb693-5"><a href="example-wgs-flow.html#cb693-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Options:</span></span>
<span id="cb693-6"><a href="example-wgs-flow.html#cb693-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb693-7"><a href="example-wgs-flow.html#cb693-7" aria-hidden="true" tabindex="-1"></a><span class="ex">positional</span> arguments:</span>
<span id="cb693-8"><a href="example-wgs-flow.html#cb693-8" aria-hidden="true" tabindex="-1"></a>  <span class="bu">command</span></span>
<span id="cb693-9"><a href="example-wgs-flow.html#cb693-9" aria-hidden="true" tabindex="-1"></a>    <span class="ex">clean</span>        Remove unused packages and caches.</span>
<span id="cb693-10"><a href="example-wgs-flow.html#cb693-10" aria-hidden="true" tabindex="-1"></a>    <span class="ex">compare</span>      Compare packages between conda environments.</span>
<span id="cb693-11"><a href="example-wgs-flow.html#cb693-11" aria-hidden="true" tabindex="-1"></a>    <span class="ex">config</span>       Modify configuration values in .condarc. This is modeled after the git config command. Writes to the user .condarc file <span class="er">(</span><span class="ex">/home/eriq@colostate.edu/.condarc</span><span class="kw">)</span> <span class="ex">by</span></span>
<span id="cb693-12"><a href="example-wgs-flow.html#cb693-12" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">default.</span></span>
<span id="cb693-13"><a href="example-wgs-flow.html#cb693-13" aria-hidden="true" tabindex="-1"></a>    <span class="ex">create</span>       Create a new conda environment from a list of specified packages.</span>
<span id="cb693-14"><a href="example-wgs-flow.html#cb693-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">help</span>         Displays a list of available conda commands and their help strings.</span>
<span id="cb693-15"><a href="example-wgs-flow.html#cb693-15" aria-hidden="true" tabindex="-1"></a>    <span class="ex">info</span>         Display information about current conda install.</span>
<span id="cb693-16"><a href="example-wgs-flow.html#cb693-16" aria-hidden="true" tabindex="-1"></a>    <span class="ex">init</span>         Initialize conda for shell interaction. [Experimental]</span>
<span id="cb693-17"><a href="example-wgs-flow.html#cb693-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install</span>      Installs a list of packages into a specified conda environment.</span>
<span id="cb693-18"><a href="example-wgs-flow.html#cb693-18" aria-hidden="true" tabindex="-1"></a>    <span class="ex">list</span>         List linked packages in a conda environment.</span>
<span id="cb693-19"><a href="example-wgs-flow.html#cb693-19" aria-hidden="true" tabindex="-1"></a>    <span class="ex">package</span>      Low-level conda package utility. <span class="er">(</span><span class="ex">EXPERIMENTAL</span><span class="kw">)</span></span>
<span id="cb693-20"><a href="example-wgs-flow.html#cb693-20" aria-hidden="true" tabindex="-1"></a>    <span class="ex">remove</span>       Remove a list of packages from a specified conda environment.</span>
<span id="cb693-21"><a href="example-wgs-flow.html#cb693-21" aria-hidden="true" tabindex="-1"></a>    <span class="ex">uninstall</span>    Alias for conda remove.</span>
<span id="cb693-22"><a href="example-wgs-flow.html#cb693-22" aria-hidden="true" tabindex="-1"></a>    <span class="ex">run</span>          Run an executable in a conda environment. [Experimental]</span>
<span id="cb693-23"><a href="example-wgs-flow.html#cb693-23" aria-hidden="true" tabindex="-1"></a>    <span class="ex">search</span>       Search for packages and display associated information. The input is a MatchSpec, a query language for conda packages. See examples below.</span>
<span id="cb693-24"><a href="example-wgs-flow.html#cb693-24" aria-hidden="true" tabindex="-1"></a>    <span class="ex">update</span>       Updates conda packages to the latest compatible version.</span>
<span id="cb693-25"><a href="example-wgs-flow.html#cb693-25" aria-hidden="true" tabindex="-1"></a>    <span class="ex">upgrade</span>      Alias for conda update.</span>
<span id="cb693-26"><a href="example-wgs-flow.html#cb693-26" aria-hidden="true" tabindex="-1"></a>    <span class="ex">repoquery</span>    Query repositories using mamba.</span></code></pre></div>
<p>then you have mamba.</p>
<p>If, instead, it tells you it doesn’t know anything about the mamba command, then you
need to install it. Make sure that you install it into your base conda environment,
using this command:</p>
<div class="sourceCode" id="cb694"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb694-1"><a href="example-wgs-flow.html#cb694-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> install mamba <span class="at">-n</span> base <span class="at">-c</span> conda-forge</span></code></pre></div>
<p>Now, if you need to get a working samtools (version 1.11) into an environment called
samtools, you can do this:</p>
<div class="sourceCode" id="cb695"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb695-1"><a href="example-wgs-flow.html#cb695-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mamba</span> create <span class="at">-n</span> samtools <span class="at">-c</span> bioconda samtools=1.11</span></code></pre></div>
<p>To use samtools you then must activate the environment</p>
<div class="sourceCode" id="cb696"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb696-1"><a href="example-wgs-flow.html#cb696-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate samtools</span></code></pre></div>
</div>
<div id="indexing-the-reference-genome" class="section level3" number="27.2.2">
<h3><span class="header-section-number">27.2.2</span> Indexing the reference genome</h3>
<p>Samtools has wonderful subcommand, <code>faidx</code> that indexes a fasta file.
We can index our example reference genome by running this command from the
top level of our <code>non-model-wgs-example-data</code> directory.</p>
<div class="sourceCode" id="cb697"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb697-1"><a href="example-wgs-flow.html#cb697-1" aria-hidden="true" tabindex="-1"></a><span class="ex">samtools</span> faidx resources/genome.fasta</span></code></pre></div>
<p>This creates the file <code>resources/genome.fasta.fai</code>. The extension
<code>.fai</code> stands for “faidx index.” Look at <code>resources/genome.fasta.fai</code>
using the <code>less</code> viewer. The first few lines look like:</p>
<pre><code>  CM031199.1      14000000        122     60      61
CM031200.1      12000000        14233578        60      61
CM031201.1      10000000        26433700        60      61
CM031202.1      6000000 36600489        60      61
JAEPEU010001976.1       276     42700570        60      61
JAEPEU010009262.1       333     42700932        60      61
JAEPEU010007942.1       367     42701352        60      61
JAEPEU010006675.1       416     42701807        60      61
JAEPEU010003074.1       440     42702311        60      61</code></pre>
<p>Each line gives information about a differet sequence in the referenc fasta
file, listed in the order that the sequences appear in the fasta file.</p>
<p>The five columns of each line hold this information:</p>
<ul>
<li><strong>NAME</strong>: Name of this reference sequence</li>
<li><strong>LENGTH</strong>: Total length of this reference sequence, in bases</li>
<li><strong>OFFSET</strong>: Offset in the FASTA/FASTQ file of this sequence’s first base</li>
<li><strong>LINEBASES</strong>: The number of bases on each line</li>
<li><strong>LINEWIDTH</strong>: The number of bytes in each line, including the newline</li>
</ul>
<p>This information can be used to rapidly find the parts of the file where
any position in the genome is found, for example, if you wanted to find
the 100th base in sequence <code>JAEPEU010001976.1</code> you can see that you have
to go <code>42700570</code> bytes from the start of the file to get to base 1 of
`<code>JAEPEU010001976.1</code>, and then you would have to go forward in the file
for 99 bases. 59 bases forward would get you to the last base on the first
line, then you have an additional byte to eat up (the line ending) and then
40 more bytes would put you at position 100. So, you could reach
the desired point in the fasta file by just going
<code>42700570 + 59 + 1 + 40</code> bytes forward in the file. This is the sort
of thing that can be done very quickly by a computer.</p>
<p>Fortunately you don’t have to do this arithmetic in your head to
find sequences at certain places in the reference genome. Rather, once
you have indexed your FASTA file, you can use <code>samtools faidx</code> with any
number of optional <em>genomic coordinates</em>, to extract those seqences.</p>
<p>A genomic coordinate (or “range”) of a sequence has the form:</p>
<pre><code>chromosome_or_sequence_name:start_position-end_positions</code></pre>
<p>For example:</p>
<pre><code>CM031199.1:50151-50300</code></pre>
<p>gives the genomic coordinates (or the “genome address”) of the 150 base pair
sequence whose first base is at position 50,151 in the genome, and whose
last is at position 50,300. When using <code>samtools faidx</code> bases are numbered
so that the first one is <code>1</code>. This is called <em>base-1</em> indexing. Other
ways of addressing regions of genomes (like those used in BED files, use a
different <em>base-0</em> scheme.)</p>
<p>You can think of <em>base-1</em> schemes as those that give the address of each
base starting from 1. To understand a base-0 scheme in that light, it makes
sense to think about addressing each SNP according to individual “pickets” that
separate each base. (Probably should draw a picture, but you can see it
at this <a href="https://genome-blog.soe.ucsc.edu/blog/2016/12/12/the-ucsc-genome-browser-coordinate-counting-systems/">UCSC genome browser blog site</a>).</p>
<p>At any rate, if you want to get the 500 bases starting from 1,000,001 on the
first two chromosomes in our example reference genome you would do:</p>
<div class="sourceCode" id="cb701"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb701-1"><a href="example-wgs-flow.html#cb701-1" aria-hidden="true" tabindex="-1"></a><span class="ex">samtools</span> faidx resources/genome.fasta CM031199.1:1000001-1000500 CM031200.1:1000001-1000500</span></code></pre></div>
<p>Note that if you find it difficult to keep track of all those zeroes, you are
free to put commas into the numbers anywhere that is helpful, for example:</p>
<div class="sourceCode" id="cb702"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb702-1"><a href="example-wgs-flow.html#cb702-1" aria-hidden="true" tabindex="-1"></a><span class="ex">samtools</span> faidx resources/genome.fasta CM031199.1:1,000,001-1,000,500 CM031200.1:1,000,001-1,000,500</span></code></pre></div>
<p>So, if you ever need to extract a certain sequence from a genome, this is one way
you can do it!</p>
</div>
</div>
<div id="a-word-on-organizing-workflows" class="section level2" number="27.3">
<h2><span class="header-section-number">27.3</span> A word on organizing workflows</h2>
<p>Now, before we start rolling along with our example bioinformatic workflow,
let us take a moment and appreciate how clean and tidy our <code>non-model-wgs-example-data</code>
directory is. If I do ls on it I see this:</p>
<div class="sourceCode" id="cb703"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb703-1"><a href="example-wgs-flow.html#cb703-1" aria-hidden="true" tabindex="-1"></a><span class="ex">%</span> ls</span>
<span id="cb703-2"><a href="example-wgs-flow.html#cb703-2" aria-hidden="true" tabindex="-1"></a><span class="ex">data</span>  fastq  README.nb.html  README.Rmd  resources  samples.tsv  units.tsv</span></code></pre></div>
<p>That is all right! There are only seven files or directories there and it
is not a mess.</p>
<p>As we proceed with a bioinformatic pipeline/workflow, it will behoove us to
keep things super nice and clean. In fact I am going to recommend that nearly
everything we do in our workflow should go inside a single directory called
<code>results</code>.</p>
<p>In general, your workflow will involve several types of large files. Some of those
are just things like genomes (.fasta files), genomic features (.gff) files, or known
variants, etc. In general these sorts of things that you might download from a
repository like GenBank should be placed into the <code>resources</code> directory, possibly
in their own subdirectory within <code>resources</code>. The other types of files are those that
get produced when you run bioinformatic software to analyze your data—for example, trimmed
versions of your fastqs after you have trimmed off the low quality bases, etc. These latter
types of files should all go into separate folders within a directory called <code>results</code>.
The directory they go in should reflect what type of step in your bioinformatic process
produced them, for example: <code>trimmed</code>, <code>mapped</code>, <code>variants</code>, etc.</p>
<p>Additionally, there should be a directory, <code>results/logs</code> where you should redirect <code>stderr</code> for
each sample that is run in a certain process. All this will become clear as we start
working through our example.</p>
</div>
<div id="step-1a.-quality-checking-the-reads" class="section level2" number="27.4">
<h2><span class="header-section-number">27.4</span> Step 1a. Quality Checking the Reads</h2>
<p>The first thing we are going to do is Quality Check our fastq files. The
goal of this step is to get a sense for how good (or bad) the data that we got
back from the sequencing center is, in terms of number of reads per sample,
base quality scores, distribution of A, C, G, and T bases, the number of missing
bases, and the occurrence of overrepresented sequences (that could indicate
contamination or untrimmed Illumina adapters, etc.)</p>
The following figure shows where this fits into our overall workflow. We will be
using FASTQC to profile each FASTQ file, and then we will summarize all those results
with MULTIQC.
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:fastqc-multiqc-dag"></span>
<img src="figs/snakemake-dags/fastqc-multiqc.svg" alt="FASTQC steps and the associated MULTIQC step of this section shown in color." width="100%" />
<p class="caption">
FIGURE 27.2: FASTQC steps and the associated MULTIQC step of this section shown in color.
</p>
</div>
<p>There is a standard
piece of Java software called FASTQC that does a reasonably comprehensive job of this.
We will focus on running it interactively for now (we will talk about dispatching
jobs via SLURM later). So, on the cluster, we will want to get a shell on a compute
node. If you want to, on SUMMIT, you can get an interactive shell with:</p>
<div class="sourceCode" id="cb704"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb704-1"><a href="example-wgs-flow.html#cb704-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sinteractive</span></span></code></pre></div>
<p>But, to be honest, <code>sinteractive</code> is a somewhat old-school shell function that uses
screen to connect you to the interactive shell. This causes some problems for TMUX. So,
I find a better way to get a shell from the oversubscriped interactive partition on
SUMMIT to be:</p>
<div class="sourceCode" id="cb705"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb705-1"><a href="example-wgs-flow.html#cb705-1" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> <span class="at">--partition</span><span class="op">=</span>shas-interactive <span class="at">-t</span> 2:00:00 <span class="at">--pty</span> /bin/bash</span></code></pre></div>
<p>When you do this, and then reconnect to such a session with TMUX, your scrollback shouldn’t
be totally messed up (Thanks Caitlin for reminding me of this <code>sinteractive</code> atrocity!).
I’ve checked with the sys-admins on SUMMIT and they say this is a perfectly acceptable
way of getting an interactive shell on SUMMIT. Also, the <code>-t 2:00:00</code> says
“give me this interactive shell for 2 hours,” which will give us more than
enough time to get through a whole class session.</p>
<p>The first thing we will need to do is get FASTQC using mamba. Put it in its own
environment named <code>fastqc</code>.</p>
<div class="sourceCode" id="cb706"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb706-1"><a href="example-wgs-flow.html#cb706-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mamba</span> create <span class="at">-n</span> fastqc <span class="at">-c</span> bioconda fastqc</span></code></pre></div>
<p>Hooray for the wicked speed of mamba!</p>
<p>Once this is set up, we can get the instructions for using fastqc like this:</p>
<div class="sourceCode" id="cb707"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb707-1"><a href="example-wgs-flow.html#cb707-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate fastqc</span>
<span id="cb707-2"><a href="example-wgs-flow.html#cb707-2" aria-hidden="true" tabindex="-1"></a><span class="ex">fastqc</span> <span class="at">--help</span></span></code></pre></div>
<p>That is a fairly lengthy statement about the syntax of this program,
so I won’t copy it into the handbook, here, But read through it and you
shall find that it looks like if we want to just
put all the fastq files on the command line
then <code>fastqc</code> ought to gobble them right up and put the output in files that
are named intelligently. That sounds pretty convenient. Let’s test it out
on a couple of the smallest files that we have (about 15 Mb each):</p>
<div class="sourceCode" id="cb708"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb708-1"><a href="example-wgs-flow.html#cb708-1" aria-hidden="true" tabindex="-1"></a><span class="co"># make some directories to put the results in</span></span>
<span id="cb708-2"><a href="example-wgs-flow.html#cb708-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> results/qc/fastqc results/logs/fastqc</span>
<span id="cb708-3"><a href="example-wgs-flow.html#cb708-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb708-4"><a href="example-wgs-flow.html#cb708-4" aria-hidden="true" tabindex="-1"></a><span class="co"># now, try running fastqc on two small files:</span></span>
<span id="cb708-5"><a href="example-wgs-flow.html#cb708-5" aria-hidden="true" tabindex="-1"></a><span class="ex">fastqc</span> <span class="at">-o</span> results/qc/fastqc <span class="at">--noextract</span> fastq/s006---1_R1.fq.gz fastq/s006---1_R2.fq.gz</span></code></pre></div>
<p>Note that fastqc spits out some output to tell you about the progress that it is making.
It turns out that is going to both <em>stderr</em> (the percent complete lines) and to
<em>stdout</em> (the “complete” lines). So, we probably should capture both of those streams
in the future.</p>
<p>When it is done, look at the output in <code>results/qc/fastqc</code>. See that there are files with
pretty self-explanatory names. For each FASTQ file there is an <code>.html</code> file that has
a report file (with lots of pretty pictures) that can be opened in a web browser. Note that
you have to copy those to your laptop if you want to see them. You could, for example,
do that with Globus. The other output for each FASTQ file is a <code>.zip</code> file of data
that we will use later.</p>
<p>That didn’t take too long. Let’s try the whole schmeer! We can do that easily with
globbing. Note the redirection of <em>stdout</em> to a log file and the <code>2&gt;&amp;1</code> which means, “send
<em>stderr</em> to the same place <em>stdout</em> is going to.”</p>
<div class="sourceCode" id="cb709"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb709-1"><a href="example-wgs-flow.html#cb709-1" aria-hidden="true" tabindex="-1"></a><span class="ex">fastqc</span> <span class="at">-o</span> results/qc/fastqc <span class="at">--noextract</span> fastq/<span class="pp">*</span>.fq.gz  <span class="op">&gt;</span> results/logs/fastqc/fastqc.log <span class="dv">2</span><span class="op">&gt;&amp;</span><span class="dv">1</span></span></code></pre></div>
<p>Note that if you want to see how much progress is being made on the file
you can look at the bottom of the log file at <code>results/logs/fastqc/fastqc.log</code>
using the <code>tail</code> command in another shell (opened for example with tmux, before you started
the last command). In fact, you can do one better than that by using <code>tail -f</code>.</p>
<p>Since I had another shell going in tmux, I can do this with it:</p>
<div class="sourceCode" id="cb710"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb710-1"><a href="example-wgs-flow.html#cb710-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span> <span class="at">-f</span> results/logs/fastqc/fastqc.log</span></code></pre></div>
<p>this continuously spits new output to the <code>fastqc.log</code> file to <em>stdout</em>.
The whole thing should take about 5 to 10 minutes on an interactive shell
on SUMMIT.</p>
<div id="a-little-looking-at-the-htmls" class="section level3" number="27.4.1">
<h3><span class="header-section-number">27.4.1</span> A Little Looking at the HTMLs</h3>
<p>Let’s just go through a few of the different pieces of information
in here. It is relatively self-explanatory. I do want to call out the
adapter content pane, and show that it found some instances of the
Illumina Universal Adapter. These are refer to Illumina’s TruSeq Version 3
adapters. So, we see that some of the reads include sequence from the
adapters. Cool. We will come back to that.</p>
</div>
<div id="summarizing-output-from-a-lot-of-different-files-with-multiqc" class="section level3" number="27.4.2">
<h3><span class="header-section-number">27.4.2</span> Summarizing output from a lot of different files with MultiQC</h3>
<p>As you probably noticed if you tried to open all the html reports for every
FASTQ file, it is a bit laborious to look at every report…and this is just
for a small number of files. Imagine if you had to do that for 768 different
FASTQ files!</p>
<p>A good solution for summarizing such outputs is the Java-based program, MultiQC.
This program offers an insightful system for summarizing log files and outputs from
a wide range of different bioinformatics programs. It is capable of summarizing much
more than just fastqc files, but that is how we will first use it.</p>
<p>Let’s get it and put it in a conda environment called multiqc.</p>
<div class="sourceCode" id="cb711"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb711-1"><a href="example-wgs-flow.html#cb711-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mamba</span> create <span class="at">-n</span> multiqc <span class="at">-c</span> bioconda multiqc</span></code></pre></div>
<p>Once that is done (and if you use <code>conda</code> instead of <code>mamba</code> it might
never be done) you can activate the environment and get some information
about how to use multiqc with:</p>
<div class="sourceCode" id="cb712"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb712-1"><a href="example-wgs-flow.html#cb712-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate multiqc</span>
<span id="cb712-2"><a href="example-wgs-flow.html#cb712-2" aria-hidden="true" tabindex="-1"></a><span class="ex">multiqc</span> <span class="at">--help</span> </span></code></pre></div>
<p>Reading the program syntax, it seems like we should be able to
point it to the <code>results/qc/fastqc</code> directory and tell it to put its output
into a <code>results/qc/multiqc</code> directory like this:</p>
<div class="sourceCode" id="cb713"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb713-1"><a href="example-wgs-flow.html#cb713-1" aria-hidden="true" tabindex="-1"></a><span class="ex">multiqc</span> <span class="at">-v</span> <span class="at">-o</span> results/qc/multiqc results/qc/fastqc</span></code></pre></div>
<p>Note that the command line above is using the <code>-v</code> option, which gives us
<em>verbose</em> output. This is kind of fun because it shows us all the different kinds of
output file types that MultiQC can parse—a whole boatload of them. All we have
now our fastqc files. But we can see the summary report by downloading
<code>results/qc/multiqc/multiqc_report.html</code> and opening it in your browser. Super cool!</p>
</div>
</div>
<div id="step-1b.-trimming-the-reads" class="section level2" number="27.5">
<h2><span class="header-section-number">27.5</span> Step 1b. Trimming the Reads</h2>
<p>The fastqc reports showed that most of the sequences we have are of pretty good quality,
but, as expected, the quality drops off a bit later in the read. Also, we saw that there
were some adapter sequences stuck into 1 to 3% of the reads. We can use the
tool TrimmoMatic to:</p>
<ol style="list-style-type: decimal">
<li>Trim off parts of reads that are of low quality.</li>
<li>Chuck out entire reads that are of low quality.</li>
<li>Remove adapter sequences that are improperly inserted into our reads.</li>
</ol>
This step corresponds to the colored node in our now-familiar workflow DAG:
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:trimmo-dag"></span>
<img src="figs/snakemake-dags/trimmo.svg" alt="Running Trimmomatic to clean up our sequencing reads by removing adapter cruft and discarding parts of the reads with low quality." width="100%" />
<p class="caption">
FIGURE 27.3: Running Trimmomatic to clean up our sequencing reads by removing adapter cruft and discarding parts of the reads with low quality.
</p>
</div>
<p>To use Trimmomatic, we will have to get it. If you don’t have it in a conda environment
yet, you know the drill:</p>
<div class="sourceCode" id="cb714"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb714-1"><a href="example-wgs-flow.html#cb714-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mamba</span> create <span class="at">-n</span> trimmo <span class="at">-c</span> bioconda trimmomatic</span></code></pre></div>
<p>Once that is installed you can get a terse and somewhat cryptic message about how
to run the program like this:</p>
<div class="sourceCode" id="cb715"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb715-1"><a href="example-wgs-flow.html#cb715-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate trimmo</span>
<span id="cb715-2"><a href="example-wgs-flow.html#cb715-2" aria-hidden="true" tabindex="-1"></a><span class="ex">trimmomatic</span></span></code></pre></div>
<p>Which tells us this:</p>
<pre><code>Usage:
       PE [-version] \
          [-threads &lt;threads&gt;] \
          [-phred33|-phred64] \
          [-trimlog &lt;trimLogFile&gt;] \
          [-summary &lt;statsSummaryFile&gt;] \
          [-quiet] \
          [-validatePairs] \
          [-basein &lt;inputBase&gt; | &lt;inputFile1&gt; &lt;inputFile2&gt;] \
          [-baseout &lt;outputBase&gt; | &lt;outputFile1P&gt; &lt;outputFile1U&gt; &lt;outputFile2P&gt; &lt;outputFile2U&gt;] \
          &lt;trimmer1&gt;...
   or:
       SE [-version] \
          [-threads &lt;threads&gt;] \
          [-phred33|-phred64] \
          [-trimlog &lt;trimLogFile&gt;] \
          [-summary &lt;statsSummaryFile&gt;] \
          [-quiet] \
          &lt;inputFile&gt; &lt;outputFile&gt; \
          &lt;trimmer1&gt;...
   or:
       -version</code></pre>
<p>Where I have added backslash-line-endings to make it a little easier to read.</p>
<p>Aha! We can run this dude in paired end mode (PE) or in single end mode (SE).
Since we have paired-end data, we will run it in paired-end mode.</p>
<p>Full details of the syntax and the methodology can be found in the PDF Trimmomatic
manual at <a href="http://www.usadellab.org/cms/uploads/supplementary/Trimmomatic/TrimmomaticManual_V0.32.pdf">http://www.usadellab.org/cms/uploads/supplementary/Trimmomatic/TrimmomaticManual_V0.32.pdf</a>. This link
seems to not work very well sometimes…</p>
<p>We will be running it on a single thread for now so the really relevant syntax is:</p>
<div class="sourceCode" id="cb717"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb717-1"><a href="example-wgs-flow.html#cb717-1" aria-hidden="true" tabindex="-1"></a>       <span class="ex">PE</span> <span class="dt">\</span></span>
<span id="cb717-2"><a href="example-wgs-flow.html#cb717-2" aria-hidden="true" tabindex="-1"></a>          [-basein <span class="op">&lt;</span>inputBase<span class="op">&gt;</span> <span class="kw">|</span> <span class="op">&lt;</span>inputFile1<span class="op">&gt;</span> <span class="op">&lt;</span>inputFile2<span class="op">&gt;</span>] <span class="dt">\</span></span>
<span id="cb717-3"><a href="example-wgs-flow.html#cb717-3" aria-hidden="true" tabindex="-1"></a>          [-baseout <span class="op">&lt;</span>outputBase<span class="op">&gt;</span> <span class="kw">|</span> <span class="op">&lt;</span>outputFile1P<span class="op">&gt;</span> <span class="op">&lt;</span>outputFile1U<span class="op">&gt;</span> <span class="op">&lt;</span>outputFile2P<span class="op">&gt;</span> <span class="op">&lt;</span>outputFile2U<span class="op">&gt;</span>] <span class="dt">\</span></span>
<span id="cb717-4"><a href="example-wgs-flow.html#cb717-4" aria-hidden="true" tabindex="-1"></a>          <span class="op">&lt;</span>trimmer1<span class="op">&gt;</span>...</span></code></pre></div>
<p>This syntax message signifies that you can either give it a base file prefix
for the input and output files, like <code>-basein fastq/s001-1  -baseout results/trimmed/s001-1</code>,
or you can explicitly give it the names of the input and output files. I tend to think that
the latter is a better way to do it (always good to be explicit).</p>
<p>So, for example, with our tidy named files in the fastq directory, the first
two lines there might look like:</p>
<div class="sourceCode" id="cb718"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb718-1"><a href="example-wgs-flow.html#cb718-1" aria-hidden="true" tabindex="-1"></a><span class="ex">trimmomatic</span> PE <span class="dt">\</span></span>
<span id="cb718-2"><a href="example-wgs-flow.html#cb718-2" aria-hidden="true" tabindex="-1"></a>  fastq/s001---1_R1.fq.gz  fastq/s001---1_R2.fq.gz   <span class="dt">\</span></span>
<span id="cb718-3"><a href="example-wgs-flow.html#cb718-3" aria-hidden="true" tabindex="-1"></a>  results/trimmed/s001---1_R1.fq.gz  results/trimmed/s001---1_R1_unpaired.fq.gz  <span class="dt">\</span></span>
<span id="cb718-4"><a href="example-wgs-flow.html#cb718-4" aria-hidden="true" tabindex="-1"></a>  results/trimmed/s001---1_R2.fq.gz  results/trimmed/s001---1_R2_unpaired.fq.gz </span></code></pre></div>
<p>So, the two input files are read 1 and read2, and the four output files are in this order:</p>
<ol style="list-style-type: decimal">
<li>Read 1 successfully trimmed.</li>
<li>Read 1 that is no longer paired (because, for example, its mate was tossed out)</li>
<li>Read 2 successfully trimmed</li>
<li>Read 2 that is no longer paired.</li>
</ol>
<p>The reads that you will use downstream, for mapping, will be the successfully
trimmed ones.</p>
<p>Now, the more complex part of the command line syntax is the innocouous looking
<code>&lt;trimmer1&gt;...</code>. That seemingly simple word belies the opportunity to specify all the
different types of read trimming modules and their parameters
(and the order in which they will be applied) that you want to use. Once again, the
PDF manual is the place to go, but a good place to start will be:</p>
<div class="sourceCode" id="cb719"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb719-1"><a href="example-wgs-flow.html#cb719-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get path to trimmomatic to find the path to the adapter files.</span></span>
<span id="cb719-2"><a href="example-wgs-flow.html#cb719-2" aria-hidden="true" tabindex="-1"></a><span class="co"># It seems to look for them in a standard /usr/local/share location,</span></span>
<span id="cb719-3"><a href="example-wgs-flow.html#cb719-3" aria-hidden="true" tabindex="-1"></a><span class="co"># which is not where they are if conda installed.</span></span>
<span id="cb719-4"><a href="example-wgs-flow.html#cb719-4" aria-hidden="true" tabindex="-1"></a><span class="va">trim_path=$(</span><span class="fu">which</span> trimmomatic<span class="va">)</span></span>
<span id="cb719-5"><a href="example-wgs-flow.html#cb719-5" aria-hidden="true" tabindex="-1"></a><span class="va">trim_dir=$(</span><span class="fu">dirname</span> <span class="va">$trim_path)</span></span>
<span id="cb719-6"><a href="example-wgs-flow.html#cb719-6" aria-hidden="true" tabindex="-1"></a><span class="va">adapter_fasta=$trim_dir</span>/../share/trimmomatic/adapters/TruSeq3-PE-2.fa</span>
<span id="cb719-7"><a href="example-wgs-flow.html#cb719-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb719-8"><a href="example-wgs-flow.html#cb719-8" aria-hidden="true" tabindex="-1"></a><span class="co"># make a results/trimmed directory to put the outputs into</span></span>
<span id="cb719-9"><a href="example-wgs-flow.html#cb719-9" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> results/trimmed</span>
<span id="cb719-10"><a href="example-wgs-flow.html#cb719-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb719-11"><a href="example-wgs-flow.html#cb719-11" aria-hidden="true" tabindex="-1"></a><span class="ex">trimmomatic</span> PE <span class="dt">\</span></span>
<span id="cb719-12"><a href="example-wgs-flow.html#cb719-12" aria-hidden="true" tabindex="-1"></a>  fastq/s001---1_R1.fq.gz  fastq/s001---1_R2.fq.gz   <span class="dt">\</span></span>
<span id="cb719-13"><a href="example-wgs-flow.html#cb719-13" aria-hidden="true" tabindex="-1"></a>  results/trimmed/s001---1_R1.fq.gz  results/trimmed/s001---1_R1_unpaired.fq.gz <span class="dt">\</span></span>
<span id="cb719-14"><a href="example-wgs-flow.html#cb719-14" aria-hidden="true" tabindex="-1"></a>  results/trimmed/s001---1_R2.fq.gz  results/trimmed/s001---1_R2_unpaired.fq.gz  <span class="dt">\</span></span>
<span id="cb719-15"><a href="example-wgs-flow.html#cb719-15" aria-hidden="true" tabindex="-1"></a>  ILLUMINACLIP:<span class="va">${adapter_fasta}</span>:2:30:10 <span class="dt">\</span></span>
<span id="cb719-16"><a href="example-wgs-flow.html#cb719-16" aria-hidden="true" tabindex="-1"></a>  LEADING:3 <span class="dt">\</span></span>
<span id="cb719-17"><a href="example-wgs-flow.html#cb719-17" aria-hidden="true" tabindex="-1"></a>  TRAILING:3 <span class="dt">\</span></span>
<span id="cb719-18"><a href="example-wgs-flow.html#cb719-18" aria-hidden="true" tabindex="-1"></a>  SLIDINGWINDOW:4:15 <span class="dt">\</span></span>
<span id="cb719-19"><a href="example-wgs-flow.html#cb719-19" aria-hidden="true" tabindex="-1"></a>  MINLEN:36</span></code></pre></div>
<p>You can go ahead and evaluate those commands and see what happens when
trimmomatic runs. And while it is running, we can try to unpack those last few lines:</p>
<ul>
<li><code>ILLUMINACLIP:${adapter_fasta}:2:30:10</code>: This means remove Illumina adapters that match the
sequences in the fasta file <code>TruSeq3-PE-2.fa</code> that is included with the Trimmomatic distribution.
That file looks like this:</li>
</ul>
<pre><code>&gt;PrefixPE/1
TACACTCTTTCCCTACACGACGCTCTTCCGATCT
&gt;PrefixPE/2
GTGACTGGAGTTCAGACGTGTGCTCTTCCGATCT
&gt;PE1
TACACTCTTTCCCTACACGACGCTCTTCCGATCT
&gt;PE1_rc
AGATCGGAAGAGCGTCGTGTAGGGAAAGAGTGTA
&gt;PE2
GTGACTGGAGTTCAGACGTGTGCTCTTCCGATCT
&gt;PE2_rc
AGATCGGAAGAGCACACGTCTGAACTCCAGTCAC</code></pre>
<p>Those are the sequences (and the reverse complements) for the TruSeq version3 adapters.
It is pretty fun to look around in your fastq files to find there sequences…(We could
play around with that if you want). This particular fasta file is set up to allow
Trimmomatic to find spurious adapter sequences when they arrived in your reads by
a few different things (see the Palindrome clipping section in the manual).</p>
<ul>
<li><code>LEADING:3</code>: Remove bases at the beginning of the read that have a
Phred-scaled quality score less than 3.</li>
<li><code>TRAILING:3</code>: Remove bases at the end of the read that have a
Phred-scaled quality score less than 3.</li>
<li><code>SLIDINGWINDOW:4:15</code>: Remove any bases within a sliding window of 4 bases that have an
average Phred-scaled quality score of less than 15.</li>
<li><code>MINLEN:36</code>: Toss out any reads that are only 36 bp long after the bad bases have been trimmed.</li>
</ul>
<div id="cycling-over-all-the-files-and-trimming-them" class="section level3" number="27.5.1">
<h3><span class="header-section-number">27.5.1</span> Cycling over all the files and trimming them</h3>
<p>Ultimately, we are going to have to cycle over the fastq files in some way, so,
note that we could have written the above command line by defining a shell variable for the
file prefix. Lets clean this whole thing up with some shell variables, using
<code>s002---1</code> as an example</p>
<div class="sourceCode" id="cb721"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb721-1"><a href="example-wgs-flow.html#cb721-1" aria-hidden="true" tabindex="-1"></a><span class="co"># here is a variable to store all the trimmer directives:</span></span>
<span id="cb721-2"><a href="example-wgs-flow.html#cb721-2" aria-hidden="true" tabindex="-1"></a><span class="va">TRIMMER=</span><span class="st">&quot;ILLUMINACLIP:</span><span class="va">${adapter_fasta}</span><span class="st">:2:30:10 </span><span class="dt">\</span></span>
<span id="cb721-3"><a href="example-wgs-flow.html#cb721-3" aria-hidden="true" tabindex="-1"></a><span class="st">  LEADING:3 </span><span class="dt">\</span></span>
<span id="cb721-4"><a href="example-wgs-flow.html#cb721-4" aria-hidden="true" tabindex="-1"></a><span class="st">  TRAILING:3 </span><span class="dt">\</span></span>
<span id="cb721-5"><a href="example-wgs-flow.html#cb721-5" aria-hidden="true" tabindex="-1"></a><span class="st">  SLIDINGWINDOW:4:15 </span><span class="dt">\</span></span>
<span id="cb721-6"><a href="example-wgs-flow.html#cb721-6" aria-hidden="true" tabindex="-1"></a><span class="st">  MINLEN:36&quot;</span></span>
<span id="cb721-7"><a href="example-wgs-flow.html#cb721-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb721-8"><a href="example-wgs-flow.html#cb721-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb721-9"><a href="example-wgs-flow.html#cb721-9" aria-hidden="true" tabindex="-1"></a><span class="co"># define a file prefix for s002---1</span></span>
<span id="cb721-10"><a href="example-wgs-flow.html#cb721-10" aria-hidden="true" tabindex="-1"></a><span class="va">FP=</span>s002---1</span>
<span id="cb721-11"><a href="example-wgs-flow.html#cb721-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb721-12"><a href="example-wgs-flow.html#cb721-12" aria-hidden="true" tabindex="-1"></a><span class="co"># now get the names of all the input files and output files</span></span>
<span id="cb721-13"><a href="example-wgs-flow.html#cb721-13" aria-hidden="true" tabindex="-1"></a><span class="co"># and store them in a shell variable.  Not the fun shell-fu here.</span></span>
<span id="cb721-14"><a href="example-wgs-flow.html#cb721-14" aria-hidden="true" tabindex="-1"></a><span class="va">INFILES=$(</span><span class="bu">echo</span> fastq/<span class="va">${FP}</span>_<span class="dt">{R1</span><span class="op">,</span><span class="dt">R2}</span>.fq.gz<span class="va">)</span></span>
<span id="cb721-15"><a href="example-wgs-flow.html#cb721-15" aria-hidden="true" tabindex="-1"></a><span class="va">OUTFILES=$(</span><span class="bu">echo</span> results/trimmed/<span class="va">${FP}</span>_<span class="dt">{R1</span><span class="op">,</span><span class="dt">R2}{</span><span class="op">,</span><span class="dt">_unpaired}</span>.fq.gz<span class="va">)</span></span>
<span id="cb721-16"><a href="example-wgs-flow.html#cb721-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb721-17"><a href="example-wgs-flow.html#cb721-17" aria-hidden="true" tabindex="-1"></a><span class="co"># make a Log file too</span></span>
<span id="cb721-18"><a href="example-wgs-flow.html#cb721-18" aria-hidden="true" tabindex="-1"></a><span class="va">LOG=</span>results/logs/trimmomatic/<span class="va">$FP</span>.log</span>
<span id="cb721-19"><a href="example-wgs-flow.html#cb721-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb721-20"><a href="example-wgs-flow.html#cb721-20" aria-hidden="true" tabindex="-1"></a><span class="co"># you might want to try &quot;echo $INFILES&quot; and &quot;echo $OUTFILES&quot; </span></span>
<span id="cb721-21"><a href="example-wgs-flow.html#cb721-21" aria-hidden="true" tabindex="-1"></a><span class="co"># and &quot;echo $LOG&quot; to see what those look like.</span></span>
<span id="cb721-22"><a href="example-wgs-flow.html#cb721-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb721-23"><a href="example-wgs-flow.html#cb721-23" aria-hidden="true" tabindex="-1"></a><span class="co"># We need to make sure that we have directories to put all those</span></span>
<span id="cb721-24"><a href="example-wgs-flow.html#cb721-24" aria-hidden="true" tabindex="-1"></a><span class="co"># output and log files into.  We can do that with:</span></span>
<span id="cb721-25"><a href="example-wgs-flow.html#cb721-25" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> <span class="va">$(</span><span class="fu">dirname</span> <span class="va">$LOG</span> <span class="va">$OUTFILES)</span></span>
<span id="cb721-26"><a href="example-wgs-flow.html#cb721-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb721-27"><a href="example-wgs-flow.html#cb721-27" aria-hidden="true" tabindex="-1"></a><span class="co"># now that we have defined those variables, we can write our </span></span>
<span id="cb721-28"><a href="example-wgs-flow.html#cb721-28" aria-hidden="true" tabindex="-1"></a><span class="co"># command line like this:</span></span>
<span id="cb721-29"><a href="example-wgs-flow.html#cb721-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb721-30"><a href="example-wgs-flow.html#cb721-30" aria-hidden="true" tabindex="-1"></a><span class="ex">trimmomatic</span> PE <span class="va">$INFILES</span> <span class="va">$OUTFILES</span> <span class="va">$TRIMMER</span> <span class="op">&gt;</span> <span class="va">$LOG</span> <span class="dv">2</span><span class="op">&gt;&amp;</span><span class="dv">1</span></span></code></pre></div>
<p>Once we have figured out that whole collection of command lines,
and have verified that it works for
our “trial” value of <code>FP</code> (i.e, <code>s002---1</code>), it is time to cycle over all the
different possible values of <code>FP</code>.</p>
<p>We can use globbing and the <code>basename</code> utility to get all the file prefixes. Check this
out:</p>
<div class="sourceCode" id="cb722"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb722-1"><a href="example-wgs-flow.html#cb722-1" aria-hidden="true" tabindex="-1"></a><span class="va">FILE_PREFIXES=$(</span><span class="fu">basename</span> <span class="at">-a</span> <span class="at">-s</span> _R1.fq.gz fastq/<span class="pp">*</span>R1.fq.gz<span class="va">)</span></span></code></pre></div>
<p>Evaluate that and then run <code>echo $FILE_PREFIXES</code> to see what you have.</p>
<p>With that, we can then define a for loop to run over all 22 pairs of files:</p>
<div class="sourceCode" id="cb723"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb723-1"><a href="example-wgs-flow.html#cb723-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This stays outside of the for loop:</span></span>
<span id="cb723-2"><a href="example-wgs-flow.html#cb723-2" aria-hidden="true" tabindex="-1"></a><span class="va">TRIMMER=</span><span class="st">&quot;ILLUMINACLIP:</span><span class="va">${adapter_fasta}</span><span class="st">:2:30:10 </span><span class="dt">\</span></span>
<span id="cb723-3"><a href="example-wgs-flow.html#cb723-3" aria-hidden="true" tabindex="-1"></a><span class="st">  LEADING:3 </span><span class="dt">\</span></span>
<span id="cb723-4"><a href="example-wgs-flow.html#cb723-4" aria-hidden="true" tabindex="-1"></a><span class="st">  TRAILING:3 </span><span class="dt">\</span></span>
<span id="cb723-5"><a href="example-wgs-flow.html#cb723-5" aria-hidden="true" tabindex="-1"></a><span class="st">  SLIDINGWINDOW:4:15 </span><span class="dt">\</span></span>
<span id="cb723-6"><a href="example-wgs-flow.html#cb723-6" aria-hidden="true" tabindex="-1"></a><span class="st">  MINLEN:36&quot;</span></span>
<span id="cb723-7"><a href="example-wgs-flow.html#cb723-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb723-8"><a href="example-wgs-flow.html#cb723-8" aria-hidden="true" tabindex="-1"></a><span class="co"># get list of file prefixes</span></span>
<span id="cb723-9"><a href="example-wgs-flow.html#cb723-9" aria-hidden="true" tabindex="-1"></a><span class="va">FILE_PREFIXES=$(</span><span class="fu">basename</span> <span class="at">-a</span> <span class="at">-s</span> _R1.fq.gz fastq/<span class="pp">*</span>R1.fq.gz<span class="va">)</span></span>
<span id="cb723-10"><a href="example-wgs-flow.html#cb723-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb723-11"><a href="example-wgs-flow.html#cb723-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> FP <span class="kw">in</span> <span class="va">$FILE_PREFIXES</span><span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb723-12"><a href="example-wgs-flow.html#cb723-12" aria-hidden="true" tabindex="-1"></a>  <span class="va">INFILES=$(</span><span class="bu">echo</span> fastq/<span class="va">${FP}</span>_<span class="dt">{R1</span><span class="op">,</span><span class="dt">R2}</span>.fq.gz<span class="va">)</span></span>
<span id="cb723-13"><a href="example-wgs-flow.html#cb723-13" aria-hidden="true" tabindex="-1"></a>  <span class="va">OUTFILES=$(</span><span class="bu">echo</span> results/trimmed/<span class="va">${FP}</span>_<span class="dt">{R1</span><span class="op">,</span><span class="dt">R2}{</span><span class="op">,</span><span class="dt">_unpaired}</span>.fq.gz<span class="va">)</span></span>
<span id="cb723-14"><a href="example-wgs-flow.html#cb723-14" aria-hidden="true" tabindex="-1"></a>  <span class="va">LOG=</span>results/logs/trimmomatic/<span class="va">$FP</span>.log</span>
<span id="cb723-15"><a href="example-wgs-flow.html#cb723-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb723-16"><a href="example-wgs-flow.html#cb723-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mkdir</span> <span class="at">-p</span> <span class="va">$(</span><span class="fu">dirname</span> <span class="va">$LOG</span> <span class="va">$OUTFILES)</span> <span class="co"># this could be done outside the for loop</span></span>
<span id="cb723-17"><a href="example-wgs-flow.html#cb723-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb723-18"><a href="example-wgs-flow.html#cb723-18" aria-hidden="true" tabindex="-1"></a>  <span class="ex">trimmomatic</span> PE <span class="va">$INFILES</span> <span class="va">$OUTFILES</span> <span class="va">$TRIMMER</span> <span class="op">&gt;</span> <span class="va">$LOG</span> <span class="dv">2</span><span class="op">&gt;&amp;</span><span class="dv">1</span></span>
<span id="cb723-19"><a href="example-wgs-flow.html#cb723-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb723-20"><a href="example-wgs-flow.html#cb723-20" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span></code></pre></div>
<p>You can run those, and they will likely take 15 to 20 minutues to get through.
To finish them all, you would typically want to be in a tmux session or something similar
so that the job is not killed when you logout.</p>
<p>Note that for most big and long jobs you wouldn’t run this in an interactive shell,
but, rather, you would run it through SLURM’s <code>sbatch</code>. We will be covering that next
week when we start to talk about mapping. But for now, just want to do some
interactive computing to get a flavor of how one can write and test scripts
on an interactive shell.</p>
</div>
<div id="multiqc-your-trimmomatics-results" class="section level3" number="27.5.2">
<h3><span class="header-section-number">27.5.2</span> Multiqc your trimmomatics results</h3>
<p>It turns out that Multiqc, which so nicely gobbled up and summarized our
fastqc results, also knows how to make nice summaries of the log (stderr/stdout) output
of Trimmomatic. So, once our Trimmomatic loop is done, we can run Multiqc and
direct it to <em>both</em> the directory holding the fastqc output <em>and</em> the directory holding the
Trimmomatic output, so as to get an HTML report that includes both. Witness:</p>
<div class="sourceCode" id="cb724"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb724-1"><a href="example-wgs-flow.html#cb724-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate multiqc</span>
<span id="cb724-2"><a href="example-wgs-flow.html#cb724-2" aria-hidden="true" tabindex="-1"></a><span class="ex">multiqc</span> <span class="at">-v</span> <span class="at">-f</span> <span class="at">-o</span> results/qc/multiqc results/qc/fastqc results/logs/trimmomatic</span></code></pre></div>
<p>Note that the above command includes the <code>-f</code> option to <em>force</em> it to overwrite existing
output.</p>
<p>As before, you get the results in <code>results/logs/trimmomatic/multiqc_report.html</code>, but you
have to get them on your laptop to view them easily.</p>
</div>
</div>
<div id="step-2.-mapping-each-unit-to-the-genome" class="section level2" number="27.6">
<h2><span class="header-section-number">27.6</span> Step 2. Mapping each unit to the genome</h2>
<p>Mapping or aligning reads to a genome is one of the more computationally
demanding steps in a typical WGS workflow. However, I find it somewhat
more straightforward (less prone to errors and failures and bugs in the software)
than some of the later computational steps (like creating a gVCF file from
HaplotypeCaller).</p>
Here is a figure showing where in the overall workflow this step fits in:
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:bwa-map-dag"></span>
<img src="figs/snakemake-dags/bwa-map.svg" alt="Mapping step (using bwa mem) of this section shown in color." width="100%" />
<p class="caption">
FIGURE 27.4: Mapping step (using bwa mem) of this section shown in color.
</p>
</div>
<p>There are several different software programs available for alignment. I am a fan
of the <code>bwa mem</code> algorithm, and it is commonly used in many production pipelines,
so that is what we will be using.</p>
<p>The output of <code>bwa mem</code> can often be manipulated as it comes streaming out of the program
onto <em>stdout</em>. The standard tool for manipulation such streams is <code>samtools</code>. For this
reason, when we define a conda environment for mapping steps, we will typically
include both the <code>bwa</code> program and the <code>samtools</code> program in it. So, let’s make a
conda environment called <code>bwasam</code> that has both tools in it:</p>
<div class="sourceCode" id="cb725"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb725-1"><a href="example-wgs-flow.html#cb725-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mamba</span> create <span class="at">-n</span> bwasam <span class="at">-c</span> bioconda bwa=0.7.17 samtools=1.11</span></code></pre></div>
<p>Once we have that environment, we can activate it and then look at the
syntax for <code>bwa mem</code> by typing <code>bwa mem</code>:</p>
<div class="sourceCode" id="cb726"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb726-1"><a href="example-wgs-flow.html#cb726-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate bwasam</span>
<span id="cb726-2"><a href="example-wgs-flow.html#cb726-2" aria-hidden="true" tabindex="-1"></a><span class="ex">bwa</span> mem</span></code></pre></div>
<p>The output of that is quite long. Thankfully, the default program values
are often a good place to start, and typically work well. So, for our purposes,
the most germane things to note are the main syntax statement:</p>
<div class="sourceCode" id="cb727"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb727-1"><a href="example-wgs-flow.html#cb727-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Usage:</span> bwa mem [options] <span class="op">&lt;</span>idxbase<span class="op">&gt;</span> <span class="op">&lt;</span>in1.fq<span class="op">&gt;</span> [in2.fq]</span></code></pre></div>
<p>This means you can give it options, and then you have to pass it
the path to the genome (which is also the prefix used for the bwa indexes,
as we shall see). And then you pass it a fastq file with read 1, and if you have
paired end reads you pass it the corresponding read 2 fastq file.</p>
<p>The other option that we will use is described as:</p>
<pre><code>-R STR        read group header line such as &#39;@RG\tID:foo\tSM:bar&#39; [null]</code></pre>
<p>This lets us add information to the output file about the origin of the
collection of reads in the fastq files (like what sample and library prep they
are from, what type of platform they were sequenced on, and the machine
and lane).</p>
<p>To start out with, we simply want to make a SAM file that we can use
for further explorations of what a SAM/BAM file is, and what
it means for DNA to align to a reference genome. So, make sure that
you are in your <code>non-model-wgs-example-data</code> directory, you have an
interactive compute shell, and that you have the <code>bwasam</code> conda environment
activated. Here we go!</p>
<div id="indexing-the-reference-genome-1" class="section level3" number="27.6.1">
<h3><span class="header-section-number">27.6.1</span> Indexing the reference genome</h3>
<p>The reference genome we are working with is in <code>resources/genome.fasta</code>.
In order to quickly and efficiently find places in the genome to which reads align,
it is necessary to <em>index</em> the reference genome. The bwa subcommand <code>index</code> will
index the reference genome for <code>bwa mem</code> to use.</p>
<p>To index the genome we do:</p>
<div class="sourceCode" id="cb729"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb729-1"><a href="example-wgs-flow.html#cb729-1" aria-hidden="true" tabindex="-1"></a><span class="ex">bwa</span> index resources/genome.fasta</span></code></pre></div>
<p>This takes about 40 seconds and creates the files:</p>
<pre><code>resources/genome.fasta.amb  resources/genome.fasta.bwt  resources/genome.fasta.sa
resources/genome.fasta.ann  resources/genome.fasta.pac</code></pre>
<p>The particulars of these files are not too important. Just know that they
are required for <code>bwa mem</code> to work. Note that the <code>&lt;idxbase&gt;</code> in <code>bwa mem</code>’s
syntax statement is just prefix for these 5 files: <code>resources/genome.fasta</code>.</p>
</div>
<div id="a-quick-mapping-run-to-stdout" class="section level3" number="27.6.2">
<h3><span class="header-section-number">27.6.2</span> A quick mapping run to stdout</h3>
<p>Now that the genome is indexed let’s go ahead and map the first pair of files
that we trimmed:</p>
<pre><code>results/trimmed/s001---1_R1.fq.gz  results/trimmed/s001---1_R2.fq.gz</code></pre>
<p>and we will just let the output go streaming to our screen:</p>
<div class="sourceCode" id="cb732"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb732-1"><a href="example-wgs-flow.html#cb732-1" aria-hidden="true" tabindex="-1"></a><span class="ex">bwa</span> mem resources/genome.fasta <span class="dt">\</span></span>
<span id="cb732-2"><a href="example-wgs-flow.html#cb732-2" aria-hidden="true" tabindex="-1"></a>   results/trimmed/s001---1_R1.fq.gz  <span class="dt">\</span></span>
<span id="cb732-3"><a href="example-wgs-flow.html#cb732-3" aria-hidden="true" tabindex="-1"></a>   results/trimmed/s001---1_R2.fq.gz</span></code></pre></div>
<p>You should see a whole lot of lines starting with @ come zooming by first,
then you will see some things that look like progress messages. Eventually,
a bunch of sequences start zooming by. You can hit cntrl-C to stop that.</p>
<p>OK! That was fun. Now, we are actually going to redirect that standard output
into a SAM file, but before we do that, we are going to want to add the <code>-R</code> option
to define the read group for the sequences in this file (we will talk a lot more
about read groups in a moment).</p>
<p>So,</p>
<div class="sourceCode" id="cb733"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb733-1"><a href="example-wgs-flow.html#cb733-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> results/sam  <span class="co"># a directory in which to put the output from stdout</span></span>
<span id="cb733-2"><a href="example-wgs-flow.html#cb733-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> results/logs/bwa  <span class="co"># a directory in which to put the output from stderr</span></span>
<span id="cb733-3"><a href="example-wgs-flow.html#cb733-3" aria-hidden="true" tabindex="-1"></a><span class="ex">bwa</span> mem <span class="dt">\</span></span>
<span id="cb733-4"><a href="example-wgs-flow.html#cb733-4" aria-hidden="true" tabindex="-1"></a>-R <span class="st">&#39;@RG\tID:s001_T199967_Lib-1_HY75HDSX2_1_AAGACCGT+CAATCGAC\tSM:T199967\tPL:ILLUMINA\tLB:Lib-1\tPU:HY75HDSX2.1.AAGACCGT+CAATCGAC&#39;</span> <span class="dt">\</span></span>
<span id="cb733-5"><a href="example-wgs-flow.html#cb733-5" aria-hidden="true" tabindex="-1"></a>resources/genome.fasta <span class="dt">\</span></span>
<span id="cb733-6"><a href="example-wgs-flow.html#cb733-6" aria-hidden="true" tabindex="-1"></a>results/trimmed/s001---1_R1.fq.gz  results/trimmed/s001---1_R2.fq.gz <span class="op">&gt;</span> <span class="dt">\</span></span>
<span id="cb733-7"><a href="example-wgs-flow.html#cb733-7" aria-hidden="true" tabindex="-1"></a>results/sam/s001---1.sam <span class="dv">2</span><span class="op">&gt;</span> results/logs/bwa/s001---1.log</span></code></pre></div>
<p>While that is running (and it may run for a pretty good long while) let’s just note that the read-group string in there is a horrifying
bunch of textual gobbledygook. The information that goes into it is in the
file <code>units.tsv</code>. More on read groups later.</p>
<p>For now, let’s start exploring how sequences can align, and the meaning of all the
lines in the SAM file. This is documented in Section <a href="bioinformatic-file-formats.html#sambamfiles">17.4</a>.</p>
</div>
<div id="map-with-array" class="section level3" number="27.6.3">
<h3><span class="header-section-number">27.6.3</span> Mapping all 22 pairs of trimmed FASTQ files using a SLURM job array</h3>
<p>Using all the tricks we learned in Section <a href="chap-HPCC.html#slurm-job-arrays">8.4.3</a> we are ready to map these
things. In case you missed it in class, before you proceed with this section, you will
have to undertake all the steps (to create <code>numbered-units.tsv</code> and the <code>line-assign.sh</code>
script) in Section <a href="chap-HPCC.html#more-convert-task-ids">8.4.3.5</a>. Otherwise things won’t work!</p>
<p>We can build on our mapping script in <a href="chap-HPCC.html#test-a-longer-running-sbatch">8.4.2.6</a> to have
it use <code>line_assign.sh</code> to choose different files to align to the genome in a
SLURM job array, according to the SLURM_ARRAY_TASK_ID. Hooray!</p>
<p>Here is what such a script looks like:</p>
<div class="sourceCode" id="cb734"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb734-1"><a href="example-wgs-flow.html#cb734-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb734-2"><a href="example-wgs-flow.html#cb734-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb734-3"><a href="example-wgs-flow.html#cb734-3" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --array=1-22</span></span>
<span id="cb734-4"><a href="example-wgs-flow.html#cb734-4" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --time=02:00:00</span></span>
<span id="cb734-5"><a href="example-wgs-flow.html#cb734-5" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --output=results/slurm_logs/map/map_s002---1-output-%A-%a</span></span>
<span id="cb734-6"><a href="example-wgs-flow.html#cb734-6" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --error=results/slurm_logs/map/map_s002---1-error-%A-%a </span></span>
<span id="cb734-7"><a href="example-wgs-flow.html#cb734-7" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mail-type=ALL </span></span>
<span id="cb734-8"><a href="example-wgs-flow.html#cb734-8" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mail-user=yourname@yourmail.edu</span></span>
<span id="cb734-9"><a href="example-wgs-flow.html#cb734-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb734-10"><a href="example-wgs-flow.html#cb734-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb734-11"><a href="example-wgs-flow.html#cb734-11" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> ~/.bashrc</span>
<span id="cb734-12"><a href="example-wgs-flow.html#cb734-12" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate bwasam</span>
<span id="cb734-13"><a href="example-wgs-flow.html#cb734-13" aria-hidden="true" tabindex="-1"></a><span class="bu">eval</span> <span class="va">$(</span><span class="ex">line_assign.sh</span> <span class="va">$SLURM_ARRAY_TASK_ID</span> numbered-units.tsv<span class="va">)</span> </span>
<span id="cb734-14"><a href="example-wgs-flow.html#cb734-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb734-15"><a href="example-wgs-flow.html#cb734-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb734-16"><a href="example-wgs-flow.html#cb734-16" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> results/bam  <span class="co"># a directory in which to put the output from stdout</span></span>
<span id="cb734-17"><a href="example-wgs-flow.html#cb734-17" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> results/logs/bwa  <span class="co"># a directory in which to put the output from stderr</span></span>
<span id="cb734-18"><a href="example-wgs-flow.html#cb734-18" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> results/logs/samtools-sort</span>
<span id="cb734-19"><a href="example-wgs-flow.html#cb734-19" aria-hidden="true" tabindex="-1"></a><span class="va">SU=${sample}</span>---<span class="va">${unit}</span></span>
<span id="cb734-20"><a href="example-wgs-flow.html#cb734-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb734-21"><a href="example-wgs-flow.html#cb734-21" aria-hidden="true" tabindex="-1"></a><span class="va">RGID=${sample}</span>_<span class="va">${sample_id}</span>_<span class="va">${library}</span>_<span class="va">${flowcell}</span>_<span class="va">${lane}</span>_<span class="va">${barcode}</span></span>
<span id="cb734-22"><a href="example-wgs-flow.html#cb734-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb734-23"><a href="example-wgs-flow.html#cb734-23" aria-hidden="true" tabindex="-1"></a><span class="va">RG=</span><span class="st">&quot;@RG\tID:</span><span class="va">${RGID}</span><span class="st">\tSM:</span><span class="va">${sample}</span><span class="st">\tPL:</span><span class="va">${platform}</span><span class="st">\tLB:</span><span class="va">${library}</span><span class="st">\tPU:</span><span class="va">${flowcell}</span><span class="st">.</span><span class="va">${lane}</span><span class="st">.</span><span class="va">${barcode}</span><span class="st">&quot;</span></span>
<span id="cb734-24"><a href="example-wgs-flow.html#cb734-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb734-25"><a href="example-wgs-flow.html#cb734-25" aria-hidden="true" tabindex="-1"></a><span class="va">PREFIX=</span>results/trimmed/<span class="va">$SU</span></span>
<span id="cb734-26"><a href="example-wgs-flow.html#cb734-26" aria-hidden="true" tabindex="-1"></a><span class="va">OUT=</span>results/bam/<span class="va">$SU</span>.bam</span>
<span id="cb734-27"><a href="example-wgs-flow.html#cb734-27" aria-hidden="true" tabindex="-1"></a><span class="va">BWALOG=</span>results/logs/bwa/<span class="va">$SU</span>.log</span>
<span id="cb734-28"><a href="example-wgs-flow.html#cb734-28" aria-hidden="true" tabindex="-1"></a><span class="va">SAMSORTLOG=</span>results/logs/samtools-sort/<span class="va">$SU</span>.log</span>
<span id="cb734-29"><a href="example-wgs-flow.html#cb734-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb734-30"><a href="example-wgs-flow.html#cb734-30" aria-hidden="true" tabindex="-1"></a><span class="ex">bwa</span> mem <span class="dt">\</span></span>
<span id="cb734-31"><a href="example-wgs-flow.html#cb734-31" aria-hidden="true" tabindex="-1"></a>-R <span class="va">$RG</span> <span class="dt">\</span></span>
<span id="cb734-32"><a href="example-wgs-flow.html#cb734-32" aria-hidden="true" tabindex="-1"></a>resources/genome.fasta <span class="dt">\</span></span>
<span id="cb734-33"><a href="example-wgs-flow.html#cb734-33" aria-hidden="true" tabindex="-1"></a><span class="va">${PREFIX}</span>_R1.fq.gz  <span class="va">${PREFIX}</span>_R2.fq.gz <span class="dv">2</span><span class="op">&gt;</span> <span class="va">$BWALOG</span> <span class="kw">|</span>  <span class="dt">\</span></span>
<span id="cb734-34"><a href="example-wgs-flow.html#cb734-34" aria-hidden="true" tabindex="-1"></a><span class="ex">samtools</span> view <span class="at">-u</span> <span class="at">-</span> <span class="kw">|</span>  <span class="dt">\</span></span>
<span id="cb734-35"><a href="example-wgs-flow.html#cb734-35" aria-hidden="true" tabindex="-1"></a><span class="ex">samtools</span> sort <span class="at">-l</span> 9 <span class="at">-o</span> <span class="va">$OUT</span> <span class="at">-</span> <span class="dv">2</span><span class="op">&gt;</span> <span class="va">$SAMSORTLOG</span></span></code></pre></div>
<p>As you can see, we were able to use most of our original test script. We just
need to define <code>SU</code> and <code>RG</code> a little differently, according to the
value of <code>SLURM_ARRAY_TASK_ID</code>, and we added an <code>#SBATCH --array=1-22</code>
line. (Because there are 22 rows in our <code>numbered-units.tsv</code> file!).
Also we named the slurm output and error files according to the <code>%A_%a</code>
nomenclature.</p>
<div id="step-through-this-interactively-to-make-sure-it-looks-right" class="section level4" number="27.6.3.1">
<h4><span class="header-section-number">27.6.3.1</span> Step through this interactively to make sure it looks right</h4>
<p>Before trying to run something like this, it is always good to “pretend”
it is being run as a SLURM array job by spoofing the variable
<code>SLURM_ARRAY_TASK_ID</code>. In other words, on an interactive shell
you can just set a shell variable called <code>SLURM_ARRAY_TASK_ID</code>
to whatever value you want to (let’s choose 5 here!) like this:</p>
<div class="sourceCode" id="cb735"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb735-1"><a href="example-wgs-flow.html#cb735-1" aria-hidden="true" tabindex="-1"></a><span class="va">SLURM_ARRAY_TASK_ID=</span>5</span></code></pre></div>
<p>then you can go through the above script line by line and make sure
that all the variables get set to appropriate values. After evaluating
each line in which a variable value gets set, check the value of that
variable using <code>echo</code>.</p>
<p>If everything looks right, you could even evaluate all the 6 lines of the main
command and let it run for a little while to make sure that what is coming into
the output files and logs looks correct. But, you don’t have to do that now.</p>
</div>
<div id="put-that-script-into-map-array-job.sh-and-run-it-with---test-only" class="section level4" number="27.6.3.2">
<h4><span class="header-section-number">27.6.3.2</span> Put that script into <code>map-array-job.sh</code> and run it with <code>--test-only</code></h4>
<p>Make a new script with nano by doing:</p>
<div class="sourceCode" id="cb736"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb736-1"><a href="example-wgs-flow.html#cb736-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nano</span> scripts/map-array-job.sh</span></code></pre></div>
<p>paste the contents of the above script into it, change the email address
for notification emails, and the save and exit.</p>
<p>Then run it under <code>sbatch</code> but use the <code>--test-only</code> option:</p>
<div class="sourceCode" id="cb737"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb737-1"><a href="example-wgs-flow.html#cb737-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> <span class="at">--test-only</span> scripts/map-array-job.sh</span></code></pre></div>
<p>That works, but note that <code>--test-only</code> doesn’t see to let you know that this
is an array job. Whatever!</p>
</div>
<div id="run-just-the-first-job" class="section level4" number="27.6.3.3">
<h4><span class="header-section-number">27.6.3.3</span> Run just the first job</h4>
<p>You should never launch a large job array without at least launching a few of them
first, to make sure that it doesn’t fail immediately. We can use <code>--array=1-3</code> on the command
launch just the first three jobs.</p>
<p>Note also that you always want to make sure that you have created any directories
necessary for storing the slurm_log output.</p>
<p>Here we go!</p>
<div class="sourceCode" id="cb738"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb738-1"><a href="example-wgs-flow.html#cb738-1" aria-hidden="true" tabindex="-1"></a><span class="co"># first, make sure the directories are there</span></span>
<span id="cb738-2"><a href="example-wgs-flow.html#cb738-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> results/slurm_logs/map/</span>
<span id="cb738-3"><a href="example-wgs-flow.html#cb738-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb738-4"><a href="example-wgs-flow.html#cb738-4" aria-hidden="true" tabindex="-1"></a><span class="co"># then launch the first three jobs</span></span>
<span id="cb738-5"><a href="example-wgs-flow.html#cb738-5" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> <span class="at">--array</span><span class="op">=</span>1-3 scripts/map-array-job.sh</span></code></pre></div>
<p>Then use your <code>myjobs</code> alias to see when that starts. Once it has started, check the
file <code>results/logs/bwa/s001---1.log</code> to make sure that stuff is coming out that looks
like what you expect.</p>
</div>
<div id="if-the-last-step-looked-good-then-launch-the-remaining-jobs" class="section level4" number="27.6.3.4">
<h4><span class="header-section-number">27.6.3.4</span> If the last step looked good, then launch the remaining jobs</h4>
<p>Once again, the power of overriding the internal SBATCH directives in the script
come in handy here, setting <code>--array=4-22</code> to do the remaining 19 jobs.</p>
<div class="sourceCode" id="cb739"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb739-1"><a href="example-wgs-flow.html#cb739-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> <span class="at">--array</span><span class="op">=</span>4-22 scripts/map-array-job.sh</span></code></pre></div>
<p>That should map all those trimmed reads to the genome. Woo-hoo!</p>
</div>
</div>
</div>
<div id="step-3.-mark-duplicates-in-bam-files-from-each-individual-and-run-samtools-stats-on-the-results" class="section level2" number="27.7">
<h2><span class="header-section-number">27.7</span> Step 3. Mark duplicates in BAM files from each individual, and run <code>samtools stats</code> on the results</h2>
<p>I used to identify (and either remove or mark) duplicates with some of the subcommands
of the <code>samtools</code> package. But it turns out that MarkDuplicates from
the Picard Tools package, from the Broad Institute, has a few
advantages. Chief among those is the fact that, with MarkDuplicates, it is not
necessary to merge all of the BAM files from a single individual and
library prep to mark duplicates. Although the documentation about this
is surprisingly spotty, Picard’s MarkDuplicates is
sufficiently aware of the read groups attached to different reads that it can
automatically only consider reads from the same library and individual
as PCR duplicates (so long as the read group of each group of reads has
been properly set, with the <code>LB</code> read-group key set, as we did during
the mapping step, above).</p>
Here is our DAG showing what steps we are talking about in this section:
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:mark-dup-dag"></span>
<img src="figs/snakemake-dags/mark-dup.svg" alt="Marking PCR and optical duplicates and also running samtools stats described in this section." width="100%" />
<p class="caption">
FIGURE 27.5: Marking PCR and optical duplicates and also running samtools stats described in this section.
</p>
</div>
<p>In order to use MarkDuplicates, we first need to get the
Picard Tools package. So, our first task is going to be to get those
with <code>mamba</code>. We will want version 2.26 (which is pretty
much the latest minor release as of this writing), so we do:</p>
<div class="sourceCode" id="cb740"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb740-1"><a href="example-wgs-flow.html#cb740-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mamba</span> create <span class="at">-n</span> picard <span class="at">-c</span> bioconda picard=2.26</span></code></pre></div>
<p>Once that is installed we can activate the environment and
check out the syntax for the MarkDuplicates tool.</p>
<div class="sourceCode" id="cb741"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb741-1"><a href="example-wgs-flow.html#cb741-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate picard</span>
<span id="cb741-2"><a href="example-wgs-flow.html#cb741-2" aria-hidden="true" tabindex="-1"></a><span class="ex">picard</span> MarkDuplicates <span class="at">--help</span></span></code></pre></div>
<p>The help file notes that duplicates are identified as reads in which
each mate maps to the same location in the genome (i.e. they have the
same 5’ position) and which have sequences that are similar. It also
tells us that the read that is “retained” as the “non-duplicate” is chosen
to have the highest base quality scores, on average.</p>
<p>We also see that we can provide multiple
BAM files, simultaneously, to MarkDuplicates, by giving the
<code>-I</code> or <code>--INPUT</code> command multiple times, following it, each time,
with the path to a different BAM file.</p>
<p>So, we need an easy way to write a command line that includes a
<code>-I</code> option for each of the BAM files
that are associated with any single sample. We will do that
by making a TAB separated file from which we can pull values with
our <code>line_assign.sh</code> script. This file will have three columns: <code>index</code> will give
the row number in the file, <code>sample</code> will give the name of the sample
(like <code>s001</code>, <code>s002</code>, etc.), and
<code>bamopts</code> will hold a <em>space-separated</em> string of the BAM files that
hold reads from the sample, each preceded by the <code>-I</code> option that
MarkDuplicates requires before each BAM path.</p>
<p>We can create such a file by processing our <code>units.tsv</code> file with
the <code>awk</code> utility.
You should go back and review the section on <code>awk</code>’s use of associative (or “hash”)
arrays to better understand how the following combination of an awk script and the unix
<code>sort</code> utility gives us a numbered TSV file that provides a list of bam file paths
that contain reads from a given sample. The comments
in the following script also give some detail.</p>
<div class="sourceCode" id="cb742"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb742-1"><a href="example-wgs-flow.html#cb742-1" aria-hidden="true" tabindex="-1"></a><span class="fu">awk</span> <span class="at">-F</span><span class="st">&quot;\t&quot;</span> <span class="st">&#39;</span></span>
<span id="cb742-2"><a href="example-wgs-flow.html#cb742-2" aria-hidden="true" tabindex="-1"></a><span class="st">  BEGIN {</span></span>
<span id="cb742-3"><a href="example-wgs-flow.html#cb742-3" aria-hidden="true" tabindex="-1"></a><span class="st">    OFS=&quot;\t&quot;;     # separate output fields with TABs </span></span>
<span id="cb742-4"><a href="example-wgs-flow.html#cb742-4" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb742-5"><a href="example-wgs-flow.html#cb742-5" aria-hidden="true" tabindex="-1"></a><span class="st">  NR==1 {next;}   # ignore the first line</span></span>
<span id="cb742-6"><a href="example-wgs-flow.html#cb742-6" aria-hidden="true" tabindex="-1"></a><span class="st">  { # in this block, store a space-separated string of &quot;-I filpath.bam&quot; for all the</span></span>
<span id="cb742-7"><a href="example-wgs-flow.html#cb742-7" aria-hidden="true" tabindex="-1"></a><span class="st">    # files that have reads from a give sample.  The variable bams is an</span></span>
<span id="cb742-8"><a href="example-wgs-flow.html#cb742-8" aria-hidden="true" tabindex="-1"></a><span class="st">    # associative or &quot;hash&quot; array (like a &quot;dictionary&quot; in Python) that holds those</span></span>
<span id="cb742-9"><a href="example-wgs-flow.html#cb742-9" aria-hidden="true" tabindex="-1"></a><span class="st">    # strings.</span></span>
<span id="cb742-10"><a href="example-wgs-flow.html#cb742-10" aria-hidden="true" tabindex="-1"></a><span class="st">    bams[$1] = sprintf(&quot;%s -I results/bam/%s---%s.bam&quot;, bams[$1], $1, $2);</span></span>
<span id="cb742-11"><a href="example-wgs-flow.html#cb742-11" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb742-12"><a href="example-wgs-flow.html#cb742-12" aria-hidden="true" tabindex="-1"></a><span class="st">  END { # at the end, print out the keys of bams and the paths associated with each</span></span>
<span id="cb742-13"><a href="example-wgs-flow.html#cb742-13" aria-hidden="true" tabindex="-1"></a><span class="st">        # in two columns</span></span>
<span id="cb742-14"><a href="example-wgs-flow.html#cb742-14" aria-hidden="true" tabindex="-1"></a><span class="st">    for(i in bams) print i, bams[i]</span></span>
<span id="cb742-15"><a href="example-wgs-flow.html#cb742-15" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb742-16"><a href="example-wgs-flow.html#cb742-16" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;</span> units.tsv <span class="kw">|</span> <span class="dt">\</span></span>
<span id="cb742-17"><a href="example-wgs-flow.html#cb742-17" aria-hidden="true" tabindex="-1"></a><span class="ex">sort</span> <span class="kw">|</span>  <span class="dt">\</span></span>
<span id="cb742-18"><a href="example-wgs-flow.html#cb742-18" aria-hidden="true" tabindex="-1"></a><span class="ex">awk</span> <span class="at">-F</span> <span class="st">&quot;\t&quot;</span> <span class="st">&#39; # print these lines out in a numbered TSV file.</span></span>
<span id="cb742-19"><a href="example-wgs-flow.html#cb742-19" aria-hidden="true" tabindex="-1"></a><span class="st">  BEGIN {printf(&quot;index\tsample\tbamopts\n&quot;);}  # print a header line</span></span>
<span id="cb742-20"><a href="example-wgs-flow.html#cb742-20" aria-hidden="true" tabindex="-1"></a><span class="st">  {printf(&quot;%d\t%s\t%s\n&quot;, ++n, $1, $2, $3)}  # print out each numbered line</span></span>
<span id="cb742-21"><a href="example-wgs-flow.html#cb742-21" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;</span> <span class="op">&gt;</span> numbered-sample-bams.tsv</span></code></pre></div>
<p>The file, <code>numbered-sample-bams.tsv</code> created by this short script looks like this:</p>
<pre><code>index   sample  bamopts
1   s001     -I results/bam/s001---1.bam
2   s002     -I results/bam/s002---1.bam -I results/bam/s002---2.bam
3   s003     -I results/bam/s003---1.bam -I results/bam/s003---2.bam -I results/bam/s003---3.bam
4   s004     -I results/bam/s004---1.bam -I results/bam/s004---2.bam
5   s005     -I results/bam/s005---1.bam -I results/bam/s005---2.bam -I results/bam/s005---3.bam
6   s006     -I results/bam/s006---1.bam -I results/bam/s006---2.bam -I results/bam/s006---3.bam -I results/bam/s006---4.bam
7   s007     -I results/bam/s007---1.bam -I results/bam/s007---2.bam -I results/bam/s007---3.bam -I results/bam/s007---4.bam
8   s008     -I results/bam/s008---1.bam -I results/bam/s008---2.bam -I results/bam/s008---3.bam</code></pre>
<p>This shows that there are 8 distinct samples, and each one of those samples
is associated with between 1 and 4 BAM files of mapped reads.</p>
<p>Since these files are not large and running MarkDuplicates does
not take as much time as mapping reads, we will simply cycle over these different
8 samples using the <code>line_assign.sh</code> script in an interactive shell
<em>on a compute node</em>. MarkDuplicates writes results out to a single BAM
file, and also writes out a “metrics” file that gives information on
how many duplicates were found. It also allows an optional <code>--TAGGING_POLICY</code>
option to instruct the program to make a note of whether each duplicate
is a PCR duplicate or an optical duplicate. We will invoke that
option.</p>
<p>Additionally, MarkDuplicates can create an index for the BAM file it produces.
This index is much like the one created by the <code>samtools index</code> subcommand; however,
rather than creating an index file named <code>file-prefix.bam.bai</code>, it creates
<code>file-prefix.bai</code>. So, we will also instruct MarkDuplicates to create a directory
for the BAM file, as that will save us a step later on!</p>
<div class="sourceCode" id="cb744"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb744-1"><a href="example-wgs-flow.html#cb744-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate picard</span>
<span id="cb744-2"><a href="example-wgs-flow.html#cb744-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> results/mkdup-merged results/qc/mkdup-merged results/logs/mkdup-merged</span>
<span id="cb744-3"><a href="example-wgs-flow.html#cb744-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> LINE <span class="kw">in</span> {1..8}<span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb744-4"><a href="example-wgs-flow.html#cb744-4" aria-hidden="true" tabindex="-1"></a>  <span class="bu">eval</span> <span class="va">$(</span><span class="ex">line_assign.sh</span> <span class="va">$LINE</span> numbered-sample-bams.tsv<span class="va">)</span></span>
<span id="cb744-5"><a href="example-wgs-flow.html#cb744-5" aria-hidden="true" tabindex="-1"></a>  <span class="bu">echo</span> <span class="st">&quot;Marking duplicates for sample </span><span class="va">$sample</span><span class="st">&quot;</span></span>
<span id="cb744-6"><a href="example-wgs-flow.html#cb744-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb744-7"><a href="example-wgs-flow.html#cb744-7" aria-hidden="true" tabindex="-1"></a>  <span class="va">OUT=</span>results/mkdup-merged/<span class="va">$sample</span>.bam</span>
<span id="cb744-8"><a href="example-wgs-flow.html#cb744-8" aria-hidden="true" tabindex="-1"></a>  <span class="va">MET=</span>results/qc/mkdup-merged/<span class="va">$sample</span>.metrics</span>
<span id="cb744-9"><a href="example-wgs-flow.html#cb744-9" aria-hidden="true" tabindex="-1"></a>  <span class="va">LOG=</span>results/logs/mkdup-merged/<span class="va">$sample</span>.log</span>
<span id="cb744-10"><a href="example-wgs-flow.html#cb744-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb744-11"><a href="example-wgs-flow.html#cb744-11" aria-hidden="true" tabindex="-1"></a>  <span class="ex">picard</span> MarkDuplicates <span class="va">$bamopts</span> <span class="dt">\</span></span>
<span id="cb744-12"><a href="example-wgs-flow.html#cb744-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">--OUTPUT</span> <span class="va">$OUT</span> <span class="dt">\</span></span>
<span id="cb744-13"><a href="example-wgs-flow.html#cb744-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">--METRICS_FILE</span> <span class="va">$MET</span> <span class="dt">\</span></span>
<span id="cb744-14"><a href="example-wgs-flow.html#cb744-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">--TAGGING_POLICY</span> All <span class="dt">\</span></span>
<span id="cb744-15"><a href="example-wgs-flow.html#cb744-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">--CREATE_INDEX</span> <span class="op">&gt;</span> <span class="va">$LOG</span> <span class="dv">2</span><span class="op">&gt;&amp;</span><span class="dv">1</span></span>
<span id="cb744-16"><a href="example-wgs-flow.html#cb744-16" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span></code></pre></div>
<p>That should only take a few minutes.</p>
<p>Once that is done we will look at the resulting bamfiles with <code>samtools</code>,
and compare them to the BAM files before duplicates were marked, just to see
that some things have been marked as duplicates. Recall from
MarkDuplicates’ help information that duplicates have the 0x400 bit set
in their SAM flags. So, we can look at the sequences marked as duplicates
with <code>samtools view</code> telling it, with the <code>-f 0x400</code> option to only print
sequences having that 0x400 bit set.</p>
<p>For example:</p>
<div class="sourceCode" id="cb745"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb745-1"><a href="example-wgs-flow.html#cb745-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate bwasam</span>
<span id="cb745-2"><a href="example-wgs-flow.html#cb745-2" aria-hidden="true" tabindex="-1"></a><span class="ex">samtools</span> view <span class="at">-f</span> 0x400 results/mkdup-merged/s001.bam <span class="kw">|</span> <span class="fu">less</span></span></code></pre></div>
<p>Note that the final column on each row has some information tagged with <code>DT</code>.
This let’s us know whether the duplicate was a PCR duplicate (formed during
library prep) or an optical duplicate (a cluster on the sequencing machine
that was incorrectly split into two spots).</p>
<p>We can use awk to count up the number of different <code>DT</code> tags in the
last column of each row having a duplicated sequence in it, like this:</p>
<div class="sourceCode" id="cb746"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb746-1"><a href="example-wgs-flow.html#cb746-1" aria-hidden="true" tabindex="-1"></a><span class="co"># here we can count how many of each tag we see</span></span>
<span id="cb746-2"><a href="example-wgs-flow.html#cb746-2" aria-hidden="true" tabindex="-1"></a><span class="ex">samtools</span> view <span class="at">-f</span> 0x400 results/mkdup-merged/s001.bam <span class="kw">|</span> <span class="dt">\</span></span>
<span id="cb746-3"><a href="example-wgs-flow.html#cb746-3" aria-hidden="true" tabindex="-1"></a>  awk <span class="st">&#39;{n[$NF]++} END {for(i in n) print i, n[i]}&#39;</span></span></code></pre></div>
<p>The <code>DT</code> tag either has an <code>LB</code> if it is a PCR-duplicate (it is a consequence
of the <em>library</em>, hence the <code>LB</code>) or it has an <code>SQ</code> if it is an optical
duplicate (it is a consequence of the sequencing platform, hence <code>SQ</code>).</p>
<p>If you look at any of the original BAM files (before marking duplicates)
you will find that none of them have any reads marked as duplicates
(which is not surpring—that is why we ran them through MarkDuplicates.)</p>
<div class="sourceCode" id="cb747"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb747-1"><a href="example-wgs-flow.html#cb747-1" aria-hidden="true" tabindex="-1"></a><span class="ex">samtools</span> view <span class="at">-f</span> 0x400 results/bam/s001---1.bam <span class="kw">|</span> <span class="fu">head</span></span></code></pre></div>
<p>When reads are marked as duplicates, they will be automatically ignored during
variant calling (which we start in the next step!) by GATK’s variant-calling
programs. They can also be ignored in ANGSD and most other variant calling programs.</p>
<div id="run-samtools-stats-on-the-results" class="section level3" number="27.7.1">
<h3><span class="header-section-number">27.7.1</span> Run samtools stats on the results</h3>
<p>Each sample is now in a single BAM file. For quality checking these, it can be
a good idea to run <code>samtools stats</code> on them. That utility returns a fairly
comprehensive summary of any BAM file.</p>
<p>This doesn’t take long to run, and we can easily do it with a for loop over
filenames:</p>
<div class="sourceCode" id="cb748"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb748-1"><a href="example-wgs-flow.html#cb748-1" aria-hidden="true" tabindex="-1"></a><span class="co"># make a directory for the results</span></span>
<span id="cb748-2"><a href="example-wgs-flow.html#cb748-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> results/qc/samtools-stats</span>
<span id="cb748-3"><a href="example-wgs-flow.html#cb748-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb748-4"><a href="example-wgs-flow.html#cb748-4" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate bwasam  <span class="co"># to have samtools</span></span>
<span id="cb748-5"><a href="example-wgs-flow.html#cb748-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> FILE <span class="kw">in</span> results/mkdup-merged/<span class="pp">*</span>.bam<span class="kw">;</span> <span class="cf">do</span> </span>
<span id="cb748-6"><a href="example-wgs-flow.html#cb748-6" aria-hidden="true" tabindex="-1"></a>  <span class="va">j=$(</span><span class="fu">basename</span> <span class="va">$FILE)</span><span class="kw">;</span> </span>
<span id="cb748-7"><a href="example-wgs-flow.html#cb748-7" aria-hidden="true" tabindex="-1"></a>  <span class="bu">echo</span> <span class="va">$j</span><span class="kw">;</span> </span>
<span id="cb748-8"><a href="example-wgs-flow.html#cb748-8" aria-hidden="true" tabindex="-1"></a>  <span class="ex">samtools</span> stats <span class="va">$FILE</span> <span class="op">&gt;</span> results/qc/samtools-stats/<span class="va">${j}</span>_stats  </span>
<span id="cb748-9"><a href="example-wgs-flow.html#cb748-9" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span></code></pre></div>
<p>When that is done, it is worth looking through all the different summaries. For example:</p>
<div class="sourceCode" id="cb749"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb749-1"><a href="example-wgs-flow.html#cb749-1" aria-hidden="true" tabindex="-1"></a><span class="fu">less</span> results/qc/samtools-stats/s008.bam_stats</span></code></pre></div>
<p>They give the distribution of a lot of different features of the mapped reads.</p>
<p>MultiQC has some capability to plot some of the features in the <code>samtools stats</code>
summaries. You can see those by doing.</p>
<div class="sourceCode" id="cb750"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb750-1"><a href="example-wgs-flow.html#cb750-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate multiqc</span>
<span id="cb750-2"><a href="example-wgs-flow.html#cb750-2" aria-hidden="true" tabindex="-1"></a><span class="ex">multiqc</span> results/qc/samtools-stats/<span class="pp">*</span>.bam_stats</span></code></pre></div>
<p>and then copying the multiqc_report.html to your laptop and opening it in a browser.
With as little data as we have in these files, it is not super interesting to look at them.</p>
<p>MultiQC (at least a suitable new version of it) can also process the “metrics” files from
MarkDuplicates. So you can do:</p>
<div class="sourceCode" id="cb751"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb751-1"><a href="example-wgs-flow.html#cb751-1" aria-hidden="true" tabindex="-1"></a><span class="ex">multiqc</span> <span class="at">-f</span> results/qc/samtools-stats/<span class="pp">*</span>.bam_stats results/qc/mkdup-merged/<span class="pp">*</span>.metrics</span></code></pre></div>
<p>For that to work, I had to get a newer version of MultiQC than I had, which meant I
needed to do this first.</p>
<div class="sourceCode" id="cb752"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb752-1"><a href="example-wgs-flow.html#cb752-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> env remove <span class="at">--name</span> multiqc</span>
<span id="cb752-2"><a href="example-wgs-flow.html#cb752-2" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> config <span class="at">--add</span> channels defaults</span>
<span id="cb752-3"><a href="example-wgs-flow.html#cb752-3" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> config <span class="at">--add</span> channels conda-forge</span>
<span id="cb752-4"><a href="example-wgs-flow.html#cb752-4" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> config <span class="at">--add</span> channels bioconda</span>
<span id="cb752-5"><a href="example-wgs-flow.html#cb752-5" aria-hidden="true" tabindex="-1"></a><span class="ex">mamba</span> create <span class="at">-n</span> multiqc <span class="at">-c</span> bioconda multiqc=1.12</span></code></pre></div>
<hr />
<p>Now we have 8 BAM files. Each one has all the reads from a single
individual. Duplicates in them have been marked, and they each have
an index. Therefore, it is time to proceed to the variant calling
steps.</p>
</div>
</div>
<div id="make-gvcfs" class="section level2" number="27.8">
<h2><span class="header-section-number">27.8</span> Step 4. Creating a gVCF file for each sample</h2>
<p>Yay! We are finally going to start turning our alignments into variants.
But don’t get too excited just yet, because the GATK gVCF workflow involves
three separate steps to take us from our duplicate-marked BAM files to
a VCF file with variants. Here we are doing the first step: creating one
gVCF file for each of our samples.</p>
Here is our DAG showing what steps we are talking about in this section:
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:make-gvcfs-dag"></span>
<img src="figs/snakemake-dags/make-gvcfs.svg" alt="Running HaplotypeCaller to create one gVCF file for each sample." width="100%" />
<p class="caption">
FIGURE 27.6: Running HaplotypeCaller to create one gVCF file for each sample.
</p>
</div>
<p>This is the first step where we are starting to use the tools of the GATK package,
so we will have to create a conda environment with GATK. That will be our first
step. It is important at this time to get GATK version 4.2.5.0, which is the
latest no-architecture version available on conda as of 3/29/22. The previous version,
4.2.4.1 had some bugs that caused problems when genotyping gVCFs from the
genomics data bases for some of my non-human data (details <a href="https://github.com/broadinstitute/gatk/issues/7639#issuecomment-1014180059">here</a>).
There might be some residual problems left in 4.2.5.0 (see <a href="https://github.com/broadinstitute/gatk/issues/7639#issuecomment-1049126046">here</a>),
but it should work for our small example data set, today.</p>
<p>By now we know the drill:</p>
<div class="sourceCode" id="cb753"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb753-1"><a href="example-wgs-flow.html#cb753-1" aria-hidden="true" tabindex="-1"></a><span class="co"># on scompile</span></span>
<span id="cb753-2"><a href="example-wgs-flow.html#cb753-2" aria-hidden="true" tabindex="-1"></a><span class="ex">mamba</span> create <span class="at">-n</span> gatk4.2.5.0 <span class="at">-c</span> bioconda gatk4=4.2.5.0</span>
<span id="cb753-3"><a href="example-wgs-flow.html#cb753-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb753-4"><a href="example-wgs-flow.html#cb753-4" aria-hidden="true" tabindex="-1"></a><span class="co"># when that is done, activate it</span></span>
<span id="cb753-5"><a href="example-wgs-flow.html#cb753-5" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate gatk4.2.5.0</span></code></pre></div>
<p>Since this is our first time with GATK, it is worth getting a glimpse of all the
tools available from the GATK package:</p>
<div class="sourceCode" id="cb754"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb754-1"><a href="example-wgs-flow.html#cb754-1" aria-hidden="true" tabindex="-1"></a><span class="ex">gatk</span> <span class="at">--list</span></span></code></pre></div>
<p>Holy Moly! That is a lot of different programs!</p>
<p>To get the syntax and documentation for any particular tool you can use
<code>gatk ToolName --help</code>, so, for our case:</p>
<div class="sourceCode" id="cb755"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb755-1"><a href="example-wgs-flow.html#cb755-1" aria-hidden="true" tabindex="-1"></a><span class="ex">gatk</span> HaplotypeCaller <span class="at">--help</span></span></code></pre></div>
<p>Whoa! That spits out a lot of options. At this juncture, it is worth noting
that the GATK tools have comprehensive documentation available
on the web, too. Sometimes it is easier to read the docs there than on your Unix
terminal. A Google search of <em>GATK toolname</em>, like “GATK HaplotypeCaller” will typically
return the documentation as the first hit. Here is a link to the
<a href="https://gatk.broadinstitute.org/hc/en-us/articles/360037225632-HaplotypeCaller">HaplotypeCaller documentation</a>.</p>
<p>The documentation on the web also provides a nice example for how
HaplotypeCaller should be called for this first step in the gVCF
workflow. It looks like this:</p>
<blockquote>
<p>Single-sample GVCF calling (outputs intermediate GVCF)</p>
</blockquote>
<div class="sourceCode" id="cb756"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb756-1"><a href="example-wgs-flow.html#cb756-1" aria-hidden="true" tabindex="-1"></a> <span class="ex">gatk</span> <span class="at">--java-options</span> <span class="st">&quot;-Xmx4g&quot;</span> HaplotypeCaller  <span class="dt">\</span></span>
<span id="cb756-2"><a href="example-wgs-flow.html#cb756-2" aria-hidden="true" tabindex="-1"></a>   <span class="at">-R</span> Homo_sapiens_assembly38.fasta <span class="dt">\</span></span>
<span id="cb756-3"><a href="example-wgs-flow.html#cb756-3" aria-hidden="true" tabindex="-1"></a>   <span class="at">-I</span> input.bam <span class="dt">\</span></span>
<span id="cb756-4"><a href="example-wgs-flow.html#cb756-4" aria-hidden="true" tabindex="-1"></a>   <span class="at">-O</span> output.g.vcf.gz <span class="dt">\</span></span>
<span id="cb756-5"><a href="example-wgs-flow.html#cb756-5" aria-hidden="true" tabindex="-1"></a>   <span class="at">-ERC</span> GVCF</span></code></pre></div>
<p>So, we need as input:</p>
<ol style="list-style-type: decimal">
<li>The reference genome the reads were mapped to</li>
<li>The input BAM which must be sorted and preferably has been duplicate marked. It
also needs to be indexed, i.e. there must be a <code>.bai</code> file associated with each.</li>
<li>The name of the output file</li>
<li>The option <code>-ERC GVCF</code>. This tells HaplotypeCaller to make a gVCF, rather than
to attempt to got “direct-to-VCF.”</li>
</ol>
<div id="thats-a-dict-thing-to-do" class="section level3" number="27.8.1">
<h3><span class="header-section-number">27.8.1</span> That’s a dict thing to do!</h3>
<p>What isn’t mentioned in the documentation is that HaplotypeCaller also requires that
the reference genome be indexed in two different ways. It must have a <code>.fai</code> file (for
example created using <code>samtools faidx</code>) and it must have a <code>.dict</code> or “dictionary” file
for the genome. This can also be create with samtools using <code>samtools dict</code>. These
steps are visible in our workflow DAG. Let’s make sure that we both of those
necessary indexes by doing this:</p>
<div class="sourceCode" id="cb757"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb757-1"><a href="example-wgs-flow.html#cb757-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate bwasam</span>
<span id="cb757-2"><a href="example-wgs-flow.html#cb757-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb757-3"><a href="example-wgs-flow.html#cb757-3" aria-hidden="true" tabindex="-1"></a><span class="ex">samtools</span> faidx resources/genome.fasta</span>
<span id="cb757-4"><a href="example-wgs-flow.html#cb757-4" aria-hidden="true" tabindex="-1"></a><span class="ex">samtools</span> dict resources/genome.fasta <span class="op">&gt;</span> resources/genome.dict</span>
<span id="cb757-5"><a href="example-wgs-flow.html#cb757-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb757-6"><a href="example-wgs-flow.html#cb757-6" aria-hidden="true" tabindex="-1"></a><span class="co"># and when done, reactivate our gatk4 environment</span></span>
<span id="cb757-7"><a href="example-wgs-flow.html#cb757-7" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate gatk4.2.5.0</span></code></pre></div>
</div>
<div id="setting-up-a-slurm-job-array-for-this" class="section level3" number="27.8.2">
<h3><span class="header-section-number">27.8.2</span> Setting up a SLURM job array for this</h3>
<p>We are going to run these jobs using a SLURM job array.
Each task will be given one CPU. Because of this, we also
want to tell HaplotypeCaller to only use a single thread for
its pair hidden Markov model (by default it uses 4 threads, which is not
helpful if we have allocated only a single core for the job). So, the
command line will include the line <code>--native-pair-hmm-threads 1</code>.</p>
<p>Additionally, since all the GATK tools are implemented in Java, they run
under the Java virtual machine on our computers. We can specify how much
memory (RAM) is allocated to the Java virtual machine in order to host GATK.
We have about 4848 Mb of RAM per core on SUMMIT, so we will give 4000 Mb, or 4Gb of
RAM to the Java virtual machine. This should be more than enough. But it is worth
noting that sometimes you can run out of memory, in which case you would
have to re-run the job and give it more memory. To provide a certain amount of
memory to the Java virtual machine, or, in fact, to supply any particular
options to Java, we will use the <code>--java-opts</code> option to <code>gatk</code>. This goes
before the tool name, like this: <code>gatk --java-opts "quoted string of options to pass to Java" ToolName</code>. In our case, that quoted string of options to pass to Java
will look like: <code>"-Xmx4g"</code> which basically says “give me 4 Gb of memory.”</p>
<p>We have 8 jobs to run (one for each of our samples). We first make a simple
tab-separated file called <code>numbered-samples.tsv</code> that we can read with our
<code>line-assign.sh</code> script. Here is some Unix fun to make such a file from
our <code>units.tsv</code> file:</p>
<div class="sourceCode" id="cb758"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb758-1"><a href="example-wgs-flow.html#cb758-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cut</span> <span class="at">-f</span> 1 units.tsv <span class="kw">|</span> <span class="fu">uniq</span> <span class="kw">|</span> <span class="dt">\</span></span>
<span id="cb758-2"><a href="example-wgs-flow.html#cb758-2" aria-hidden="true" tabindex="-1"></a><span class="ex">awk</span> <span class="st">&#39;</span></span>
<span id="cb758-3"><a href="example-wgs-flow.html#cb758-3" aria-hidden="true" tabindex="-1"></a><span class="st">    NR==1 {printf(&quot;index\tsample\n&quot;); next} </span></span>
<span id="cb758-4"><a href="example-wgs-flow.html#cb758-4" aria-hidden="true" tabindex="-1"></a><span class="st">    {printf(&quot;%d\t%s\n&quot;, ++n, $1);}</span></span>
<span id="cb758-5"><a href="example-wgs-flow.html#cb758-5" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;</span> <span class="op">&gt;</span> numbered-samples.tsv</span></code></pre></div>
<p>Then we need to have a script that we can pass to <code>sbatch</code>. The following
should be copied into <code>scripts/gvcf-array-job.sh</code>.</p>
<div class="sourceCode" id="cb759"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb759-1"><a href="example-wgs-flow.html#cb759-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb759-2"><a href="example-wgs-flow.html#cb759-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb759-3"><a href="example-wgs-flow.html#cb759-3" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --array=1-8</span></span>
<span id="cb759-4"><a href="example-wgs-flow.html#cb759-4" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --time=02:00:00</span></span>
<span id="cb759-5"><a href="example-wgs-flow.html#cb759-5" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --output=results/slurm_logs/gvcf/make-gvcf-output-%A-%a</span></span>
<span id="cb759-6"><a href="example-wgs-flow.html#cb759-6" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --error=results/slurm_logs/gvcf/make-gvcf-error-%A-%a </span></span>
<span id="cb759-7"><a href="example-wgs-flow.html#cb759-7" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mail-type=FAIL</span></span>
<span id="cb759-8"><a href="example-wgs-flow.html#cb759-8" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mail-user=yourname@yourmail.edu</span></span>
<span id="cb759-9"><a href="example-wgs-flow.html#cb759-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb759-10"><a href="example-wgs-flow.html#cb759-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb759-11"><a href="example-wgs-flow.html#cb759-11" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> ~/.bashrc</span>
<span id="cb759-12"><a href="example-wgs-flow.html#cb759-12" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate gatk4.2.5.0</span>
<span id="cb759-13"><a href="example-wgs-flow.html#cb759-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb759-14"><a href="example-wgs-flow.html#cb759-14" aria-hidden="true" tabindex="-1"></a><span class="co"># this sets the shell variable &quot;sample&quot; to s001, s002, etc.</span></span>
<span id="cb759-15"><a href="example-wgs-flow.html#cb759-15" aria-hidden="true" tabindex="-1"></a><span class="bu">eval</span> <span class="va">$(</span><span class="ex">line_assign.sh</span> <span class="va">$SLURM_ARRAY_TASK_ID</span> numbered-samples.tsv<span class="va">)</span> </span>
<span id="cb759-16"><a href="example-wgs-flow.html#cb759-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb759-17"><a href="example-wgs-flow.html#cb759-17" aria-hidden="true" tabindex="-1"></a><span class="va">outdir=</span>results/gvcf                      <span class="co"># a directory in which to put the output gVFC file</span></span>
<span id="cb759-18"><a href="example-wgs-flow.html#cb759-18" aria-hidden="true" tabindex="-1"></a><span class="va">logdir=</span>results/logs/haplotype-caller     <span class="co"># a directory in which to put the output from stderr</span></span>
<span id="cb759-19"><a href="example-wgs-flow.html#cb759-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb759-20"><a href="example-wgs-flow.html#cb759-20" aria-hidden="true" tabindex="-1"></a><span class="co"># make sure those directories exist</span></span>
<span id="cb759-21"><a href="example-wgs-flow.html#cb759-21" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> <span class="va">$outdir</span>  </span>
<span id="cb759-22"><a href="example-wgs-flow.html#cb759-22" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> <span class="va">$logdir</span>  </span>
<span id="cb759-23"><a href="example-wgs-flow.html#cb759-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb759-24"><a href="example-wgs-flow.html#cb759-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb759-25"><a href="example-wgs-flow.html#cb759-25" aria-hidden="true" tabindex="-1"></a><span class="ex">gatk</span> <span class="at">--java-options</span> <span class="st">&quot;-Xmx4g&quot;</span> HaplotypeCaller <span class="dt">\</span></span>
<span id="cb759-26"><a href="example-wgs-flow.html#cb759-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">-R</span> resources/genome.fasta <span class="dt">\</span></span>
<span id="cb759-27"><a href="example-wgs-flow.html#cb759-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">-I</span> results/mkdup-merged/<span class="va">$sample</span>.bam <span class="dt">\</span></span>
<span id="cb759-28"><a href="example-wgs-flow.html#cb759-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">-O</span> <span class="va">$outdir</span>/<span class="va">$sample</span>.g.vcf.gz <span class="dt">\</span></span>
<span id="cb759-29"><a href="example-wgs-flow.html#cb759-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">--native-pair-hmm-threads</span> 1 <span class="dt">\</span></span>
<span id="cb759-30"><a href="example-wgs-flow.html#cb759-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">-ERC</span> GVCF <span class="op">&gt;</span> <span class="va">$logdir</span>/<span class="va">$sample</span>.stdout  <span class="dv">2</span><span class="op">&gt;</span> <span class="va">$logdir</span>/<span class="va">$sample</span>.stderr</span>
<span id="cb759-31"><a href="example-wgs-flow.html#cb759-31" aria-hidden="true" tabindex="-1"></a>  </span></code></pre></div>
</div>
<div id="running-interactively-to-watch-the-output" class="section level3" number="27.8.3">
<h3><span class="header-section-number">27.8.3</span> Running interactively to watch the output</h3>
<p>If you haven’t run any GATK tools before, it is worth doing a short run
to watch the progress meter log go by (this is what gets written
to <em>stderr</em> when you run GATK tools).</p>
<p>So, <em>get an interactive shell</em>, then spoof the SLURM_ARRAY_TASK_ID (i.e.
just make a variable named <code>SLURM_ARRAY_TASK_ID</code> and set it to 1), and
run one iteration as follows:</p>
<div class="sourceCode" id="cb760"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb760-1"><a href="example-wgs-flow.html#cb760-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb760-2"><a href="example-wgs-flow.html#cb760-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb760-3"><a href="example-wgs-flow.html#cb760-3" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate gatk4.2.5.0</span>
<span id="cb760-4"><a href="example-wgs-flow.html#cb760-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb760-5"><a href="example-wgs-flow.html#cb760-5" aria-hidden="true" tabindex="-1"></a><span class="va">SLURM_ARRAY_TASK_ID=</span>1</span>
<span id="cb760-6"><a href="example-wgs-flow.html#cb760-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb760-7"><a href="example-wgs-flow.html#cb760-7" aria-hidden="true" tabindex="-1"></a><span class="co"># this sets the shell variable &quot;sample&quot; to s001, s002, etc.</span></span>
<span id="cb760-8"><a href="example-wgs-flow.html#cb760-8" aria-hidden="true" tabindex="-1"></a><span class="bu">eval</span> <span class="va">$(</span><span class="ex">line_assign.sh</span> <span class="va">$SLURM_ARRAY_TASK_ID</span> numbered-samples.tsv<span class="va">)</span> </span>
<span id="cb760-9"><a href="example-wgs-flow.html#cb760-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb760-10"><a href="example-wgs-flow.html#cb760-10" aria-hidden="true" tabindex="-1"></a><span class="va">outdir=</span>results/gvcf                      <span class="co"># a directory in which to put the output gVFC file</span></span>
<span id="cb760-11"><a href="example-wgs-flow.html#cb760-11" aria-hidden="true" tabindex="-1"></a><span class="va">logdir=</span>results/logs/haplotype-caller     <span class="co"># a directory in which to put the output from stderr</span></span>
<span id="cb760-12"><a href="example-wgs-flow.html#cb760-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb760-13"><a href="example-wgs-flow.html#cb760-13" aria-hidden="true" tabindex="-1"></a><span class="co"># make sure those directories exist</span></span>
<span id="cb760-14"><a href="example-wgs-flow.html#cb760-14" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> <span class="va">$outdir</span>  </span>
<span id="cb760-15"><a href="example-wgs-flow.html#cb760-15" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> <span class="va">$logdir</span>  </span>
<span id="cb760-16"><a href="example-wgs-flow.html#cb760-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb760-17"><a href="example-wgs-flow.html#cb760-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb760-18"><a href="example-wgs-flow.html#cb760-18" aria-hidden="true" tabindex="-1"></a><span class="ex">gatk</span> <span class="at">--java-options</span> <span class="st">&quot;-Xmx4g&quot;</span> HaplotypeCaller <span class="dt">\</span></span>
<span id="cb760-19"><a href="example-wgs-flow.html#cb760-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">-R</span> resources/genome.fasta <span class="dt">\</span></span>
<span id="cb760-20"><a href="example-wgs-flow.html#cb760-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">-I</span> results/mkdup-merged/<span class="va">$sample</span>.bam <span class="dt">\</span></span>
<span id="cb760-21"><a href="example-wgs-flow.html#cb760-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">-O</span> <span class="va">$outdir</span>/<span class="va">$sample</span>.g.vcf.gz <span class="dt">\</span></span>
<span id="cb760-22"><a href="example-wgs-flow.html#cb760-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">--native-pair-hmm-threads</span> 1 <span class="dt">\</span></span>
<span id="cb760-23"><a href="example-wgs-flow.html#cb760-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">-ERC</span> GVCF </span></code></pre></div>
<p>Note that we are not redirecting stdout or stderr to any files, so it
just come to our screen.</p>
<p>The “ProgressMeter” that comes flying out of GATK tools can be quite helpful for
estimating how long a particular run on a particular data set might require.</p>
<p>When you have seen enough, kill that job with <code>cntrl-c</code> and then we will launch
our jobs for real.</p>
</div>
<div id="launch-the-first-3-jobs-of-our-array" class="section level3" number="27.8.4">
<h3><span class="header-section-number">27.8.4</span> Launch the first 3 jobs of our array</h3>
<p>As always, it is wise to launch just the first few jobs of an array
to make sure things are set up correctly.</p>
<p>Before we start this, we <em>must</em> create the directories that we are
redirecting the SLURM logs to:</p>
<div class="sourceCode" id="cb761"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb761-1"><a href="example-wgs-flow.html#cb761-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> results/slurm_logs/gvcf</span></code></pre></div>
<p>Then, start the first three:</p>
<div class="sourceCode" id="cb762"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb762-1"><a href="example-wgs-flow.html#cb762-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> <span class="at">--array</span><span class="op">=</span>1-3 scripts/gvcf-array-job.sh</span></code></pre></div>
<p>Once you are convinced that those are doing just fine, you can start up the
remaining 5:</p>
<div class="sourceCode" id="cb763"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb763-1"><a href="example-wgs-flow.html#cb763-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> <span class="at">--array</span><span class="op">=</span>4-8 scripts/gvcf-array-job.sh</span></code></pre></div>
<p>While those are running would be a good time to go back and review
what a gVCF file is all about (Section <a href="variant-calling.html#gvcf-format">20.2.2</a>).</p>
</div>
</div>
<div id="use-genomicsdbimport" class="section level2" number="27.9">
<h2><span class="header-section-number">27.9</span> Step 5. Importing the gVCF files into a GenomicsDatabase</h2>
<p>Section <a href="variant-calling.html#genomics-db">20.2.3</a> provides some background on the genomics data base
used by GATK, and it also outlined all of the options to the GATK program
<code>GenomicsDBImport</code>. Here we will launch a series of jobs in a SLURM
array, each one requesting 2 CPUs (so we can use 2 reader threads, effectively)
to import all of our gVCF files made in the last step into a genomics
data base.</p>
This step corresponds to the colored nodes in our now-familiar workflow DAG:
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:gdb-import-dag"></span>
<img src="figs/snakemake-dags/genomics-db-import.svg" alt="Importing gVCF files into the genomics data bases." width="100%" />
<p class="caption">
FIGURE 27.7: Importing gVCF files into the genomics data bases.
</p>
</div>
<p>As mentioned in Section <a href="variant-calling.html#genomics-db">20.2.3</a>, these jobs parallelize over
chromosomes; however, for non-model organisms with more fragmented reference
genomes, for the unplaced scaffolds we will be parallelizing over the
<em>scaffold groups</em>. These are just groups of short scaffolds that have been
lumped together so that they can be merged together and treated by
<code>GenomicsDBImport</code> as a single “pseudo-chromosome.”</p>
<p>The length of all the chromosomes and the unplaced scaffolds
in the reference genome are easily found in the <code>.fai</code> file created
by <code>samtools faidx</code>. We have one of those in <code>resources/genome.fasta.fai</code>.
It is fairly straightforward to operate on this file with R to
create a file of chromsomes and a file of scaffold groups. In fact,
a simple R script that does that can be viewed <a href="https://github.com/eriqande/mega-non-model-wgs-snakeflow/blob/main/workflow/prepare/make_chromosomes_and_scaffolds.R">here</a>.
Rather than go through that process, we are just going to download the resulting
files <code>chromosomes.tsv</code> and <code>scaffold_groups.tsv</code>, in order to use them. To
download these to our example workflow directory, you can give these two simple
commands (from that example workflow directory!):</p>
<div class="sourceCode" id="cb764"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb764-1"><a href="example-wgs-flow.html#cb764-1" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> https://raw.githubusercontent.com/eriqande/mega-non-model-wgs-snakeflow/main/.test/config/chromosomes.tsv</span>
<span id="cb764-2"><a href="example-wgs-flow.html#cb764-2" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> https://raw.githubusercontent.com/eriqande/mega-non-model-wgs-snakeflow/main/.test/config/scaffold_groups.tsv</span></code></pre></div>
<p>Look at those files to see how they are structured.</p>
<p>The documentation for GenomicsDBImport can be gotten using <code>gatk GenomicsDBImport --help</code>, or
it can be found <a href="https://gatk.broadinstitute.org/hc/en-us/articles/360057439331-GenomicsDBImport">on the web</a>.</p>
<div id="job-array-script-for-the-chromosomes" class="section level3" number="27.9.1">
<h3><span class="header-section-number">27.9.1</span> Job array script for the chromosomes</h3>
<p>First, we need to turn <code>chromosomes.tsv</code> into something that we can use with <code>line_assign.sh</code>.
So let’s do that:</p>
<div class="sourceCode" id="cb765"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb765-1"><a href="example-wgs-flow.html#cb765-1" aria-hidden="true" tabindex="-1"></a><span class="fu">awk</span> <span class="st">&#39;NR == 1 {printf(&quot;index\tchrom\n&quot;); next} {printf(&quot;%d\t%s\n&quot;, ++n, $1);}&#39;</span> chromosomes.tsv  <span class="op">&gt;</span> numbered-chromosomes.tsv</span></code></pre></div>
<p>That gives us <code>numbered-chromosomes.tsv</code>, that looks like this:</p>
<pre><code>index   chrom
1   CM031199.1
2   CM031200.1
3   CM031201.1
4   CM031202.1</code></pre>
<p>First we prepare a job array script for the chromosomes that uses <code>numbered-chromosomes.tsv</code>.
We can just copy the one for making gVCFs, and then modify it as appropriate. After reading
and understanding the following chunk of code, use a text editor like <code>nano</code> to paste it into
the file <code>scripts/genomics-db-array.sh</code>.</p>
<div class="sourceCode" id="cb767"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb767-1"><a href="example-wgs-flow.html#cb767-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb767-2"><a href="example-wgs-flow.html#cb767-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb767-3"><a href="example-wgs-flow.html#cb767-3" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --array=1-4</span></span>
<span id="cb767-4"><a href="example-wgs-flow.html#cb767-4" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --time=02:00:00</span></span>
<span id="cb767-5"><a href="example-wgs-flow.html#cb767-5" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task=2</span></span>
<span id="cb767-6"><a href="example-wgs-flow.html#cb767-6" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --output=results/slurm_logs/gdb_import/output-%A-%a</span></span>
<span id="cb767-7"><a href="example-wgs-flow.html#cb767-7" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --error=results/slurm_logs/gdb_import/error-%A-%a </span></span>
<span id="cb767-8"><a href="example-wgs-flow.html#cb767-8" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mail-type=FAIL</span></span>
<span id="cb767-9"><a href="example-wgs-flow.html#cb767-9" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mail-user=yourname@yourmail.edu</span></span>
<span id="cb767-10"><a href="example-wgs-flow.html#cb767-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb767-11"><a href="example-wgs-flow.html#cb767-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb767-12"><a href="example-wgs-flow.html#cb767-12" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> ~/.bashrc</span>
<span id="cb767-13"><a href="example-wgs-flow.html#cb767-13" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate gatk4.2.5.0</span>
<span id="cb767-14"><a href="example-wgs-flow.html#cb767-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb767-15"><a href="example-wgs-flow.html#cb767-15" aria-hidden="true" tabindex="-1"></a><span class="co"># this sets the shell variable &quot;chrom&quot; to the chromosome names etc.</span></span>
<span id="cb767-16"><a href="example-wgs-flow.html#cb767-16" aria-hidden="true" tabindex="-1"></a><span class="bu">eval</span> <span class="va">$(</span><span class="ex">line_assign.sh</span> <span class="va">$SLURM_ARRAY_TASK_ID</span> numbered-chromosomes.tsv<span class="va">)</span> </span>
<span id="cb767-17"><a href="example-wgs-flow.html#cb767-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb767-18"><a href="example-wgs-flow.html#cb767-18" aria-hidden="true" tabindex="-1"></a><span class="va">outdir=</span>results/genomics_db/<span class="va">$chrom</span>                      <span class="co"># a directory in which the genomics DB will go</span></span>
<span id="cb767-19"><a href="example-wgs-flow.html#cb767-19" aria-hidden="true" tabindex="-1"></a><span class="va">logdir=</span>results/logs/genomics_db_import                   <span class="co"># a directory in which to put the output from stderr and stdout</span></span>
<span id="cb767-20"><a href="example-wgs-flow.html#cb767-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb767-21"><a href="example-wgs-flow.html#cb767-21" aria-hidden="true" tabindex="-1"></a><span class="co"># make sure those directories exist</span></span>
<span id="cb767-22"><a href="example-wgs-flow.html#cb767-22" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> <span class="va">$(</span><span class="fu">dirname</span> <span class="va">$outdir)</span>  <span class="co"># make the directory for this output directory to go into</span></span>
<span id="cb767-23"><a href="example-wgs-flow.html#cb767-23" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> <span class="va">$logdir</span>  </span>
<span id="cb767-24"><a href="example-wgs-flow.html#cb767-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb767-25"><a href="example-wgs-flow.html#cb767-25" aria-hidden="true" tabindex="-1"></a><span class="co"># here are the standard options that you will typically use</span></span>
<span id="cb767-26"><a href="example-wgs-flow.html#cb767-26" aria-hidden="true" tabindex="-1"></a><span class="va">standard_opts=</span><span class="st">&quot; --batch-size 50 --reader-threads 2 --genomicsdb-shared-posixfs-optimizations &quot;</span></span>
<span id="cb767-27"><a href="example-wgs-flow.html#cb767-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb767-28"><a href="example-wgs-flow.html#cb767-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb767-29"><a href="example-wgs-flow.html#cb767-29" aria-hidden="true" tabindex="-1"></a><span class="ex">gatk</span> <span class="at">--java-options</span> <span class="st">&quot;-Xmx4g&quot;</span> GenomicsDBImport <span class="dt">\</span></span>
<span id="cb767-30"><a href="example-wgs-flow.html#cb767-30" aria-hidden="true" tabindex="-1"></a>      <span class="va">$standard_opts</span> <span class="dt">\</span></span>
<span id="cb767-31"><a href="example-wgs-flow.html#cb767-31" aria-hidden="true" tabindex="-1"></a>      <span class="va">$(</span><span class="fu">awk</span> <span class="st">&#39;NR&gt;1 {printf(&quot; -V results/gvcf/%s.g.vcf.gz &quot;, $2);}&#39;</span> numbered-samples.tsv<span class="va">)</span> <span class="dt">\</span></span>
<span id="cb767-32"><a href="example-wgs-flow.html#cb767-32" aria-hidden="true" tabindex="-1"></a>      <span class="at">--intervals</span> <span class="va">$chrom</span> <span class="dt">\</span></span>
<span id="cb767-33"><a href="example-wgs-flow.html#cb767-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">--genomicsdb-workspace-path</span> <span class="va">$outdir</span> <span class="op">&gt;</span> <span class="va">$logdir</span>/stdout_<span class="va">$chrom</span>.txt  <span class="dv">2</span><span class="op">&gt;</span> <span class="va">$logdir</span>/stderr_<span class="va">$chrom</span>.txt</span>
<span id="cb767-34"><a href="example-wgs-flow.html#cb767-34" aria-hidden="true" tabindex="-1"></a>      </span></code></pre></div>
<p>Note that call to awk. That puts all the samples on the
command line with a -V before each one.</p>
<p>Now! Before we launch that, we must create the directories for the
slurm_logs. Otherwise, SLURM will kill the jobs immediately upon
submitting them without any sort of reasonable error message indicating
why it failed.</p>
<div class="sourceCode" id="cb768"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb768-1"><a href="example-wgs-flow.html#cb768-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> results/slurm_logs/gdb_import</span>
<span id="cb768-2"><a href="example-wgs-flow.html#cb768-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb768-3"><a href="example-wgs-flow.html#cb768-3" aria-hidden="true" tabindex="-1"></a><span class="co"># normally we would test a few, but since there are only</span></span>
<span id="cb768-4"><a href="example-wgs-flow.html#cb768-4" aria-hidden="true" tabindex="-1"></a><span class="co"># four jobs in this array, let&#39;s launch them all...</span></span>
<span id="cb768-5"><a href="example-wgs-flow.html#cb768-5" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span>  scripts/genomics-db-array.sh</span></code></pre></div>
<p>At this juncture, it is worth mentioning that the output of GenomicsDBImport goes
into a directory (named <code>$outdir</code> in the above script). If that directory already
exists, and you call GenomicsDBImport with the <code>--genomicsdb-workspace-path</code> option,
then you will get an error. The tool is careful not to overwrite an
existing data base. So, if you tried a run that failed after creating the output
directory, you will need to remove that before you try to relaunch the job.</p>
</div>
<div id="job-array-script-for-the-scaffold-groups" class="section level3" number="27.9.2">
<h3><span class="header-section-number">27.9.2</span> Job array script for the scaffold groups</h3>
<p>Recall that GenomicsDBImport can use the <code>--merge-contigs-into-num-partitions 1</code> “trick” to
put many short scaffolds into a single genomics data base. We still have to do that.
Making a script for that involves two steps that were different than what we did with the
chromosomes, above:</p>
<ol style="list-style-type: decimal">
<li>We need to specify all the scaffolds in each scaffold group</li>
<li>We need to use the <code>--merge-contigs-into-num-partitions 1</code> option</li>
</ol>
<p>Note that we have a <em>lot</em> of scaffolds in some scaffold groups, so that if we
tried to specify them all on the command line, we would end up with a very long
command line. Although Unix, today, is reasonably tolerant of long and convoluted
command lines, some flavors of Unix will hiccup or barf on very long command lines.
Accordingly, we will use a GATK feature that lets us specify genomic regions in a file—so
long as it is named with the extension <code>.list</code>—rather than on the command line for this job.</p>
<p>First, we need to make a file <code>numbered-scaff-groups.tsv</code> that will translate
a <code>SLURM_ARRAY_TASK_ID</code> into the name of a scaffold group. We can do that with a little
Unix and awk:</p>
<div class="sourceCode" id="cb769"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb769-1"><a href="example-wgs-flow.html#cb769-1" aria-hidden="true" tabindex="-1"></a><span class="fu">awk</span> <span class="st">&#39;NR&gt;1 {print $1}&#39;</span> scaffold_groups.tsv <span class="kw">|</span> <span class="fu">uniq</span> <span class="kw">|</span> <span class="fu">awk</span> <span class="st">&#39;BEGIN {printf(&quot;index\tsg\n&quot;)} {printf(&quot;%d\t%s\n&quot;, ++n, $1)}&#39;</span> <span class="op">&gt;</span> numbered-scaff-groups.tsv</span></code></pre></div>
<p>If you look at the file created there, you will see that it looks like this:</p>
<pre><code>index   sg
1   scaff_group_001
2   scaff_group_002</code></pre>
<p>so, we can use it to turn the <code>SLURM_ARRAY_TASK_ID</code> into a shell variable
<code>sg</code> that holds the name of the scaffold group we are dealing with.</p>
<p>The following code block contains a shell script that you should
paste into a new file called <code>scripts/genomics-db-scaffold-array.sh</code>:</p>
<div class="sourceCode" id="cb771"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb771-1"><a href="example-wgs-flow.html#cb771-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb771-2"><a href="example-wgs-flow.html#cb771-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb771-3"><a href="example-wgs-flow.html#cb771-3" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --array=1-2</span></span>
<span id="cb771-4"><a href="example-wgs-flow.html#cb771-4" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --time=02:00:00</span></span>
<span id="cb771-5"><a href="example-wgs-flow.html#cb771-5" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task=2</span></span>
<span id="cb771-6"><a href="example-wgs-flow.html#cb771-6" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --output=results/slurm_logs/gdb_import_scaff_groups/output-%A-%a</span></span>
<span id="cb771-7"><a href="example-wgs-flow.html#cb771-7" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --error=results/slurm_logs/gdb_import_scaff_groups/error-%A-%a </span></span>
<span id="cb771-8"><a href="example-wgs-flow.html#cb771-8" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mail-type=FAIL</span></span>
<span id="cb771-9"><a href="example-wgs-flow.html#cb771-9" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mail-user=yourname@yourmail.edu</span></span>
<span id="cb771-10"><a href="example-wgs-flow.html#cb771-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb771-11"><a href="example-wgs-flow.html#cb771-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb771-12"><a href="example-wgs-flow.html#cb771-12" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> ~/.bashrc</span>
<span id="cb771-13"><a href="example-wgs-flow.html#cb771-13" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate gatk4.2.5.0</span>
<span id="cb771-14"><a href="example-wgs-flow.html#cb771-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb771-15"><a href="example-wgs-flow.html#cb771-15" aria-hidden="true" tabindex="-1"></a><span class="co"># this sets the shell variable &quot;sg&quot; to the scaffold group name</span></span>
<span id="cb771-16"><a href="example-wgs-flow.html#cb771-16" aria-hidden="true" tabindex="-1"></a><span class="bu">eval</span> <span class="va">$(</span><span class="ex">line_assign.sh</span> <span class="va">$SLURM_ARRAY_TASK_ID</span> numbered-scaff-groups.tsv<span class="va">)</span> </span>
<span id="cb771-17"><a href="example-wgs-flow.html#cb771-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb771-18"><a href="example-wgs-flow.html#cb771-18" aria-hidden="true" tabindex="-1"></a><span class="va">outdir=</span>results/genomics_db/<span class="va">$sg</span>                <span class="co"># a directory in which the genomics DB will go</span></span>
<span id="cb771-19"><a href="example-wgs-flow.html#cb771-19" aria-hidden="true" tabindex="-1"></a><span class="va">logdir=</span>results/logs/genomics_db_import        <span class="co"># a directory in which to put the output from stderr and stdout</span></span>
<span id="cb771-20"><a href="example-wgs-flow.html#cb771-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb771-21"><a href="example-wgs-flow.html#cb771-21" aria-hidden="true" tabindex="-1"></a><span class="co"># make sure those directories exist</span></span>
<span id="cb771-22"><a href="example-wgs-flow.html#cb771-22" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> <span class="va">$(</span><span class="fu">dirname</span> <span class="va">$outdir)</span>  <span class="co"># make the directory for this output directory to go into</span></span>
<span id="cb771-23"><a href="example-wgs-flow.html#cb771-23" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> <span class="va">$logdir</span>  </span>
<span id="cb771-24"><a href="example-wgs-flow.html#cb771-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb771-25"><a href="example-wgs-flow.html#cb771-25" aria-hidden="true" tabindex="-1"></a><span class="co"># here are the standard options that you will typically use</span></span>
<span id="cb771-26"><a href="example-wgs-flow.html#cb771-26" aria-hidden="true" tabindex="-1"></a><span class="va">standard_opts=</span><span class="st">&quot; --batch-size 50 --reader-threads 2 --genomicsdb-shared-posixfs-optimizations &quot;</span></span>
<span id="cb771-27"><a href="example-wgs-flow.html#cb771-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb771-28"><a href="example-wgs-flow.html#cb771-28" aria-hidden="true" tabindex="-1"></a><span class="co"># now, some new stuff for the scaffold group lists.  We are going to make a file</span></span>
<span id="cb771-29"><a href="example-wgs-flow.html#cb771-29" aria-hidden="true" tabindex="-1"></a><span class="co"># called results/sg_lists/$sg.list that contains the names of all the scaffolds in this</span></span>
<span id="cb771-30"><a href="example-wgs-flow.html#cb771-30" aria-hidden="true" tabindex="-1"></a><span class="co"># scaffold group $sg.</span></span>
<span id="cb771-31"><a href="example-wgs-flow.html#cb771-31" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> results/sg_lists <span class="co"># make sure that this directory exists</span></span>
<span id="cb771-32"><a href="example-wgs-flow.html#cb771-32" aria-hidden="true" tabindex="-1"></a><span class="va">sglist=</span>results/sg_lists/<span class="va">$sg</span>.list  <span class="co"># file name for the scaffold names</span></span>
<span id="cb771-33"><a href="example-wgs-flow.html#cb771-33" aria-hidden="true" tabindex="-1"></a><span class="fu">awk</span> <span class="at">-v</span> sg=<span class="va">$sg</span> <span class="st">&#39;NR &gt;1 &amp;&amp; $1==sg {print $2}&#39;</span> scaffold_groups.tsv <span class="op">&gt;</span> <span class="va">$sglist</span> </span>
<span id="cb771-34"><a href="example-wgs-flow.html#cb771-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb771-35"><a href="example-wgs-flow.html#cb771-35" aria-hidden="true" tabindex="-1"></a><span class="co"># now, we call this with the name of the file having </span></span>
<span id="cb771-36"><a href="example-wgs-flow.html#cb771-36" aria-hidden="true" tabindex="-1"></a><span class="ex">gatk</span> <span class="at">--java-options</span> <span class="st">&quot;-Xmx4g&quot;</span> GenomicsDBImport <span class="dt">\</span></span>
<span id="cb771-37"><a href="example-wgs-flow.html#cb771-37" aria-hidden="true" tabindex="-1"></a>      <span class="va">$standard_opts</span> <span class="dt">\</span></span>
<span id="cb771-38"><a href="example-wgs-flow.html#cb771-38" aria-hidden="true" tabindex="-1"></a>      <span class="va">$(</span><span class="fu">awk</span> <span class="st">&#39;NR&gt;1 {printf(&quot; -V results/gvcf/%s.g.vcf.gz &quot;, $2);}&#39;</span> numbered-samples.tsv<span class="va">)</span> <span class="dt">\</span></span>
<span id="cb771-39"><a href="example-wgs-flow.html#cb771-39" aria-hidden="true" tabindex="-1"></a>      <span class="at">--intervals</span> <span class="va">$sglist</span> <span class="dt">\</span></span>
<span id="cb771-40"><a href="example-wgs-flow.html#cb771-40" aria-hidden="true" tabindex="-1"></a>      <span class="at">--merge-contigs-into-num-partitions</span> 1 <span class="dt">\</span></span>
<span id="cb771-41"><a href="example-wgs-flow.html#cb771-41" aria-hidden="true" tabindex="-1"></a>      <span class="at">--genomicsdb-workspace-path</span> <span class="va">$outdir</span> <span class="op">&gt;</span> <span class="va">$logdir</span>/stdout_<span class="va">$sg</span>.txt  <span class="dv">2</span><span class="op">&gt;</span> <span class="va">$logdir</span>/stderr_<span class="va">$sg</span>.txt</span>
<span id="cb771-42"><a href="example-wgs-flow.html#cb771-42" aria-hidden="true" tabindex="-1"></a>      </span></code></pre></div>
<p>Then, since there are only two scaffold groups, we can run that as an array from 1 to 2.
Of course, as always, be sure to create the slurm log output directories <em>before</em>
you launch the job:</p>
<div class="sourceCode" id="cb772"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb772-1"><a href="example-wgs-flow.html#cb772-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> results/slurm_logs/gdb_import_scaff_groups</span>
<span id="cb772-2"><a href="example-wgs-flow.html#cb772-2" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> <span class="at">--array</span><span class="op">=</span>1-2 scripts/genomics-db-scaffold-array.sh</span></code></pre></div>
</div>
<div id="hey-lets-try-updating-the-genomic-data-base" class="section level3" number="27.9.3">
<h3><span class="header-section-number">27.9.3</span> Hey! Let’s try updating the genomic data base</h3>
<p>Recall from Section <a href="variant-calling.html#gdb-update">20.2.4</a>, that it is possible to add new
individuals to a genomics data base. It is worth giving that a whirl.
What we shall do here is create the data base with the first six samples, and then
update it by adding the last two sample to the existing data bases.</p>
<p>Before we do this, we might note that it is a bit of a hassle that
we are starting to see such a proliferation of different “array” scripts
in this section. We already have one script for chromosomes and one script
for scaffold groups. Geez! If we now also have to make a separate script for
updating chromosome and scaffold group data bases, that is going to be four
separate scripts. Not only that, but the names of the files of numbered chromsomes and
numbered scaffold groups that they use are hard-wired into the scripts, and if
we are going to be doing some building of data bases and then, later, updating them, we
might want to be able to tell the script which <code>numbered-XX</code> file to use.</p>
<p>So, here we will write a single, general script that can deal with these different
use cases by taking options and positional parameters. It will make the script a little
longer, but it will be nice to have it all in one place. This is a general theme
in computer programming: if you can reduce the number of places (i.e., files or scripts) the same block of code
appears (by using variables and options) then it is typically a lot easier to maintain the
code base.</p>
<p>So, here is our big general script. You should paste this into:
<code>scripts/general-genomics-db-array.sh</code></p>
<div class="sourceCode" id="cb773"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb773-1"><a href="example-wgs-flow.html#cb773-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb773-2"><a href="example-wgs-flow.html#cb773-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb773-3"><a href="example-wgs-flow.html#cb773-3" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --array=1-2</span></span>
<span id="cb773-4"><a href="example-wgs-flow.html#cb773-4" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --time=02:00:00</span></span>
<span id="cb773-5"><a href="example-wgs-flow.html#cb773-5" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task=2</span></span>
<span id="cb773-6"><a href="example-wgs-flow.html#cb773-6" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --output=results/slurm_logs/gdb_import_general/output-%A-%a</span></span>
<span id="cb773-7"><a href="example-wgs-flow.html#cb773-7" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --error=results/slurm_logs/gdb_import_general/error-%A-%a</span></span>
<span id="cb773-8"><a href="example-wgs-flow.html#cb773-8" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mail-type=FAIL</span></span>
<span id="cb773-9"><a href="example-wgs-flow.html#cb773-9" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mail-user=yourname@yourmail.edu</span></span>
<span id="cb773-10"><a href="example-wgs-flow.html#cb773-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb773-11"><a href="example-wgs-flow.html#cb773-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb773-12"><a href="example-wgs-flow.html#cb773-12" aria-hidden="true" tabindex="-1"></a><span class="co">### Define default values for variables here.  By default we are going to</span></span>
<span id="cb773-13"><a href="example-wgs-flow.html#cb773-13" aria-hidden="true" tabindex="-1"></a><span class="co">### Be doing &quot;by chromosome&quot;, but the options we give can update these</span></span>
<span id="cb773-14"><a href="example-wgs-flow.html#cb773-14" aria-hidden="true" tabindex="-1"></a><span class="va">OUTPARENT=</span>results/genomics_db</span>
<span id="cb773-15"><a href="example-wgs-flow.html#cb773-15" aria-hidden="true" tabindex="-1"></a><span class="va">DOING_SCAFF=</span>0 <span class="co"># default is to do chromosomes</span></span>
<span id="cb773-16"><a href="example-wgs-flow.html#cb773-16" aria-hidden="true" tabindex="-1"></a><span class="va">UPDATING=</span>0    <span class="co"># default is to create a new data base</span></span>
<span id="cb773-17"><a href="example-wgs-flow.html#cb773-17" aria-hidden="true" tabindex="-1"></a><span class="va">EXTRA=</span><span class="st">&quot; &quot;</span></span>
<span id="cb773-18"><a href="example-wgs-flow.html#cb773-18" aria-hidden="true" tabindex="-1"></a><span class="va">logdir=</span>results/logs/genomics_db_import        <span class="co"># a directory in which to put the output from stderr and stdout</span></span>
<span id="cb773-19"><a href="example-wgs-flow.html#cb773-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb773-20"><a href="example-wgs-flow.html#cb773-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb773-21"><a href="example-wgs-flow.html#cb773-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb773-22"><a href="example-wgs-flow.html#cb773-22" aria-hidden="true" tabindex="-1"></a><span class="co">### Here is a lot of stuff for usage &quot;help&quot; messages and options processing</span></span>
<span id="cb773-23"><a href="example-wgs-flow.html#cb773-23" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span><span class="fu"> usage</span> <span class="kw">{</span></span>
<span id="cb773-24"><a href="example-wgs-flow.html#cb773-24" aria-hidden="true" tabindex="-1"></a>      <span class="bu">echo</span> Syntax:</span>
<span id="cb773-25"><a href="example-wgs-flow.html#cb773-25" aria-hidden="true" tabindex="-1"></a>      <span class="bu">echo</span> <span class="st">&quot;  </span><span class="va">$(</span><span class="fu">basename</span> <span class="va">$0)</span><span class="st"> [-h -u -s ScaffGroupFile -o OutputDirectory -l LogDirectory] NumberedSeqsFile NumberedSamplesFile &quot;</span></span>
<span id="cb773-26"><a href="example-wgs-flow.html#cb773-26" aria-hidden="true" tabindex="-1"></a>      <span class="bu">echo</span></span>
<span id="cb773-27"><a href="example-wgs-flow.html#cb773-27" aria-hidden="true" tabindex="-1"></a>      <span class="bu">echo</span> <span class="st">&quot;    -h:  print help and exit.&quot;</span></span>
<span id="cb773-28"><a href="example-wgs-flow.html#cb773-28" aria-hidden="true" tabindex="-1"></a>      <span class="bu">echo</span> <span class="st">&quot;    -l:  put the resulting logs (from stderr and stdout) in directory LogDirectory.&quot;</span></span>
<span id="cb773-29"><a href="example-wgs-flow.html#cb773-29" aria-hidden="true" tabindex="-1"></a>      <span class="bu">echo</span> <span class="st">&quot;         Default is results/logs/genomics_db_import&quot;</span></span>
<span id="cb773-30"><a href="example-wgs-flow.html#cb773-30" aria-hidden="true" tabindex="-1"></a>      <span class="bu">echo</span> <span class="st">&quot;    -o:  put the genomicsDB within OutputDirectory (and make that dir if needed).&quot;</span></span>
<span id="cb773-31"><a href="example-wgs-flow.html#cb773-31" aria-hidden="true" tabindex="-1"></a>      <span class="bu">echo</span> <span class="st">&quot;         Default is results/genomics_db&quot;</span></span>
<span id="cb773-32"><a href="example-wgs-flow.html#cb773-32" aria-hidden="true" tabindex="-1"></a>      <span class="bu">echo</span> <span class="st">&quot;    -s:  process scaffold groups given in ScaffGroupFile.&quot;</span></span>
<span id="cb773-33"><a href="example-wgs-flow.html#cb773-33" aria-hidden="true" tabindex="-1"></a>      <span class="bu">echo</span> <span class="st">&quot;    -u:  update the genomics data base instead of creating it.&quot;</span></span>
<span id="cb773-34"><a href="example-wgs-flow.html#cb773-34" aria-hidden="true" tabindex="-1"></a>      <span class="bu">echo</span></span>
<span id="cb773-35"><a href="example-wgs-flow.html#cb773-35" aria-hidden="true" tabindex="-1"></a>      <span class="bu">echo</span> <span class="st">&quot;   ScaffGroupFile is like scaffold_groups.tsv&quot;</span></span>
<span id="cb773-36"><a href="example-wgs-flow.html#cb773-36" aria-hidden="true" tabindex="-1"></a>      <span class="bu">echo</span> <span class="st">&quot;   NumberedSeqsFile is either like numbered-chromosomes.tsv or numbered-scaff-groups.tsv&quot;</span></span>
<span id="cb773-37"><a href="example-wgs-flow.html#cb773-37" aria-hidden="true" tabindex="-1"></a>      <span class="bu">echo</span> <span class="st">&quot;   NumberedSamplesFile is like numbered-samples.tsv&quot;</span></span>
<span id="cb773-38"><a href="example-wgs-flow.html#cb773-38" aria-hidden="true" tabindex="-1"></a>      <span class="bu">echo</span></span>
<span id="cb773-39"><a href="example-wgs-flow.html#cb773-39" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb773-40"><a href="example-wgs-flow.html#cb773-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb773-41"><a href="example-wgs-flow.html#cb773-41" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="va">$#</span> <span class="ot">-eq</span> 0 <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb773-42"><a href="example-wgs-flow.html#cb773-42" aria-hidden="true" tabindex="-1"></a>    <span class="ex">usage</span><span class="kw">;</span></span>
<span id="cb773-43"><a href="example-wgs-flow.html#cb773-43" aria-hidden="true" tabindex="-1"></a>    <span class="bu">exit</span> 1<span class="kw">;</span></span>
<span id="cb773-44"><a href="example-wgs-flow.html#cb773-44" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span><span class="kw">;</span></span>
<span id="cb773-45"><a href="example-wgs-flow.html#cb773-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb773-46"><a href="example-wgs-flow.html#cb773-46" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="bu">getopts</span> <span class="st">&quot;hl:o:s:u&quot;</span> opt<span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb773-47"><a href="example-wgs-flow.html#cb773-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="va">$opt</span> <span class="kw">in</span></span>
<span id="cb773-48"><a href="example-wgs-flow.html#cb773-48" aria-hidden="true" tabindex="-1"></a>    h    <span class="kw">)</span></span>
<span id="cb773-49"><a href="example-wgs-flow.html#cb773-49" aria-hidden="true" tabindex="-1"></a>        <span class="ex">usage</span></span>
<span id="cb773-50"><a href="example-wgs-flow.html#cb773-50" aria-hidden="true" tabindex="-1"></a>        exit 1</span>
<span id="cb773-51"><a href="example-wgs-flow.html#cb773-51" aria-hidden="true" tabindex="-1"></a>        ;;</span>
<span id="cb773-52"><a href="example-wgs-flow.html#cb773-52" aria-hidden="true" tabindex="-1"></a>    l    <span class="kw">)</span></span>
<span id="cb773-53"><a href="example-wgs-flow.html#cb773-53" aria-hidden="true" tabindex="-1"></a>        <span class="va">logdir=$OPTARG</span><span class="kw">;</span></span>
<span id="cb773-54"><a href="example-wgs-flow.html#cb773-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">;;</span></span>
<span id="cb773-55"><a href="example-wgs-flow.html#cb773-55" aria-hidden="true" tabindex="-1"></a>    o    <span class="kw">)</span></span>
<span id="cb773-56"><a href="example-wgs-flow.html#cb773-56" aria-hidden="true" tabindex="-1"></a>        <span class="va">OUTPARENT=$OPTARG</span><span class="kw">;</span></span>
<span id="cb773-57"><a href="example-wgs-flow.html#cb773-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">;;</span></span>
<span id="cb773-58"><a href="example-wgs-flow.html#cb773-58" aria-hidden="true" tabindex="-1"></a>    s    <span class="kw">)</span></span>
<span id="cb773-59"><a href="example-wgs-flow.html#cb773-59" aria-hidden="true" tabindex="-1"></a>        <span class="va">SCAFF_GROUP_FILE=$OPTARG</span><span class="kw">;</span></span>
<span id="cb773-60"><a href="example-wgs-flow.html#cb773-60" aria-hidden="true" tabindex="-1"></a>        <span class="va">DOING_SCAFF=</span>1</span>
<span id="cb773-61"><a href="example-wgs-flow.html#cb773-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">;;</span></span>
<span id="cb773-62"><a href="example-wgs-flow.html#cb773-62" aria-hidden="true" tabindex="-1"></a>    u    <span class="kw">)</span></span>
<span id="cb773-63"><a href="example-wgs-flow.html#cb773-63" aria-hidden="true" tabindex="-1"></a>        <span class="va">UPDATING=</span>1<span class="kw">;</span></span>
<span id="cb773-64"><a href="example-wgs-flow.html#cb773-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">;;</span></span>
<span id="cb773-65"><a href="example-wgs-flow.html#cb773-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb773-66"><a href="example-wgs-flow.html#cb773-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">esac</span></span>
<span id="cb773-67"><a href="example-wgs-flow.html#cb773-67" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span>
<span id="cb773-68"><a href="example-wgs-flow.html#cb773-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb773-69"><a href="example-wgs-flow.html#cb773-69" aria-hidden="true" tabindex="-1"></a><span class="bu">shift</span> <span class="va">$((OPTIND</span><span class="op">-</span><span class="dv">1</span><span class="va">))</span><span class="kw">;</span></span>
<span id="cb773-70"><a href="example-wgs-flow.html#cb773-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb773-71"><a href="example-wgs-flow.html#cb773-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb773-72"><a href="example-wgs-flow.html#cb773-72" aria-hidden="true" tabindex="-1"></a><span class="co"># uncomment to test for right number of required args</span></span>
<span id="cb773-73"><a href="example-wgs-flow.html#cb773-73" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="va">$#</span> <span class="ot">-ne</span> 2 <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb773-74"><a href="example-wgs-flow.html#cb773-74" aria-hidden="true" tabindex="-1"></a>    <span class="ex">usage</span><span class="kw">;</span></span>
<span id="cb773-75"><a href="example-wgs-flow.html#cb773-75" aria-hidden="true" tabindex="-1"></a>    <span class="bu">exit</span> 1<span class="kw">;</span></span>
<span id="cb773-76"><a href="example-wgs-flow.html#cb773-76" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb773-77"><a href="example-wgs-flow.html#cb773-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb773-78"><a href="example-wgs-flow.html#cb773-78" aria-hidden="true" tabindex="-1"></a><span class="va">NUMBERED_FILE=$1</span></span>
<span id="cb773-79"><a href="example-wgs-flow.html#cb773-79" aria-hidden="true" tabindex="-1"></a><span class="va">NUMBERED_SAMPLES_FILE=$2</span></span>
<span id="cb773-80"><a href="example-wgs-flow.html#cb773-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb773-81"><a href="example-wgs-flow.html#cb773-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb773-82"><a href="example-wgs-flow.html#cb773-82" aria-hidden="true" tabindex="-1"></a><span class="co">#### Done processing options and getting down to work</span></span>
<span id="cb773-83"><a href="example-wgs-flow.html#cb773-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb773-84"><a href="example-wgs-flow.html#cb773-84" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> ~/.bashrc</span>
<span id="cb773-85"><a href="example-wgs-flow.html#cb773-85" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate gatk4.2.5.0</span>
<span id="cb773-86"><a href="example-wgs-flow.html#cb773-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb773-87"><a href="example-wgs-flow.html#cb773-87" aria-hidden="true" tabindex="-1"></a><span class="co"># make sure the directories exist</span></span>
<span id="cb773-88"><a href="example-wgs-flow.html#cb773-88" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> <span class="va">$OUTPARENT</span>  <span class="co"># make the directory for this output directory to go into</span></span>
<span id="cb773-89"><a href="example-wgs-flow.html#cb773-89" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> <span class="va">$logdir</span></span>
<span id="cb773-90"><a href="example-wgs-flow.html#cb773-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb773-91"><a href="example-wgs-flow.html#cb773-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb773-92"><a href="example-wgs-flow.html#cb773-92" aria-hidden="true" tabindex="-1"></a><span class="co"># this sets the shell variable &quot;sg&quot; to the scaffold group name</span></span>
<span id="cb773-93"><a href="example-wgs-flow.html#cb773-93" aria-hidden="true" tabindex="-1"></a><span class="co"># or the variable &quot;chrom&quot; to the chromosome name</span></span>
<span id="cb773-94"><a href="example-wgs-flow.html#cb773-94" aria-hidden="true" tabindex="-1"></a><span class="bu">eval</span> <span class="va">$(</span><span class="ex">line_assign.sh</span> <span class="va">$SLURM_ARRAY_TASK_ID</span> <span class="va">$NUMBERED_FILE)</span></span>
<span id="cb773-95"><a href="example-wgs-flow.html#cb773-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb773-96"><a href="example-wgs-flow.html#cb773-96" aria-hidden="true" tabindex="-1"></a><span class="co">### Now we process things differently if we are doing scaff_groups or chromosomes</span></span>
<span id="cb773-97"><a href="example-wgs-flow.html#cb773-97" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="va">$DOING_SCAFF</span> <span class="ot">=</span> 0 <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb773-98"><a href="example-wgs-flow.html#cb773-98" aria-hidden="true" tabindex="-1"></a>    <span class="va">outdir=$OUTPARENT</span>/<span class="va">$chrom</span></span>
<span id="cb773-99"><a href="example-wgs-flow.html#cb773-99" aria-hidden="true" tabindex="-1"></a>    <span class="va">INTERVALS=</span><span class="st">&quot; --intervals </span><span class="va">$chrom</span><span class="st"> &quot;</span></span>
<span id="cb773-100"><a href="example-wgs-flow.html#cb773-100" aria-hidden="true" tabindex="-1"></a>    <span class="va">STDOUT=$logdir</span>/stdout_<span class="va">$chrom</span>.txt</span>
<span id="cb773-101"><a href="example-wgs-flow.html#cb773-101" aria-hidden="true" tabindex="-1"></a>    <span class="va">STDERR=$logdir</span>/stderr_<span class="va">$chrom</span>.txt</span>
<span id="cb773-102"><a href="example-wgs-flow.html#cb773-102" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb773-103"><a href="example-wgs-flow.html#cb773-103" aria-hidden="true" tabindex="-1"></a>    <span class="va">outdir=$OUTPARENT</span>/<span class="va">$sg</span></span>
<span id="cb773-104"><a href="example-wgs-flow.html#cb773-104" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mkdir</span> <span class="at">-p</span> results/sg_lists <span class="co"># make sure that this directory exists</span></span>
<span id="cb773-105"><a href="example-wgs-flow.html#cb773-105" aria-hidden="true" tabindex="-1"></a>    <span class="va">sglist=</span>results/sg_lists/<span class="va">$sg</span>.list  <span class="co"># file name for the scaffold names</span></span>
<span id="cb773-106"><a href="example-wgs-flow.html#cb773-106" aria-hidden="true" tabindex="-1"></a>    <span class="fu">awk</span> <span class="at">-v</span> sg=<span class="va">$sg</span> <span class="st">&#39;NR &gt;1 &amp;&amp; $1==sg {print $2}&#39;</span> <span class="va">$SCAFF_GROUP_FILE</span> <span class="op">&gt;</span> <span class="va">$sglist</span></span>
<span id="cb773-107"><a href="example-wgs-flow.html#cb773-107" aria-hidden="true" tabindex="-1"></a>    <span class="va">INTERVALS=</span><span class="st">&quot; --intervals </span><span class="va">$sglist</span><span class="st"> &quot;</span></span>
<span id="cb773-108"><a href="example-wgs-flow.html#cb773-108" aria-hidden="true" tabindex="-1"></a>    <span class="va">EXTRA=</span><span class="st">&quot; --merge-contigs-into-num-partitions 1 &quot;</span></span>
<span id="cb773-109"><a href="example-wgs-flow.html#cb773-109" aria-hidden="true" tabindex="-1"></a>    <span class="va">STDOUT=$logdir</span>/stdout_<span class="va">$sg</span>.txt</span>
<span id="cb773-110"><a href="example-wgs-flow.html#cb773-110" aria-hidden="true" tabindex="-1"></a>    <span class="va">STDERR=$logdir</span>/stderr_<span class="va">$sg</span>.txt</span>
<span id="cb773-111"><a href="example-wgs-flow.html#cb773-111" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb773-112"><a href="example-wgs-flow.html#cb773-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb773-113"><a href="example-wgs-flow.html#cb773-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb773-114"><a href="example-wgs-flow.html#cb773-114" aria-hidden="true" tabindex="-1"></a><span class="co">### Now, change options if updating vs creating a data base</span></span>
<span id="cb773-115"><a href="example-wgs-flow.html#cb773-115" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="va">$UPDATING</span> <span class="ot">=</span> 0 <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb773-116"><a href="example-wgs-flow.html#cb773-116" aria-hidden="true" tabindex="-1"></a>    <span class="va">DB_OPT=</span><span class="st">&quot; --genomicsdb-workspace-path &quot;</span></span>
<span id="cb773-117"><a href="example-wgs-flow.html#cb773-117" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb773-118"><a href="example-wgs-flow.html#cb773-118" aria-hidden="true" tabindex="-1"></a>    <span class="va">DB_OPT=</span><span class="st">&quot; --genomicsdb-update-workspace-path &quot;</span></span>
<span id="cb773-119"><a href="example-wgs-flow.html#cb773-119" aria-hidden="true" tabindex="-1"></a>    <span class="va">INTERVALS=</span><span class="st">&quot;&quot;</span></span>
<span id="cb773-120"><a href="example-wgs-flow.html#cb773-120" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb773-121"><a href="example-wgs-flow.html#cb773-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb773-122"><a href="example-wgs-flow.html#cb773-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb773-123"><a href="example-wgs-flow.html#cb773-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb773-124"><a href="example-wgs-flow.html#cb773-124" aria-hidden="true" tabindex="-1"></a><span class="co"># here are the standard options that you will typically use</span></span>
<span id="cb773-125"><a href="example-wgs-flow.html#cb773-125" aria-hidden="true" tabindex="-1"></a><span class="va">standard_opts=</span><span class="st">&quot; --batch-size 50 --reader-threads 2 --genomicsdb-shared-posixfs-optimizations &quot;</span></span>
<span id="cb773-126"><a href="example-wgs-flow.html#cb773-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb773-127"><a href="example-wgs-flow.html#cb773-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb773-128"><a href="example-wgs-flow.html#cb773-128" aria-hidden="true" tabindex="-1"></a><span class="co"># here is where we make the call</span></span>
<span id="cb773-129"><a href="example-wgs-flow.html#cb773-129" aria-hidden="true" tabindex="-1"></a><span class="co"># now, we call this with the name of the file having</span></span>
<span id="cb773-130"><a href="example-wgs-flow.html#cb773-130" aria-hidden="true" tabindex="-1"></a><span class="ex">gatk</span> <span class="at">--java-options</span> <span class="st">&quot;-Xmx4g&quot;</span> GenomicsDBImport <span class="dt">\</span></span>
<span id="cb773-131"><a href="example-wgs-flow.html#cb773-131" aria-hidden="true" tabindex="-1"></a>  <span class="va">$standard_opts</span> <span class="dt">\</span></span>
<span id="cb773-132"><a href="example-wgs-flow.html#cb773-132" aria-hidden="true" tabindex="-1"></a>  <span class="va">$(</span><span class="fu">awk</span> <span class="st">&#39;NR&gt;1 {printf(&quot; -V results/gvcf/%s.g.vcf.gz &quot;, $2);}&#39;</span> <span class="va">$NUMBERED_SAMPLES_FILE)</span> <span class="va">$INTERVALS</span> <span class="va">$EXTRA</span> <span class="dt">\</span></span>
<span id="cb773-133"><a href="example-wgs-flow.html#cb773-133" aria-hidden="true" tabindex="-1"></a>  <span class="va">$DB_OPT</span> <span class="va">$outdir</span> <span class="op">&gt;</span> <span class="va">$STDOUT</span>  <span class="dv">2</span><span class="op">&gt;</span> <span class="va">$STDERR</span></span></code></pre></div>
<p>Once we have that script, we are going to use it to create genomics data bases from
the the first six samples for chromosomes and scaffold groups, and then we
are going to update each of those data bases by adding the next two individuals
into the data bases.</p>
<p>We start by making some numbered-samples type of files.</p>
<div class="sourceCode" id="cb774"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb774-1"><a href="example-wgs-flow.html#cb774-1" aria-hidden="true" tabindex="-1"></a><span class="fu">awk</span> <span class="st">&#39;BEGIN {OFS=&quot;\t&quot;} NR==1 {print; next} $1 &lt;= 6 {print}&#39;</span> numbered-samples.tsv <span class="op">&gt;</span> numbered-first-six-samples.tsv</span>
<span id="cb774-2"><a href="example-wgs-flow.html#cb774-2" aria-hidden="true" tabindex="-1"></a><span class="fu">awk</span> <span class="st">&#39;BEGIN {OFS=&quot;\t&quot;} NR==1 {print; next} $1 &gt; 6 {printf(&quot;%d\t%s\n&quot;, ++n, $2);}&#39;</span> numbered-samples.tsv <span class="op">&gt;</span> numbered-last-two-samples.tsv</span></code></pre></div>
<p>Then we start our jobs to create the data bases for the four chromosomes and for the two scaffold groups
with the first six samples. We will put these into the directory <code>results/stepwise_genomics_db</code></p>
<div class="sourceCode" id="cb775"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb775-1"><a href="example-wgs-flow.html#cb775-1" aria-hidden="true" tabindex="-1"></a><span class="co"># make sure the slurm logs directory exists!!</span></span>
<span id="cb775-2"><a href="example-wgs-flow.html#cb775-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> results/slurm_logs/gdb_import_general</span>
<span id="cb775-3"><a href="example-wgs-flow.html#cb775-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb775-4"><a href="example-wgs-flow.html#cb775-4" aria-hidden="true" tabindex="-1"></a><span class="co"># create 4 chromosome databases with the first six samples</span></span>
<span id="cb775-5"><a href="example-wgs-flow.html#cb775-5" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> <span class="at">--array</span><span class="op">=</span>1-4 scripts/general-genomics-db-array.sh  <span class="dt">\</span></span>
<span id="cb775-6"><a href="example-wgs-flow.html#cb775-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">-l</span> results/logs/stepwise_gdb_import/first-six  <span class="dt">\</span></span>
<span id="cb775-7"><a href="example-wgs-flow.html#cb775-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">-o</span> results/stepwise_genomics_db <span class="dt">\</span></span>
<span id="cb775-8"><a href="example-wgs-flow.html#cb775-8" aria-hidden="true" tabindex="-1"></a>  numbered-chromosomes.tsv <span class="dt">\</span></span>
<span id="cb775-9"><a href="example-wgs-flow.html#cb775-9" aria-hidden="true" tabindex="-1"></a>  numbered-first-six-samples.tsv</span>
<span id="cb775-10"><a href="example-wgs-flow.html#cb775-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb775-11"><a href="example-wgs-flow.html#cb775-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb775-12"><a href="example-wgs-flow.html#cb775-12" aria-hidden="true" tabindex="-1"></a><span class="co"># create 2 scaffold-group databases with the first six samples</span></span>
<span id="cb775-13"><a href="example-wgs-flow.html#cb775-13" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> <span class="at">--array</span><span class="op">=</span>1-2 scripts/general-genomics-db-array.sh  <span class="dt">\</span></span>
<span id="cb775-14"><a href="example-wgs-flow.html#cb775-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">-l</span> results/logs/stepwise_gdb_import/first-six  <span class="dt">\</span></span>
<span id="cb775-15"><a href="example-wgs-flow.html#cb775-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">-o</span> results/stepwise_genomics_db <span class="dt">\</span></span>
<span id="cb775-16"><a href="example-wgs-flow.html#cb775-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">-s</span> scaffold_groups.tsv <span class="dt">\</span></span>
<span id="cb775-17"><a href="example-wgs-flow.html#cb775-17" aria-hidden="true" tabindex="-1"></a>  numbered-scaff-groups.tsv <span class="dt">\</span></span>
<span id="cb775-18"><a href="example-wgs-flow.html#cb775-18" aria-hidden="true" tabindex="-1"></a>  numbered-first-six-samples.tsv</span></code></pre></div>
<p>We have to wait until each of those runs has completed. Once they do, check that
all the genomics data bases have been created, by, for example:</p>
<div class="sourceCode" id="cb776"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb776-1"><a href="example-wgs-flow.html#cb776-1" aria-hidden="true" tabindex="-1"></a><span class="co"># making sure that all the log files are there:</span></span>
<span id="cb776-2"><a href="example-wgs-flow.html#cb776-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span>  results/logs/stepwise_gdb_import/first-six/</span>
<span id="cb776-3"><a href="example-wgs-flow.html#cb776-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb776-4"><a href="example-wgs-flow.html#cb776-4" aria-hidden="true" tabindex="-1"></a><span class="co"># looking at the last ten lines of each of the log files</span></span>
<span id="cb776-5"><a href="example-wgs-flow.html#cb776-5" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span> results/logs/stepwise_gdb_import/first-six/stderr<span class="pp">*</span></span>
<span id="cb776-6"><a href="example-wgs-flow.html#cb776-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb776-7"><a href="example-wgs-flow.html#cb776-7" aria-hidden="true" tabindex="-1"></a><span class="co"># listing the directories of the data bases:</span></span>
<span id="cb776-8"><a href="example-wgs-flow.html#cb776-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> results/stepwise_genomics_db</span>
<span id="cb776-9"><a href="example-wgs-flow.html#cb776-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb776-10"><a href="example-wgs-flow.html#cb776-10" aria-hidden="true" tabindex="-1"></a><span class="co"># listing all the contents of those data bases</span></span>
<span id="cb776-11"><a href="example-wgs-flow.html#cb776-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-R</span> results/stepwise_genomics_db</span></code></pre></div>
<p>If that all looks good, then it is time to update each of those data bases
by adding the last two individuals to them. To do so, we give our
script the <code>-u</code> option, give it the path to the existing data base directory
with the <code>-o</code> option. And we also change the log file directory (with the <code>-l</code>
option) so that the new logs go to a new place.</p>
<div class="sourceCode" id="cb777"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb777-1"><a href="example-wgs-flow.html#cb777-1" aria-hidden="true" tabindex="-1"></a><span class="co"># update 4 chromosome databases by adding the last two samples to them</span></span>
<span id="cb777-2"><a href="example-wgs-flow.html#cb777-2" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> <span class="at">--array</span><span class="op">=</span>1-4 scripts/general-genomics-db-array.sh <span class="dt">\</span></span>
<span id="cb777-3"><a href="example-wgs-flow.html#cb777-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">-l</span> results/logs/stepwise_gdb_import/last-two <span class="dt">\</span></span>
<span id="cb777-4"><a href="example-wgs-flow.html#cb777-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">-o</span> results/stepwise_genomics_db <span class="dt">\</span></span>
<span id="cb777-5"><a href="example-wgs-flow.html#cb777-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">-u</span> <span class="dt">\</span></span>
<span id="cb777-6"><a href="example-wgs-flow.html#cb777-6" aria-hidden="true" tabindex="-1"></a>  numbered-chromosomes.tsv numbered-last-two-samples.tsv</span>
<span id="cb777-7"><a href="example-wgs-flow.html#cb777-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb777-8"><a href="example-wgs-flow.html#cb777-8" aria-hidden="true" tabindex="-1"></a><span class="co"># update 2 scaffold-group databases by adding the last two samples to them</span></span>
<span id="cb777-9"><a href="example-wgs-flow.html#cb777-9" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> <span class="at">--array</span><span class="op">=</span>1-2 scripts/general-genomics-db-array.sh <span class="dt">\</span></span>
<span id="cb777-10"><a href="example-wgs-flow.html#cb777-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">-l</span> results/logs/stepwise_gdb_import/last-two <span class="dt">\</span></span>
<span id="cb777-11"><a href="example-wgs-flow.html#cb777-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">-o</span> results/stepwise_genomics_db <span class="dt">\</span></span>
<span id="cb777-12"><a href="example-wgs-flow.html#cb777-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">-s</span> scaffold_groups.tsv <span class="dt">\</span></span>
<span id="cb777-13"><a href="example-wgs-flow.html#cb777-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">-u</span> <span class="dt">\</span></span>
<span id="cb777-14"><a href="example-wgs-flow.html#cb777-14" aria-hidden="true" tabindex="-1"></a>  numbered-scaff-groups.tsv numbered-last-two-samples.tsv</span></code></pre></div>
<p>When those are done, you can check the log files to make sure that they
look like they ran all right:</p>
<div class="sourceCode" id="cb778"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb778-1"><a href="example-wgs-flow.html#cb778-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span> results/logs/stepwise_gdb_import/last-two/stderr_<span class="pp">*</span></span></code></pre></div>
<p>If they say something like:</p>
<pre><code>08:31:11.156 INFO  GenomicsDBImport - Importing batch 1 with 2 samples
08:31:19.147 INFO  GenomicsDBImport - Done importing batch 1/1
08:31:19.155 INFO  GenomicsDBImport - Import of all batches to GenomicsDB completed!
08:31:19.157 INFO  GenomicsDBImport - Shutting down engine
[April 7, 2022 at 8:31:19 AM MDT] org.broadinstitute.hellbender.tools.genomicsdb.GenomicsDBImport done. Elapsed time: 0.15 minutes.
Runtime.totalMemory()=385875968</code></pre>
<p>then it has all worked according to plan!</p>
</div>
</div>
<div id="step-6.-calling-variants-and-creating-vcf-files-from-the-genomicsdatabase" class="section level2" number="27.10">
<h2><span class="header-section-number">27.10</span> Step 6. Calling variants and creating VCF files from the GenomicsDatabase</h2>
<p>The final step to getting a VCF file with variants for all your samples
is to run GenotypeGVCFs. This GATK tool can take a variety of things as input,
but, for our purposes, the most useful is that it can take a genomics data base
as input.</p>
<p>Recall that we now have six genomics data bases: one for each of the four
chromosomes in our reference genome file, and two for each of the scaffold groups. Each
of these scaffold groups includes a large number of unplaced scaffolds that exist
in our reference genome.</p>
<p>Each of those data bases knows exactly which chromosomes or scaffolds are included in it—and
also it has information about all the samples. In other words, it has all the information it
needs to make a VCF file for the chromosome or scaffold group that it encompasses.
Accordingly, it is pretty easy to run the GenotypeGVCFs tool on a genomics data base.</p>
This step corresponds to the colored node in our now-familiar workflow DAG:
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:gdb2vcf-dag"></span>
<img src="figs/snakemake-dags/genomics-db2vcf.svg" alt="Joint genotyping: making a VCF file from a genomics database/" width="100%" />
<p class="caption">
FIGURE 27.8: Joint genotyping: making a VCF file from a genomics database/
</p>
</div>
<p>The webpage describing how this tools works can be found <a href="https://gatk.broadinstitute.org/hc/en-us/articles/4418054384027-GenotypeGVCFs">here</a>.</p>
<p>The basic command, for the chromosome <code>CM031202.1</code> (the shortest one!) in our example workflow looks like:</p>
<div class="sourceCode" id="cb780"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb780-1"><a href="example-wgs-flow.html#cb780-1" aria-hidden="true" tabindex="-1"></a><span class="ex">gatk</span> <span class="at">--java-options</span> <span class="st">&quot;-Xmx4g&quot;</span> GenotypeGVCFs <span class="dt">\</span></span>
<span id="cb780-2"><a href="example-wgs-flow.html#cb780-2" aria-hidden="true" tabindex="-1"></a>   <span class="at">-R</span> resources/genome.fasta <span class="dt">\</span></span>
<span id="cb780-3"><a href="example-wgs-flow.html#cb780-3" aria-hidden="true" tabindex="-1"></a>   <span class="at">-V</span> gendb://results/genomics_db/CM031202.1 <span class="dt">\</span></span>
<span id="cb780-4"><a href="example-wgs-flow.html#cb780-4" aria-hidden="true" tabindex="-1"></a>   <span class="at">-O</span> results/vcf_parts/CM031202.1.vcf</span></code></pre></div>
<p>There are some other options, but none that we will explore today. The main
thing to note in the command line is that the path to the genomics data base
is preceded by <code>gendb://</code> which is the way you would specify the location of a
data base as a URL.</p>
<p>Run the above command on a compute shell to see what happens. It is set up
to use the genomics data bases that we created in <code>results/genomics_db</code>.</p>
<p>So, all we need to do now is make some simple array scripts. We could
make a general purpose one that can be used with both the scaffold groups
or the chromosomes, or just write two separate scripts. We will do the latter
here.</p>
<div id="array-script-for-the-four-chromosomes" class="section level3" number="27.10.1">
<h3><span class="header-section-number">27.10.1</span> Array script for the four chromosomes</h3>
<p>The contents of our first script is below and should be copied into
<code>scripts/gdb2vcf-chromo-array.sh</code>:</p>
<div class="sourceCode" id="cb781"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb781-1"><a href="example-wgs-flow.html#cb781-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb781-2"><a href="example-wgs-flow.html#cb781-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb781-3"><a href="example-wgs-flow.html#cb781-3" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --array=1-4</span></span>
<span id="cb781-4"><a href="example-wgs-flow.html#cb781-4" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --time=01:00:00</span></span>
<span id="cb781-5"><a href="example-wgs-flow.html#cb781-5" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --output=results/slurm_logs/gdb2vcf/output-%A-%a</span></span>
<span id="cb781-6"><a href="example-wgs-flow.html#cb781-6" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --error=results/slurm_logs/gdb2vcf/error-%A-%a </span></span>
<span id="cb781-7"><a href="example-wgs-flow.html#cb781-7" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mail-type=FAIL</span></span>
<span id="cb781-8"><a href="example-wgs-flow.html#cb781-8" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mail-user=yourname@yourmail.edu</span></span>
<span id="cb781-9"><a href="example-wgs-flow.html#cb781-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb781-10"><a href="example-wgs-flow.html#cb781-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb781-11"><a href="example-wgs-flow.html#cb781-11" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> ~/.bashrc</span>
<span id="cb781-12"><a href="example-wgs-flow.html#cb781-12" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate gatk4.2.5.0</span>
<span id="cb781-13"><a href="example-wgs-flow.html#cb781-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb781-14"><a href="example-wgs-flow.html#cb781-14" aria-hidden="true" tabindex="-1"></a><span class="co"># this sets the shell variable &quot;chrom&quot; to the chromosome name</span></span>
<span id="cb781-15"><a href="example-wgs-flow.html#cb781-15" aria-hidden="true" tabindex="-1"></a><span class="bu">eval</span> <span class="va">$(</span><span class="ex">line_assign.sh</span> <span class="va">$SLURM_ARRAY_TASK_ID</span> numbered-chromosomes.tsv<span class="va">)</span> </span>
<span id="cb781-16"><a href="example-wgs-flow.html#cb781-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb781-17"><a href="example-wgs-flow.html#cb781-17" aria-hidden="true" tabindex="-1"></a><span class="va">outdir=</span>results/vcf_parts                      <span class="co"># a directory in which to put the output gVFC file</span></span>
<span id="cb781-18"><a href="example-wgs-flow.html#cb781-18" aria-hidden="true" tabindex="-1"></a><span class="va">logdir=</span>results/logs/genotype-gvcfs     <span class="co"># a directory in which to put the output from stderr</span></span>
<span id="cb781-19"><a href="example-wgs-flow.html#cb781-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb781-20"><a href="example-wgs-flow.html#cb781-20" aria-hidden="true" tabindex="-1"></a><span class="co"># make sure those directories exist</span></span>
<span id="cb781-21"><a href="example-wgs-flow.html#cb781-21" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> <span class="va">$outdir</span>  </span>
<span id="cb781-22"><a href="example-wgs-flow.html#cb781-22" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> <span class="va">$logdir</span>  </span>
<span id="cb781-23"><a href="example-wgs-flow.html#cb781-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb781-24"><a href="example-wgs-flow.html#cb781-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb781-25"><a href="example-wgs-flow.html#cb781-25" aria-hidden="true" tabindex="-1"></a><span class="ex">gatk</span> <span class="at">--java-options</span> <span class="st">&quot;-Xmx4g&quot;</span> GenotypeGVCFs <span class="dt">\</span></span>
<span id="cb781-26"><a href="example-wgs-flow.html#cb781-26" aria-hidden="true" tabindex="-1"></a>   <span class="at">-R</span> resources/genome.fasta <span class="dt">\</span></span>
<span id="cb781-27"><a href="example-wgs-flow.html#cb781-27" aria-hidden="true" tabindex="-1"></a>   <span class="at">-V</span> gendb://results/genomics_db/<span class="va">$chrom</span> <span class="dt">\</span></span>
<span id="cb781-28"><a href="example-wgs-flow.html#cb781-28" aria-hidden="true" tabindex="-1"></a>   <span class="at">-O</span> <span class="va">$outdir</span>/<span class="va">$chrom</span>.vcf.gz <span class="op">&gt;</span> <span class="va">$logdir</span>/stdout.<span class="va">$chrom</span> <span class="dv">2</span><span class="op">&gt;</span> <span class="va">$logdir</span>/stderr.<span class="va">$chrom</span> </span>
<span id="cb781-29"><a href="example-wgs-flow.html#cb781-29" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<p>Note that when you name the output file with a <code>.gz</code> extension, GATK will automatically
gzip the output.</p>
<p>Launch that job array.</p>
<div class="sourceCode" id="cb782"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb782-1"><a href="example-wgs-flow.html#cb782-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create slurm logs directory</span></span>
<span id="cb782-2"><a href="example-wgs-flow.html#cb782-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> results/slurm_logs/gdb2vcf</span>
<span id="cb782-3"><a href="example-wgs-flow.html#cb782-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb782-4"><a href="example-wgs-flow.html#cb782-4" aria-hidden="true" tabindex="-1"></a><span class="co"># try just the first job</span></span>
<span id="cb782-5"><a href="example-wgs-flow.html#cb782-5" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> <span class="at">--array</span><span class="op">=</span>1 scripts/gdb2vcf-chromo-array.sh</span>
<span id="cb782-6"><a href="example-wgs-flow.html#cb782-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb782-7"><a href="example-wgs-flow.html#cb782-7" aria-hidden="true" tabindex="-1"></a><span class="co"># if it looks like that is working (check the stderr log output)</span></span>
<span id="cb782-8"><a href="example-wgs-flow.html#cb782-8" aria-hidden="true" tabindex="-1"></a><span class="co"># then launch the remaining ones</span></span>
<span id="cb782-9"><a href="example-wgs-flow.html#cb782-9" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> <span class="at">--array</span><span class="op">=</span>2-4 scripts/gdb2vcf-chromo-array.sh</span></code></pre></div>
</div>
<div id="array-script-for-the-two-scaffold-groups" class="section level3" number="27.10.2">
<h3><span class="header-section-number">27.10.2</span> Array script for the two scaffold groups</h3>
<p>The contents of our scaffold group script is below and should be copied into
<code>scripts/gdb2vcf-sg-array.sh</code>:</p>
<div class="sourceCode" id="cb783"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb783-1"><a href="example-wgs-flow.html#cb783-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb783-2"><a href="example-wgs-flow.html#cb783-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb783-3"><a href="example-wgs-flow.html#cb783-3" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --array=1-2</span></span>
<span id="cb783-4"><a href="example-wgs-flow.html#cb783-4" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --time=01:00:00</span></span>
<span id="cb783-5"><a href="example-wgs-flow.html#cb783-5" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --output=results/slurm_logs/gdb2vcf/output-%A-%a</span></span>
<span id="cb783-6"><a href="example-wgs-flow.html#cb783-6" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --error=results/slurm_logs/gdb2vcf/error-%A-%a </span></span>
<span id="cb783-7"><a href="example-wgs-flow.html#cb783-7" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mail-type=FAIL</span></span>
<span id="cb783-8"><a href="example-wgs-flow.html#cb783-8" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mail-user=yourname@yourmail.edu</span></span>
<span id="cb783-9"><a href="example-wgs-flow.html#cb783-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb783-10"><a href="example-wgs-flow.html#cb783-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb783-11"><a href="example-wgs-flow.html#cb783-11" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> ~/.bashrc</span>
<span id="cb783-12"><a href="example-wgs-flow.html#cb783-12" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate gatk4.2.5.0</span>
<span id="cb783-13"><a href="example-wgs-flow.html#cb783-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb783-14"><a href="example-wgs-flow.html#cb783-14" aria-hidden="true" tabindex="-1"></a><span class="co"># this sets the shell variable &quot;sg&quot; to the chromosome name</span></span>
<span id="cb783-15"><a href="example-wgs-flow.html#cb783-15" aria-hidden="true" tabindex="-1"></a><span class="bu">eval</span> <span class="va">$(</span><span class="ex">line_assign.sh</span> <span class="va">$SLURM_ARRAY_TASK_ID</span> numbered-scaff-groups.tsv<span class="va">)</span> </span>
<span id="cb783-16"><a href="example-wgs-flow.html#cb783-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb783-17"><a href="example-wgs-flow.html#cb783-17" aria-hidden="true" tabindex="-1"></a><span class="va">outdir=</span>results/vcf_parts                      <span class="co"># a directory in which to put the output gVFC file</span></span>
<span id="cb783-18"><a href="example-wgs-flow.html#cb783-18" aria-hidden="true" tabindex="-1"></a><span class="va">logdir=</span>results/logs/genotype-gvcfs     <span class="co"># a directory in which to put the output from stderr</span></span>
<span id="cb783-19"><a href="example-wgs-flow.html#cb783-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb783-20"><a href="example-wgs-flow.html#cb783-20" aria-hidden="true" tabindex="-1"></a><span class="co"># make sure those directories exist</span></span>
<span id="cb783-21"><a href="example-wgs-flow.html#cb783-21" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> <span class="va">$outdir</span>  </span>
<span id="cb783-22"><a href="example-wgs-flow.html#cb783-22" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> <span class="va">$logdir</span>  </span>
<span id="cb783-23"><a href="example-wgs-flow.html#cb783-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb783-24"><a href="example-wgs-flow.html#cb783-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb783-25"><a href="example-wgs-flow.html#cb783-25" aria-hidden="true" tabindex="-1"></a><span class="ex">gatk</span> <span class="at">--java-options</span> <span class="st">&quot;-Xmx4g&quot;</span> GenotypeGVCFs <span class="dt">\</span></span>
<span id="cb783-26"><a href="example-wgs-flow.html#cb783-26" aria-hidden="true" tabindex="-1"></a>   <span class="at">-R</span> resources/genome.fasta <span class="dt">\</span></span>
<span id="cb783-27"><a href="example-wgs-flow.html#cb783-27" aria-hidden="true" tabindex="-1"></a>   <span class="at">-V</span> gendb://results/genomics_db/<span class="va">$sg</span> <span class="dt">\</span></span>
<span id="cb783-28"><a href="example-wgs-flow.html#cb783-28" aria-hidden="true" tabindex="-1"></a>   <span class="at">-O</span> <span class="va">$outdir</span>/<span class="va">$sg</span>.vcf.gz <span class="op">&gt;</span> <span class="va">$logdir</span>/stdout.<span class="va">$sg</span> <span class="dv">2</span><span class="op">&gt;</span> <span class="va">$logdir</span>/stderr.<span class="va">$sg</span> </span>
<span id="cb783-29"><a href="example-wgs-flow.html#cb783-29" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<p>Launch that job array.</p>
<div class="sourceCode" id="cb784"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb784-1"><a href="example-wgs-flow.html#cb784-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create slurm logs directory (we already did, above, but</span></span>
<span id="cb784-2"><a href="example-wgs-flow.html#cb784-2" aria-hidden="true" tabindex="-1"></a><span class="co"># it is always good to think about this before launching a slurm job)</span></span>
<span id="cb784-3"><a href="example-wgs-flow.html#cb784-3" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> results/slurm_logs/gdb2vcf</span>
<span id="cb784-4"><a href="example-wgs-flow.html#cb784-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb784-5"><a href="example-wgs-flow.html#cb784-5" aria-hidden="true" tabindex="-1"></a><span class="co"># try just the first job</span></span>
<span id="cb784-6"><a href="example-wgs-flow.html#cb784-6" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> <span class="at">--array</span><span class="op">=</span>1 scripts/gdb2vcf-sg-array.sh</span>
<span id="cb784-7"><a href="example-wgs-flow.html#cb784-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb784-8"><a href="example-wgs-flow.html#cb784-8" aria-hidden="true" tabindex="-1"></a><span class="co"># if it looks like that is working (check the stderr log output)</span></span>
<span id="cb784-9"><a href="example-wgs-flow.html#cb784-9" aria-hidden="true" tabindex="-1"></a><span class="co"># then launch the remaining ones</span></span>
<span id="cb784-10"><a href="example-wgs-flow.html#cb784-10" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> <span class="at">--array</span><span class="op">=</span>2 scripts/gdb2vcf-sg-array.sh</span></code></pre></div>
</div>
<div id="have-a-look-at-the-products" class="section level3" number="27.10.3">
<h3><span class="header-section-number">27.10.3</span> Have a look at the products</h3>
<p>You can take a look at the resulting VCF files like this:</p>
<div class="sourceCode" id="cb785"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb785-1"><a href="example-wgs-flow.html#cb785-1" aria-hidden="true" tabindex="-1"></a><span class="fu">zcat</span> results/vcf_parts/CM031199.1.vcf.gz <span class="kw">|</span> <span class="fu">less</span></span></code></pre></div>
<p>Have a look at them and see if it seems everything is in order!</p>
</div>
<div id="homework" class="section level3" number="27.10.4">
<h3><span class="header-section-number">27.10.4</span> Homework</h3>
<p>Modify the two array scripts used above so that they use the genomics
data bases that we put in <code>results/stepwise_genomics_db</code> while testing
the sequential updating of the data bases. Put the output files
into <code>results/stepwise_vcf_parts</code>. See if you get the same variants
out of it (you should!).</p>
</div>
<div id="catenate-all-the-vcf.gz-files-into-a-single-vcf-file-and-index-it" class="section level3" number="27.10.5">
<h3><span class="header-section-number">27.10.5</span> Catenate all the vcf.gz files into a single VCF file and index it</h3>
<p>After running the above steps, we have six different vcf.gz files, four for each
of four chromosomes, and two for each of two scaffold groups. Sometimes it is nice
to keep the VCF files for different chromosomes separate; however because indexing
a VCF file allows for rapid, indexed access to any place in the genome, there isn’t
much reason to keep all the pieces separate unless you are going to be parsing each
file with non-standard tools (i.e., reading each chromosome into R, which, must say, is
really NOT recommended—there are specialized tools for handling VCF files and you
should become comfortable with them).</p>
<p>In order to catenate these 7 <code>vcf.gz</code> files into a single one, and to index it, we
will use <code>bcftools</code>. We will get the latest version of bcftools available on conda at
time time this was written, version 1.15.1, and put it in its own conda
environment named <code>bcftools</code>.</p>
<div class="sourceCode" id="cb786"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb786-1"><a href="example-wgs-flow.html#cb786-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mamba</span> create <span class="at">-n</span> bcftools <span class="at">-c</span> bioconda bcftools=1.15.1</span></code></pre></div>
<p>When that has finished, activate the environment and then type <code>bcftools</code> to
get a list of all the different possible <code>bcftools</code> subcommands:</p>
<div class="sourceCode" id="cb787"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb787-1"><a href="example-wgs-flow.html#cb787-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate bcftools</span>
<span id="cb787-2"><a href="example-wgs-flow.html#cb787-2" aria-hidden="true" tabindex="-1"></a><span class="ex">bcftools</span></span></code></pre></div>
<p>Right now we will be using <code>bcftools concat</code> to catenate the files, and then
we will use <code>bcftools index</code> to index the result. We will put the result
into <code>results/vcf</code>.</p>
<div class="sourceCode" id="cb788"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb788-1"><a href="example-wgs-flow.html#cb788-1" aria-hidden="true" tabindex="-1"></a><span class="co"># first, do this to get the help information for bcftools concat</span></span>
<span id="cb788-2"><a href="example-wgs-flow.html#cb788-2" aria-hidden="true" tabindex="-1"></a><span class="ex">bcftools</span> concat</span></code></pre></div>
<p>Note that if we order our chromosome names and our scaffold groups
alphabetically they are in the correct (genomic) order, so it is
pretty easy to specify the in that order on the command line, like this:</p>
<div class="sourceCode" id="cb789"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb789-1"><a href="example-wgs-flow.html#cb789-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> results/vcf</span>
<span id="cb789-2"><a href="example-wgs-flow.html#cb789-2" aria-hidden="true" tabindex="-1"></a><span class="ex">bcftools</span> concat <span class="at">-O</span> z results/vcf_parts/<span class="pp">*</span>.vcf.gz <span class="op">&gt;</span> results/vcf/all.vcf.gz</span></code></pre></div>
<p>Note the <code>-O z</code> option which makes the program produce <em>compressed</em> VCF format
(hence we gave it the <code>.vcf.gz</code> extension).</p>
<p>There is another type of format common for VCF files, and that is “BCF” format. We
will also make a compressed BCF version (using the <code>-O b</code> option). You should be
comfortable working with either format. BCF is simply a binary format of the same
information. It is not directly human readable, but that is not a problem, since
most of the time you will look at these files using <code>bcftools view</code> (which is to VCF/BCF
files what <code>samtools view</code> is to SAM/BAM files).</p>
<div class="sourceCode" id="cb790"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb790-1"><a href="example-wgs-flow.html#cb790-1" aria-hidden="true" tabindex="-1"></a><span class="ex">bcftools</span> concat <span class="at">-O</span> b results/vcf_parts/<span class="pp">*</span>.vcf.gz <span class="op">&gt;</span> results/vcf/all.bcf</span></code></pre></div>
<p>Now, we are going to use these files to learn all about <code>bcftools</code> in Section <a href="handle-vcf.html#handle-vcf">22</a>.</p>
</div>
</div>
<div id="step-7.-filtering-variants" class="section level2" number="27.11">
<h2><span class="header-section-number">27.11</span> Step 7. Filtering variants</h2>
</div>
<div id="step-8.-base-quality-score-recalibration" class="section level2" number="27.12">
<h2><span class="header-section-number">27.12</span> Step 8. Base Quality Score Recalibration</h2>

</div>
</div>



            </section>

          </div>
        </div>
      </div>
<a href="whole-genome-alignment-strategies.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="bioinformatic-analysis-on-variant-data.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook/js/app.min.js"></script>
<script src="libs/gitbook/js/clipboard.min.js"></script>
<script src="libs/gitbook/js/plugin-search.js"></script>
<script src="libs/gitbook/js/plugin-sharing.js"></script>
<script src="libs/gitbook/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook/js/plugin-bookdown.js"></script>
<script src="libs/gitbook/js/jquery.highlight.js"></script>
<script src="libs/gitbook/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/eriqande/eca-bioinf-handbook/edit/master/3.12-an-example-full-WGS-workflow.Rmd",
"text": "Edit"
},
"history": {
"link": "https://github.com/eriqande/eca-bioinf-handbook/commits/master/3.12-an-example-full-WGS-workflow.Rmd",
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["eca-bioinf-handbook.pdf", "eca-bioinf-handbook.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
